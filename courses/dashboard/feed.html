<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed | AutoNateAI</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Critical styles - must load before body renders -->
  <style>
    /* Hide content until auth is confirmed */
    .dashboard { display: none !important; }
    .dashboard.ready { display: flex !important; }

    /* Loading screen - shown immediately */
    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0a0a0f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .auth-loading.hidden { display: none; }
    .loading-content { text-align: center; color: #e8e8f0; }
    .loading-icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(121, 134, 203, 0.3);
      border-top-color: #7986cb;
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <!-- Theme loader (before CSS to prevent flash) -->
  <script src="../shared/js/theme-loader.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="../shared/css/dashboard.css">
  <link rel="stylesheet" href="../shared/css/feed.css">
  <style>
    /* Full-screen feed cards */
    .content-area { padding: 1rem 0; }
    .feed-filters { padding: 0 1rem; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

  <!-- Cytoscape & Chart.js (defer so they don't block page load) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

  <!-- Loading Screen -->
  <div class="auth-loading" id="auth-loading">
    <div class="loading-content">
      <div class="loading-icon">üì°</div>
      <div class="loading-spinner"></div>
      <p>Loading your feed...</p>
    </div>
  </div>

  <div class="dashboard" id="dashboard-content">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="../index.html" class="sidebar-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <span class="logo-text">AutoNateAI</span>
      </a>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">Main</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="feed.html" class="nav-link active">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Feed</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="library.html" class="nav-link">
                <span class="nav-icon">üîß</span>
                <span class="nav-text">Tools Library</span>
              </a>
            </li>
          </ul>
        </div>


        <div class="nav-section">
          <span class="nav-section-title">Account</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="profile.html" class="nav-link">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Basketball Section (hidden by default) -->
        <div class="nav-section" id="basketball-section" style="display: none;">
          <span class="nav-section-title" style="color: #ef4444;">Basketball</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="basketball-sim.html" class="nav-link">
                <span class="nav-icon">üèÄ</span>
                <span class="nav-text">Play Simulator</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Admin Section (hidden by default) -->
        <div class="nav-section" id="admin-section" style="display: none;">
          <span class="nav-section-title" style="color: #f44336;">Admin</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="../admin/" class="nav-link">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">Admin Dashboard</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="sidebar-user">
        <div class="user-card" id="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-streak">
              <span>üî•</span>
              <span id="user-streak">0</span> day streak
            </div>
          </div>
        </div>
      </div>

      <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </aside>

    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
          <h1 class="page-title">Feed</h1>
        </div>
      </header>

      <!-- Content -->
      <div class="content-area">

        <!-- Category Filter Pills -->
        <div class="feed-filters" id="feed-filters">
          <button class="filter-pill active" data-category="all">All</button>
          <button class="filter-pill" data-category="strategies">Strategies</button>
          <button class="filter-pill" data-category="results">Results</button>
          <button class="filter-pill" data-category="tips">Tips</button>
          <button class="filter-pill" data-category="jobs">Jobs</button>
          <button class="filter-pill" data-category="keywords">Keywords</button>
        </div>

        <!-- Feed Grid -->
        <div class="feed-container" id="feed-container">
          <!-- Feed cards rendered by JS -->
        </div>

        <!-- Pagination -->
        <button class="feed-load-more" id="load-more-btn" style="display:none;">Load More</button>

      </div>
    </main>

  </div>

  <!-- Scripts -->
  <script src="../shared/js/firebase-config.js"></script>
  <script src="../shared/js/auth.js"></script>
  <script src="../shared/js/rbac.js"></script>
  <script src="../shared/js/whop-service.js"></script>

  <script>
    let hasPremiumAccess = false;
    let currentCategory = 'all';
    let lastVisibleDoc = null;
    let noMorePosts = false;
    let feedDb = null;
    const POSTS_PER_PAGE = 10;

    // =========================================================================
    // FIRESTORE QUERIES
    // =========================================================================

    async function loadFeedPosts(category = 'all', lastDoc = null, limit = POSTS_PER_PAGE) {
      const feedRef = feedDb.collection('feedPosts');
      let query;
      if (category === 'all') {
        query = feedRef.where('status', '==', 'published').orderBy('createdAt', 'desc').limit(limit);
      } else if (category === 'carousel') {
        query = feedRef.where('status', '==', 'published').where('contentType', '==', 'carousel').orderBy('createdAt', 'desc').limit(limit);
      } else {
        query = feedRef.where('status', '==', 'published').where('category', '==', category).orderBy('createdAt', 'desc').limit(limit);
      }
      if (lastDoc) {
        query = query.startAfter(lastDoc);
      }
      const snapshot = await query.get();
      return snapshot;
    }

    // =========================================================================
    // LIKE FUNCTIONALITY
    // =========================================================================

    async function toggleLike(postId) {
      const uid = firebase.auth().currentUser.uid;
      const likeRef = feedDb.collection('feedPosts').doc(postId).collection('likes').doc(uid);
      const likeDoc = await likeRef.get();
      if (likeDoc.exists) {
        await likeRef.delete();
        await feedDb.collection('feedPosts').doc(postId).update({ likes: firebase.firestore.FieldValue.increment(-1) });
      } else {
        await likeRef.set({ userId: uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        await feedDb.collection('feedPosts').doc(postId).update({ likes: firebase.firestore.FieldValue.increment(1) });
      }
      // Update UI
      const btn = document.querySelector(`[data-like-btn="${postId}"]`);
      const countEl = document.querySelector(`[data-like-count="${postId}"]`);
      if (btn) btn.classList.toggle('liked');
      if (countEl) {
        const current = parseInt(countEl.textContent) || 0;
        countEl.textContent = btn.classList.contains('liked') ? current + 1 : Math.max(0, current - 1);
      }
    }

    // =========================================================================
    // COMMENT FUNCTIONALITY
    // =========================================================================

    async function loadComments(postId) {
      const snapshot = await feedDb.collection('feedPosts').doc(postId).collection('comments').orderBy('createdAt', 'asc').get();
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function addComment(postId, content) {
      const user = firebase.auth().currentUser;
      await feedDb.collection('feedPosts').doc(postId).collection('comments').add({
        userId: user.uid,
        displayName: user.displayName || 'Anonymous',
        content: content,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await feedDb.collection('feedPosts').doc(postId).update({ commentCount: firebase.firestore.FieldValue.increment(1) });
    }

    function toggleComments(postId) {
      const section = document.querySelector(`[data-comments="${postId}"]`);
      if (!section) return;
      const isOpen = section.classList.toggle('open');
      if (isOpen && !section.dataset.loaded) {
        section.dataset.loaded = 'true';
        refreshComments(postId);
      }
    }

    async function refreshComments(postId) {
      const list = document.querySelector(`[data-comments-list="${postId}"]`);
      if (!list) return;
      const comments = await loadComments(postId);
      list.innerHTML = comments.map(c => `
        <div class="feed-card__comment">
          <div class="feed-card__comment-author">${escapeHtml(c.displayName)}</div>
          <div class="feed-card__comment-text">${escapeHtml(c.content)}</div>
        </div>
      `).join('') || '<div class="feed-card__comment"><div class="feed-card__comment-text">No comments yet.</div></div>';
    }

    async function handleCommentSubmit(postId) {
      const input = document.querySelector(`[data-comment-input="${postId}"]`);
      if (!input) return;
      const content = input.value.trim();
      if (!content) return;
      input.value = '';
      await addComment(postId, content);
      await refreshComments(postId);
      // Update comment count in UI
      const countEl = document.querySelector(`[data-comment-count="${postId}"]`);
      if (countEl) countEl.textContent = parseInt(countEl.textContent || '0') + 1;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // =========================================================================
    // RENDER
    // =========================================================================

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // =========================================================================
    // CAROUSEL RENDERING
    // =========================================================================

    function renderCarouselCard(post) {
      const slides = post.slides || [];
      const authorInitial = post.authorInitial || (post.author ? post.author.charAt(0) : '?');
      const avatarColor = post.avatarColor || '#7986cb';
      const likeCount = post.likes || 0;
      const commentCount = post.commentCount || 0;

      const slidesHtml = slides.map((slide, i) => {
        if (slide.imageUrl) {
          return `<div class="carousel-slide ${i === 0 ? 'active' : ''}" data-slide="${i}">
            <img src="${slide.imageUrl}" alt="Slide ${slide.slideNumber}" loading="lazy">
          </div>`;
        }
        return `<div class="carousel-slide carousel-slide--placeholder ${i === 0 ? 'active' : ''}" data-slide="${i}">
          <div>${slide.type === 'question' ? escapeHtml(post.question) : 'Image ' + slide.slideNumber}</div>
        </div>`;
      }).join('');

      const dotsHtml = slides.map((_, i) =>
        `<button class="carousel-dot ${i === 0 ? 'active' : ''}" data-dot="${i}" onclick="goToSlide('${post.id}', ${i})"></button>`
      ).join('');

      return `
        <div class="feed-card feed-card--carousel" data-post-id="${post.id}" data-content-type="carousel">
          <div class="carousel-layout">

            <!-- Carousel Side -->
            <div class="carousel-side">
              <div class="carousel-author-overlay">
                <div class="feed-card__avatar" style="background:${avatarColor}">${escapeHtml(authorInitial)}</div>
                <div class="feed-card__author-info">
                  <span class="feed-card__author-name">${escapeHtml(post.author || 'Unknown')}</span>
                  <span class="feed-card__date">${formatDate(post.createdAt)}</span>
                </div>
              </div>

              <div class="carousel-slides" data-carousel="${post.id}">
                ${slidesHtml}
              </div>

              <div class="carousel-nav">
                <button class="carousel-btn" onclick="prevSlide('${post.id}')">&#8249;</button>
                <div class="carousel-dots" data-dots="${post.id}">
                  ${dotsHtml}
                </div>
                <button class="carousel-btn" onclick="nextSlide('${post.id}')">&#8250;</button>
              </div>
            </div>

            <!-- Comments Side -->
            <div class="comments-side">
              <div class="comments-side__header">
                <span class="comments-side__title">Conversation</span>
                <span class="comments-side__count" data-thread-count="${post.id}">Loading...</span>
              </div>

              <div class="comments-side__thread" data-thread="${post.id}">
                <!-- AI comments animate in here -->
              </div>

              <button class="comments-side__summary-btn" onclick="generateSummary('${post.id}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Summarize Thread
              </button>

              <div class="comments-side__input-area">
                <input class="comments-side__input" data-thread-input="${post.id}" type="text" placeholder="Reply to the conversation..." onkeydown="if(event.key==='Enter')handleThreadReply('${post.id}')">
                <button class="comments-side__send" onclick="handleThreadReply('${post.id}')">Send</button>
              </div>

              <div class="feed-card__actions">
                <button class="feed-card__action-btn" data-like-btn="${post.id}" onclick="toggleLike('${post.id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                  <span data-like-count="${post.id}">${likeCount}</span>
                </button>
                <button class="feed-card__action-btn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                  <span data-comment-count="${post.id}">${commentCount}</span>
                </button>
              </div>
            </div>

          </div>
        </div>
      `;
    }

    // Carousel navigation
    const carouselStates = {};

    function goToSlide(postId, index) {
      const container = document.querySelector(`[data-carousel="${postId}"]`);
      const dotsContainer = document.querySelector(`[data-dots="${postId}"]`);
      if (!container) return;

      const slides = container.querySelectorAll('.carousel-slide');
      const dots = dotsContainer?.querySelectorAll('.carousel-dot');

      slides.forEach(s => s.classList.remove('active'));
      dots?.forEach(d => d.classList.remove('active'));

      if (slides[index]) slides[index].classList.add('active');
      if (dots?.[index]) dots[index].classList.add('active');

      carouselStates[postId] = index;
    }

    function nextSlide(postId) {
      const container = document.querySelector(`[data-carousel="${postId}"]`);
      if (!container) return;
      const total = container.querySelectorAll('.carousel-slide').length;
      const current = carouselStates[postId] || 0;
      goToSlide(postId, (current + 1) % total);
    }

    function prevSlide(postId) {
      const container = document.querySelector(`[data-carousel="${postId}"]`);
      if (!container) return;
      const total = container.querySelectorAll('.carousel-slide').length;
      const current = carouselStates[postId] || 0;
      goToSlide(postId, (current - 1 + total) % total);
    }

    // =========================================================================
    // ANIMATED COMMENT THREADS
    // =========================================================================

    /**
     * Render a single comment element (no animation classes yet ‚Äî DFS adds them).
     */
    function renderComment(comment) {
      const avatarColor = comment.avatar?.color || '#7986cb';
      const initial = comment.avatar?.initial || comment.authorName?.charAt(0) || '?';
      const role = comment.authorRole || comment.avatar?.role || '';
      const sentiment = comment.sentiment || '';
      const commentId = comment.id || `c-${Math.random().toString(36).slice(2, 8)}`;

      let repliesHtml = '';
      if (comment.replies && comment.replies.length > 0) {
        repliesHtml = `<div class="thread-replies">
          ${comment.replies.map(r => renderComment(r)).join('')}
        </div>`;
      }

      return `
        <div class="thread-comment" data-comment-id="${commentId}">
          <div class="thread-comment__main">
            <div class="thread-comment__avatar" style="background:${avatarColor};position:relative">${escapeHtml(initial)}</div>
            <div class="thread-comment__body">
              <div class="thread-comment__author">
                ${escapeHtml(comment.authorName || 'Agent')}
                <span class="thread-comment__role">${escapeHtml(role)}</span>
              </div>
              <div class="thread-comment__text">${escapeHtml(comment.text || '')}</div>
              ${sentiment ? `<span class="thread-comment__sentiment thread-comment__sentiment--${sentiment}">${sentiment}</span>` : ''}
            </div>
          </div>
          ${repliesHtml}
        </div>
      `;
    }

    /**
     * Track active animations per post so we can stop them.
     */
    const activeAnimations = new Map(); // postId -> { stop: Function }

    /**
     * Stop a running animation for a post ‚Äî reveal all remaining comments instantly.
     */
    function stopAnimation(postId) {
      const anim = activeAnimations.get(postId);
      if (!anim) return;
      anim.stop();
      activeAnimations.delete(postId);
    }

    /**
     * Depth-first animation: collect all .thread-comment elements in DFS order,
     * then reveal them one by one with a typing indicator.
     */
    function animateThreadDFS(container) {
      const allComments = container.querySelectorAll('.thread-comment');
      if (allComments.length === 0) return;

      const postId = container.closest('.feed-card')?.dataset.postId;
      const TYPING_DURATION = 2000;
      const REVEAL_STAGGER = 3000;
      let currentIndex = 0;
      let stopped = false;
      let currentTypingEl = null;
      let pendingTimeout = null;

      function revealAllRemaining() {
        stopped = true;
        if (pendingTimeout) clearTimeout(pendingTimeout);
        if (currentTypingEl) { currentTypingEl.remove(); currentTypingEl = null; }
        // Instantly show all unrevealed comments
        allComments.forEach(el => {
          if (!el.classList.contains('dfs-visible')) {
            el.classList.add('dfs-visible');
          }
        });
      }

      function revealNext() {
        if (stopped || currentIndex >= allComments.length) {
          if (postId) activeAnimations.delete(postId);
          return;
        }

        const commentEl = allComments[currentIndex];
        const avatar = commentEl.querySelector('.thread-comment__avatar');
        const avatarColor = avatar?.style.background || '#7986cb';
        const initial = avatar?.textContent?.trim() || '?';

        // Show typing indicator
        const typingEl = document.createElement('div');
        typingEl.className = 'thread-typing-indicator';
        typingEl.innerHTML = `
          <div class="thread-typing-indicator__avatar" style="background:${avatarColor}">${escapeHtml(initial)}</div>
          <div class="thread-typing-indicator__dots"><span></span><span></span><span></span></div>
        `;
        commentEl.parentNode.insertBefore(typingEl, commentEl);
        currentTypingEl = typingEl;

        typingEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        pendingTimeout = setTimeout(() => {
          if (stopped) return;
          typingEl.remove();
          currentTypingEl = null;
          commentEl.classList.add('dfs-visible');
          commentEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          currentIndex++;
          pendingTimeout = setTimeout(revealNext, REVEAL_STAGGER);
        }, TYPING_DURATION);
      }

      // Register this animation so it can be stopped
      if (postId) {
        activeAnimations.set(postId, { stop: revealAllRemaining });
      }

      revealNext();
    }

    async function loadCommentThread(postId) {
      const threadContainer = document.querySelector(`[data-thread="${postId}"]`);
      const countEl = document.querySelector(`[data-thread-count="${postId}"]`);
      if (!threadContainer) return;

      try {
        // Load from commentThreads collection
        const snapshot = await feedDb.collection('commentThreads')
          .where('postId', '==', postId)
          .limit(1)
          .get();

        if (snapshot.empty) {
          // Fallback: load from regular comments subcollection
          const commentsSnapshot = await feedDb.collection('feedPosts').doc(postId).collection('comments').orderBy('createdAt', 'asc').get();
          if (commentsSnapshot.empty) {
            threadContainer.innerHTML = '<div style="padding:1rem;color:rgba(255,255,255,0.4);font-size:0.85rem;text-align:center;">Conversation starting soon...</div>';
            if (countEl) countEl.textContent = '0 comments';
            return;
          }
          const comments = commentsSnapshot.docs.map(d => d.data());
          threadContainer.innerHTML = comments.map(c => renderComment(c)).join('');
          if (countEl) countEl.textContent = `${comments.length} comments`;
          animateThreadDFS(threadContainer);
          return;
        }

        const threadData = snapshot.docs[0].data();
        const comments = threadData.comments || [];
        const totalComments = threadData.totalComments || comments.length;

        if (countEl) countEl.textContent = `${totalComments} comments`;

        // Render all comments (hidden), then animate in DFS order
        threadContainer.innerHTML = comments.map(c => renderComment(c)).join('');

        // Use IntersectionObserver ‚Äî start animating when visible, stop when scrolled away
        const card = threadContainer.closest('.feed-card');
        const postIdForObserver = card?.dataset.postId;
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              // Stop all other running animations
              for (const [otherId] of activeAnimations) {
                if (otherId !== postIdForObserver) {
                  stopAnimation(otherId);
                }
              }
              // Start this one if not already running/completed
              if (!activeAnimations.has(postIdForObserver)) {
                const hasUnrevealed = threadContainer.querySelector('.thread-comment:not(.dfs-visible)');
                if (hasUnrevealed) {
                  animateThreadDFS(threadContainer);
                }
              }
            }
          });
        }, { threshold: 0.3 });
        observer.observe(card);

      } catch (err) {
        console.error('Error loading thread for post', postId, err);
        threadContainer.innerHTML = '<div style="padding:1rem;color:rgba(255,255,255,0.3);font-size:0.8rem;">Could not load conversation.</div>';
      }
    }

    function generateSummary(postId) {
      alert('Thread summary generation coming soon! This will use AI to summarize the entire conversation.');
    }

    async function handleThreadReply(postId) {
      const input = document.querySelector(`[data-thread-input="${postId}"]`);
      if (!input) return;
      const content = input.value.trim();
      if (!content) return;
      input.value = '';

      const user = firebase.auth().currentUser;
      await feedDb.collection('feedPosts').doc(postId).collection('comments').add({
        userId: user.uid,
        displayName: user.displayName || 'Anonymous',
        authorName: user.displayName || 'Anonymous',
        text: content,
        content: content,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await feedDb.collection('feedPosts').doc(postId).update({ commentCount: firebase.firestore.FieldValue.increment(1) });

      // Add the comment to the thread UI
      const threadContainer = document.querySelector(`[data-thread="${postId}"]`);
      if (threadContainer) {
        const commentHtml = renderComment({
          authorName: user.displayName || 'You',
          text: content,
          avatar: { initial: (user.displayName || 'Y').charAt(0), color: '#3b82f6' }
        }, 0);
        threadContainer.insertAdjacentHTML('beforeend', commentHtml);
        threadContainer.scrollTop = threadContainer.scrollHeight;
      }
    }

    // =========================================================================
    // RENDER POST CARD (handles both text and carousel)
    // =========================================================================

    function renderPostCard(post) {
      // Route to carousel renderer if carousel type
      if (post.contentType === 'carousel') {
        return renderCarouselCard(post);
      }

      const isPremiumLocked = post.premium && !hasPremiumAccess;
      const tags = post.tags || [];
      const likeCount = post.likes || 0;
      const commentCount = post.commentCount || 0;
      const authorInitial = post.authorInitial || (post.author ? post.author.charAt(0) : '?');

      let interactiveHtml = '';
      if (post.contentType === 'interactive' && post.interactiveData) {
        interactiveHtml = `<div class="feed-card__interactive" data-interactive="${post.id}" data-interactive-type="cytoscape"></div>`;
      } else if (post.contentType === 'chart' && post.interactiveData) {
        interactiveHtml = `<div class="feed-card__interactive" data-interactive="${post.id}" data-interactive-type="chart"><canvas id="chart-${post.id}"></canvas></div>`;
      }

      return `
        <div class="feed-card ${isPremiumLocked ? 'feed-card--premium' : ''}" data-category="${post.category}" data-post-id="${post.id}">
          <div class="feed-card__header">
            <span class="feed-card__category feed-card__category--${post.category}">${post.category}</span>
            ${post.premium ? '<span class="feed-card__premium-badge">&#9733; Premium</span>' : ''}
          </div>
          <h3 class="feed-card__title">${escapeHtml(post.title || '')}</h3>
          <div class="feed-card__content">
            <p>${escapeHtml(post.content || '')}</p>
          </div>
          ${interactiveHtml}
          ${isPremiumLocked ? `
            <button class="feed-card__unlock" onclick="handleUnlock()">
              &#128274; Unlock Premium Content
            </button>
          ` : ''}
          <div class="feed-card__tags">
            ${tags.map(t => `<span class="feed-tag">#${escapeHtml(t)}</span>`).join('')}
          </div>
          <div class="feed-card__author">
            <div class="feed-card__avatar">${escapeHtml(authorInitial)}</div>
            <div class="feed-card__author-info">
              <span class="feed-card__author-name">${escapeHtml(post.author || 'Unknown')}</span>
              <span class="feed-card__date">${formatDate(post.createdAt)}</span>
            </div>
          </div>
          <div class="feed-card__actions">
            <button class="feed-card__action-btn" data-like-btn="${post.id}" onclick="toggleLike('${post.id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              <span data-like-count="${post.id}">${likeCount}</span>
            </button>
            <button class="feed-card__action-btn" onclick="toggleComments('${post.id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              <span data-comment-count="${post.id}">${commentCount}</span>
            </button>
          </div>
          <div class="feed-card__comments" data-comments="${post.id}">
            <div class="feed-card__comments-list" data-comments-list="${post.id}"></div>
            <div class="feed-card__comment-form">
              <input class="feed-card__comment-input" data-comment-input="${post.id}" type="text" placeholder="Write a comment..." onkeydown="if(event.key==='Enter')handleCommentSubmit('${post.id}')">
              <button class="feed-card__comment-submit" onclick="handleCommentSubmit('${post.id}')">Post</button>
            </div>
          </div>
        </div>
      `;
    }

    function initInteractives() {
      // Initialize Cytoscape instances
      document.querySelectorAll('[data-interactive-type="cytoscape"]').forEach(el => {
        const postId = el.dataset.interactive;
        try {
          const card = el.closest('.feed-card');
          const postData = card?.__postData;
          if (postData?.interactiveData) {
            cytoscape({
              container: el,
              elements: postData.interactiveData.elements || [],
              style: postData.interactiveData.style || [{ selector: 'node', style: { 'background-color': '#7986cb', 'label': 'data(label)', 'color': '#fff' } }, { selector: 'edge', style: { 'line-color': '#5c6bc0', 'target-arrow-color': '#5c6bc0', 'target-arrow-shape': 'triangle' } }],
              layout: postData.interactiveData.layout || { name: 'cose' }
            });
          }
        } catch (e) {
          console.warn('Failed to init Cytoscape for post', postId, e);
        }
      });

      // Initialize Chart.js instances
      document.querySelectorAll('[data-interactive-type="chart"]').forEach(el => {
        const postId = el.dataset.interactive;
        try {
          const card = el.closest('.feed-card');
          const postData = card?.__postData;
          const canvas = document.getElementById(`chart-${postId}`);
          if (postData?.interactiveData && canvas) {
            new Chart(canvas.getContext('2d'), postData.interactiveData);
          }
        } catch (e) {
          console.warn('Failed to init Chart.js for post', postId, e);
        }
      });
    }

    async function checkUserLikes(postIds) {
      const uid = firebase.auth().currentUser?.uid;
      if (!uid || postIds.length === 0) return;
      const checks = postIds.map(id => feedDb.collection('feedPosts').doc(id).collection('likes').doc(uid).get());
      const results = await Promise.all(checks);
      results.forEach((doc, i) => {
        if (doc.exists) {
          const btn = document.querySelector(`[data-like-btn="${postIds[i]}"]`);
          if (btn) btn.classList.add('liked');
        }
      });
    }

    async function renderFeed(category = 'all', append = false) {
      const container = document.getElementById('feed-container');
      const loadMoreBtn = document.getElementById('load-more-btn');

      if (!append) {
        container.innerHTML = '';
        lastVisibleDoc = null;
        noMorePosts = false;
      }

      try {
        const snapshot = await loadFeedPosts(category, lastVisibleDoc);
        const docs = snapshot.docs;

        if (docs.length < POSTS_PER_PAGE) {
          noMorePosts = true;
        }

        if (docs.length > 0) {
          lastVisibleDoc = docs[docs.length - 1];
        }

        const postIds = [];
        docs.forEach(doc => {
          const post = { id: doc.id, ...doc.data() };
          postIds.push(doc.id);
          const cardHtml = renderPostCard(post);
          container.insertAdjacentHTML('beforeend', cardHtml);
          // Store post data on the card element for interactive init
          const cardEl = container.querySelector(`[data-post-id="${doc.id}"]`);
          if (cardEl) cardEl.__postData = post;
        });

        // Show/hide load more
        loadMoreBtn.style.display = noMorePosts ? 'none' : 'block';

        // Animate new cards in
        const selector = append ? '.feed-card:not(.animated)' : '.feed-card';
        anime({
          targets: selector,
          opacity: [0, 1],
          translateY: [20, 0],
          delay: anime.stagger(80),
          easing: 'easeOutCubic',
          duration: 500,
          complete: () => {
            document.querySelectorAll('.feed-card').forEach(c => c.classList.add('animated'));
          }
        });

        // Init interactive elements
        initInteractives();

        // Load comment threads for carousel posts
        document.querySelectorAll('[data-content-type="carousel"]').forEach(card => {
          const postId = card.dataset.postId;
          if (postId) loadCommentThread(postId);
        });

        // Check which posts the current user has liked
        checkUserLikes(postIds);

      } catch (e) {
        console.error('Error loading feed posts:', e);
        if (!append) {
          container.innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.5);padding:2rem;">Could not load feed. Please try again later.</p>';
        }
        loadMoreBtn.style.display = 'none';
      }
    }

    function handleUnlock() {
      alert('Premium access required. Visit the shop to upgrade your plan.');
    }

    // =========================================================================
    // FILTERS
    // =========================================================================

    function setupFilters() {
      const pills = document.querySelectorAll('.filter-pill');
      pills.forEach(pill => {
        pill.addEventListener('click', () => {
          pills.forEach(p => p.classList.remove('active'));
          pill.classList.add('active');
          currentCategory = pill.dataset.category;
          renderFeed(currentCategory);
        });
      });
    }

    // =========================================================================
    // INIT
    // =========================================================================

    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('auth-loading');
      const dashboardContent = document.getElementById('dashboard-content');

      try {
      console.log('[Feed] DOMContentLoaded fired');

      // Initialize Firebase
      if (!window.FirebaseApp.init()) {
        console.error('[Feed] Firebase initialization failed');
        loadingScreen.innerHTML = '<div class="loading-content"><p>Error loading. Please refresh.</p></div>';
        return;
      }
      console.log('[Feed] Firebase initialized');

      feedDb = firebase.firestore();

      window.AuthService.init();
      console.log('[Feed] AuthService initialized, waiting for auth state...');

      // Wait for auth state with a safety timeout
      const user = await Promise.race([
        window.AuthService.waitForAuthState(),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Auth timeout')), 8000))
      ]).catch(err => {
        if (err.message === 'Auth timeout') {
          console.warn('[Feed] Auth state timed out, treating as unauthenticated');
          return null;
        }
        throw err;
      });
      console.log('[Feed] Auth state resolved:', user ? user.email : 'null');

      if (!user) {
        window.AuthService.setRedirectUrl(window.location.href);
        window.location.href = '../auth/login.html';
        return;
      }

      // User is logged in, show page
      loadingScreen.classList.add('hidden');
      dashboardContent.classList.add('ready');

      // Setup sidebar, user info, logout
      setupSidebar();
      setupLogout();
      loadUserInfo(user);

      // Check admin/basketball sections
      if (window.RBACService) {
        const isAdmin = await window.RBACService.hasRole('admin');
        if (isAdmin) document.getElementById('admin-section').style.display = 'block';
        const hasBasketball = isAdmin || await window.RBACService.belongsToOrganization('city-high-basketball');
        if (hasBasketball) document.getElementById('basketball-section').style.display = 'block';
      }

      // Check premium access
      try {
        if (window.WhopService?.checkAccess) {
          hasPremiumAccess = await window.WhopService.checkAccess();
        }
      } catch (e) {
        console.log('Could not check premium access:', e);
      }

      // Render feed and setup filters
      renderFeed();
      setupFilters();

      // Load More button
      document.getElementById('load-more-btn').addEventListener('click', () => {
        renderFeed(currentCategory, true);
      });

      // Listen for auth changes
      window.AuthService.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = '../auth/login.html';
        }
      });

      } catch (err) {
        console.error('Feed init error:', err);
        loadingScreen.innerHTML = '<div class="loading-content"><p>Error: ' + err.message + '</p></div>';
      }
    });

    function loadUserInfo(user) {
      const displayName = user.displayName || user.email.split('@')[0];
      document.getElementById('user-name').textContent = displayName;
      const avatar = document.getElementById('user-avatar');
      if (user.photoURL) {
        avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
      } else {
        avatar.textContent = displayName.charAt(0).toUpperCase();
      }
    }

    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      const overlay = document.getElementById('sidebar-overlay');
      const mobileBtn = document.getElementById('mobile-menu-btn');

      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });

      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }

      mobileBtn.addEventListener('click', () => { sidebar.classList.add('open'); });
      overlay.addEventListener('click', () => { sidebar.classList.remove('open'); });
    }

    function setupLogout() {
      document.getElementById('logout-link').addEventListener('click', async (e) => {
        e.preventDefault();
        await window.AuthService.logout();
        window.location.href = '../index.html';
      });
    }
  </script>
</body>
</html>
