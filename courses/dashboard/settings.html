<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | AutoNateAI Learning Hub</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Critical styles -->
  <style>
    .dashboard { display: none !important; }
    .dashboard.ready { display: flex !important; }
    .auth-loading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #0a0a0f;
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .auth-loading.hidden { display: none; }
    .loading-content { text-align: center; color: #e8e8f0; }
    .loading-icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(121, 134, 203, 0.3);
      border-top-color: #7986cb;
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <!-- Theme loader (before CSS to prevent flash) -->
  <script src="../shared/js/theme-loader.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="../shared/css/dashboard.css">

  <!-- Settings Page Styles -->
  <style>
    /* =================================================================
       GLASS CARD
       ================================================================= */
    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 1.25rem;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      margin-bottom: 1.5rem;
    }
    .glass-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }
    [data-theme="light"] .glass-card {
      background: rgba(255, 255, 255, 0.7);
      border-color: rgba(0, 0, 0, 0.08);
    }
    .glass-card__title {
      font-size: 0.75rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .glass-card__title span { font-size: 1rem; }

    /* =================================================================
       SECTION HEADERS
       ================================================================= */
    .section-header {
      margin-bottom: 1rem;
      margin-top: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .section-header:first-child { margin-top: 0; }
    .section-title {
      font-family: var(--font-display, 'Space Grotesk', sans-serif);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary, #e8e8f0);
    }

    /* =================================================================
       ACCOUNT SETTINGS
       ================================================================= */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .profile-field {
      margin-bottom: 1.25rem;
    }
    .profile-field:last-child { margin-bottom: 0; }
    .profile-field__label {
      display: block;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted, #6a6a80);
      margin-bottom: 0.5rem;
    }
    .profile-field__row {
      display: flex;
      gap: 0.5rem;
    }
    .profile-field__input {
      flex: 1;
      padding: 0.6rem 0.85rem;
      background: var(--bg-tertiary, #1a1a2e);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      color: var(--text-primary, #e8e8f0);
      font-family: var(--font-body, 'Inter', sans-serif);
      font-size: 0.9rem;
      transition: border-color 0.2s ease;
    }
    .profile-field__input:focus {
      outline: none;
      border-color: var(--accent-primary, #7986cb);
    }
    .profile-field__save {
      padding: 0.6rem 1.25rem;
      background: linear-gradient(135deg, var(--accent-primary, #7986cb), #9575cd);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .profile-field__save:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(121, 134, 203, 0.3);
    }
    .profile-field__save:disabled {
      opacity: 0.5; cursor: not-allowed; transform: none;
    }
    .profile-field__value {
      color: var(--text-secondary, #a0a0b8);
      font-size: 0.9rem;
      padding: 0.6rem 0;
    }
    .profile-field__action {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text-secondary, #a0a0b8);
      font-family: var(--font-body, 'Inter', sans-serif);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .profile-field__action:hover {
      border-color: rgba(255, 255, 255, 0.2);
      color: var(--text-primary, #e8e8f0);
    }
    .profile-field__action.danger:hover {
      border-color: rgba(239, 83, 80, 0.4);
      color: var(--accent-error, #ef5350);
    }

    /* =================================================================
       TOGGLES & SELECTS
       ================================================================= */
    .settings-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    .settings-toggle-row:last-child { border-bottom: none; }
    .settings-toggle-label {
      font-size: 0.9rem;
      color: var(--text-primary, #e8e8f0);
    }
    .settings-toggle {
      position: relative;
      width: 40px; height: 22px;
      cursor: pointer;
    }
    .settings-toggle input {
      opacity: 0; width: 0; height: 0; position: absolute;
    }
    .settings-toggle__slider {
      position: absolute; inset: 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 11px;
      transition: all 0.3s;
    }
    .settings-toggle__slider::before {
      content: '';
      position: absolute;
      left: 2px; top: 2px;
      width: 16px; height: 16px;
      background: #a0a0b8;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .settings-toggle input:checked + .settings-toggle__slider {
      background: var(--accent-primary, #7986cb);
      border-color: transparent;
    }
    .settings-toggle input:checked + .settings-toggle__slider::before {
      transform: translateX(18px);
      background: white;
    }
    .settings-select-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    .settings-select {
      background: var(--bg-tertiary, #1a1a2e);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 0.35rem 0.6rem;
      color: var(--text-primary, #e8e8f0);
      font-size: 0.85rem;
      font-family: var(--font-body, 'Inter', sans-serif);
      outline: none;
    }

    /* =================================================================
       APPEARANCE
       ================================================================= */
    .appearance-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    .appearance-row:last-child { border-bottom: none; }
    .appearance-row__label {
      font-size: 0.9rem;
      color: var(--text-primary, #e8e8f0);
    }
    .appearance-row__desc {
      font-size: 0.75rem;
      color: var(--text-muted, #6a6a80);
      margin-top: 2px;
    }
    .theme-toggle-group {
      display: flex;
      background: var(--bg-tertiary, #1a1a2e);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .theme-toggle-btn {
      padding: 0.4rem 1rem;
      border: none;
      background: transparent;
      color: var(--text-secondary, #a0a0b8);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: var(--font-body, 'Inter', sans-serif);
    }
    .theme-toggle-btn.active {
      background: var(--accent-primary, #7986cb);
      color: #fff;
    }
    .font-size-group {
      display: flex;
      gap: 0.5rem;
    }
    .font-size-btn {
      padding: 0.35rem 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary, #a0a0b8);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: var(--font-body, 'Inter', sans-serif);
    }
    .font-size-btn.active {
      background: var(--accent-primary, #7986cb);
      color: #fff;
      border-color: transparent;
    }
    .color-swatch-group {
      display: flex;
      gap: 0.6rem;
    }
    .color-swatch {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch.active {
      border-color: var(--text-primary, #e8e8f0);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.15);
    }
    .color-swatch.active::after {
      content: '';
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* =================================================================
       MODALS
       ================================================================= */
    .profile-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 10002;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .profile-modal-overlay.active { display: flex; }
    .profile-modal {
      background: #12121a;
      border: 1px solid rgba(121, 134, 203, 0.2);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6);
      animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .profile-modal--danger { border-color: rgba(239, 83, 80, 0.3); }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .profile-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }
    .profile-modal__title {
      font-family: var(--font-heading, 'Space Grotesk', sans-serif);
      font-size: 1.1rem;
      font-weight: 600;
      color: #e8e8f0;
      margin: 0;
    }
    .profile-modal__close {
      background: none; border: none;
      color: #a0a0b8; font-size: 1.5rem;
      cursor: pointer; padding: 0; line-height: 1;
      transition: color 0.2s;
    }
    .profile-modal__close:hover { color: #e8e8f0; }
    .profile-modal__body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .profile-modal__footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }
    .profile-modal__info {
      background: rgba(121, 134, 203, 0.1);
      border: 1px solid rgba(121, 134, 203, 0.2);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
      color: #b8bfff;
      line-height: 1.5;
    }
    .profile-modal__warning {
      display: flex; gap: 0.75rem;
      background: rgba(239, 83, 80, 0.08);
      border: 1px solid rgba(239, 83, 80, 0.2);
      border-radius: 8px;
      padding: 1rem;
      font-size: 0.85rem;
      color: #ef9a9a;
      line-height: 1.5;
    }
    .profile-modal__warning-icon { font-size: 1.25rem; flex-shrink: 0; margin-top: 2px; }
    .profile-modal__warning p { margin: 0.25rem 0 0; color: #a0a0b8; }
    .profile-modal__error {
      font-size: 0.8rem;
      color: #ef5350;
      min-height: 1.2em;
    }
    .profile-modal__btn {
      padding: 0.6rem 1.25rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      font-family: var(--font-body, 'Inter', sans-serif);
    }
    .profile-modal__btn.primary {
      background: linear-gradient(135deg, #7986cb, #5c6bc0);
      color: #fff;
    }
    .profile-modal__btn.primary:hover { opacity: 0.9; }
    .profile-modal__btn.primary:disabled { opacity: 0.4; cursor: not-allowed; }
    .profile-modal__btn.secondary {
      background: rgba(255, 255, 255, 0.06);
      color: #a0a0b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .profile-modal__btn.secondary:hover { background: rgba(255, 255, 255, 0.1); color: #e8e8f0; }
    .profile-modal__btn.danger {
      background: linear-gradient(135deg, #ef5350, #c62828);
      color: #fff;
    }
    .profile-modal__btn.danger:hover { opacity: 0.9; }
    .profile-modal__btn.danger:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Password visibility toggle */
    .profile-field__input-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .profile-field__input-wrap .profile-field__input { flex: 1; padding-right: 2.5rem; }
    .profile-field__eye {
      position: absolute; right: 0.5rem;
      background: none; border: none;
      cursor: pointer; font-size: 1rem;
      opacity: 0.5; transition: opacity 0.2s;
      padding: 0.25rem;
    }
    .profile-field__eye:hover { opacity: 0.9; }

    /* Password strength bar */
    .password-strength {
      display: flex; align-items: center; gap: 0.5rem; margin-top: 0.35rem;
    }
    .password-strength__bar {
      flex: 1; height: 4px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 2px; overflow: hidden;
    }
    .password-strength__fill {
      display: block; height: 100%; border-radius: 2px;
      transition: width 0.3s, background 0.3s;
      width: 0;
    }
    .password-strength__text {
      font-size: 0.7rem; font-weight: 600;
      min-width: 3rem; text-align: right;
    }

    /* =================================================================
       PROFILE PICTURE UPLOAD
       ================================================================= */
    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      margin-bottom: 1.25rem;
    }
    .avatar-upload__preview {
      width: 72px; height: 72px;
      border-radius: 50%;
      background: var(--bg-tertiary, #1a1a2e);
      border: 2px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: var(--text-secondary, #a0a0b8);
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
    }
    .avatar-upload__preview img {
      width: 100%; height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .avatar-upload__actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .avatar-upload__btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text-secondary, #a0a0b8);
      font-family: var(--font-body, 'Inter', sans-serif);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .avatar-upload__btn:hover {
      border-color: var(--accent-primary, #7986cb);
      color: var(--text-primary, #e8e8f0);
    }
    .avatar-upload__btn--primary {
      background: linear-gradient(135deg, var(--accent-primary, #7986cb), #9575cd);
      border-color: transparent;
      color: white;
    }
    .avatar-upload__btn--primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(121, 134, 203, 0.3);
    }
    .avatar-upload__btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .avatar-upload__hint {
      font-size: 0.75rem;
      color: var(--text-muted, #6a6a80);
    }
    .avatar-upload__progress {
      width: 100%;
      height: 3px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 2px;
      overflow: hidden;
      display: none;
    }
    .avatar-upload__progress.active { display: block; }
    .avatar-upload__progress-fill {
      height: 100%;
      background: var(--accent-primary, #7986cb);
      border-radius: 2px;
      width: 0;
      transition: width 0.3s ease;
    }

    /* =================================================================
       TOASTS
       ================================================================= */
    .save-toast {
      position: fixed;
      top: 1.5rem; right: 1.5rem;
      background: rgba(15, 15, 25, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(102, 187, 106, 0.3);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      color: var(--text-primary, #e8e8f0);
      font-family: var(--font-body, 'Inter', sans-serif);
      z-index: 10003;
      display: flex; align-items: center; gap: 0.75rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      transform: translateX(120%); opacity: 0;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
      max-width: 320px;
    }
    .save-toast.show { transform: translateX(0); opacity: 1; }
    .save-toast__icon { font-size: 1.5rem; flex-shrink: 0; }
    .save-toast__message { font-size: 0.85rem; font-weight: 500; color: #a5d6a7; }

    .coming-soon-toast {
      position: fixed;
      top: 1.5rem; right: 1.5rem;
      background: rgba(15, 15, 25, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(121, 134, 203, 0.3);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      color: var(--text-primary, #e8e8f0);
      font-family: var(--font-body, 'Inter', sans-serif);
      z-index: 10000;
      display: flex; align-items: center; gap: 0.75rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 40px rgba(121, 134, 203, 0.1);
      transform: translateX(120%); opacity: 0;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
      max-width: 320px;
    }
    .coming-soon-toast.show { transform: translateX(0); opacity: 1; }
    .coming-soon-toast__icon { font-size: 1.5rem; flex-shrink: 0; }
    .coming-soon-toast__content { display: flex; flex-direction: column; gap: 0.15rem; }
    .coming-soon-toast__title { font-weight: 600; font-size: 0.9rem; color: #b8bfff; }
    .coming-soon-toast__message { font-size: 0.8rem; color: rgba(232, 232, 240, 0.7); }

    .coming-soon-badge {
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: linear-gradient(135deg, rgba(121, 134, 203, 0.3), rgba(159, 122, 234, 0.3));
      color: #b8bfff;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }

    /* =================================================================
       RESPONSIVE
       ================================================================= */
    @media (max-width: 1024px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      .appearance-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>

  <!-- Loading Screen -->
  <div class="auth-loading" id="auth-loading">
    <div class="loading-content">
      <div class="loading-icon">‚öôÔ∏è</div>
      <div class="loading-spinner"></div>
      <p>Loading settings...</p>
    </div>
  </div>

  <div class="dashboard" id="dashboard-content">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="../index.html" class="sidebar-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <span class="logo-text">AutoNateAI</span>
      </a>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">Main</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="index.html" class="nav-link">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">
                <span class="nav-icon">üìö</span>
                <span class="nav-text">Course Library</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="challenges.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span class="nav-text">Daily Challenges</span>
                <span class="nav-badge">3</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Learning</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="progress.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">My Progress</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="achievements.html" class="nav-link">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-text">Achievements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="notes.html" class="nav-link">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">Notes</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Community</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="feed.html" class="nav-link">
                <span class="nav-icon">üì∞</span>
                <span class="nav-text">Feed</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="https://discord.gg/Me5N8tCdkC" target="_blank" class="nav-link">
                <span class="nav-icon">üí¨</span>
                <span class="nav-text">Discord</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="leaderboard.html" class="nav-link">
                <span class="nav-icon">üèÖ</span>
                <span class="nav-text">Leaderboard</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Account</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="profile.html" class="nav-link">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="settings.html" class="nav-link active">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Admin Section (hidden by default) -->
        <div class="nav-section" id="admin-section" style="display: none;">
          <span class="nav-section-title" style="color: #f44336;">Admin</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="../admin/" class="nav-link">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">Admin Dashboard</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="sidebar-user">
        <div class="user-card" id="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-streak">
              <span>üî•</span>
              <span id="user-streak">0</span> day streak
            </div>
          </div>
        </div>
      </div>

      <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </aside>

    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
          <h1 class="page-title">Settings</h1>
        </div>
        <div class="header-right">
          <div class="header-actions">
            <button class="action-btn" id="notification-btn" title="Notifications">
              üîî
              <span class="notification-dot" id="notification-dot"></span>
              <span class="notification-count" id="notification-count"></span>
            </button>
          </div>
        </div>
      </header>

      <!-- Content Area -->
      <div class="content-area">

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             ACCOUNT SETTINGS
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="section-header" style="margin-top: 0;">
          <h3 class="section-title">Account Settings</h3>
        </div>

        <div class="settings-grid">
          <!-- Left: Profile Info -->
          <div class="glass-card">
            <h4 class="glass-card__title"><span>üë§</span> Profile Information</h4>

            <div class="profile-field">
              <label class="profile-field__label">Profile Picture</label>
              <div class="avatar-upload">
                <div class="avatar-upload__preview" id="avatar-preview">?</div>
                <div class="avatar-upload__actions">
                  <input type="file" id="avatar-file-input" accept="image/png,image/jpeg,image/webp" style="display:none">
                  <button class="avatar-upload__btn avatar-upload__btn--primary" id="avatar-upload-btn">
                    üì∑ Upload Photo
                  </button>
                  <button class="avatar-upload__btn" id="avatar-remove-btn" style="display:none">
                    üóëÔ∏è Remove
                  </button>
                  <span class="avatar-upload__hint">JPG, PNG, or WebP. Max 2MB.</span>
                  <div class="avatar-upload__progress" id="avatar-progress">
                    <div class="avatar-upload__progress-fill" id="avatar-progress-fill"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="profile-field">
              <label class="profile-field__label">Display Name</label>
              <div class="profile-field__row">
                <input type="text" class="profile-field__input" id="edit-display-name" placeholder="Your display name">
                <button class="profile-field__save" id="save-display-name">Save</button>
              </div>
            </div>
            <div class="profile-field">
              <label class="profile-field__label">Email Address</label>
              <div class="profile-field__value" id="display-email">loading...</div>
            </div>
          </div>

          <!-- Right: Security -->
          <div class="glass-card">
            <h4 class="glass-card__title"><span>üîí</span> Security</h4>
            <div class="profile-field">
              <label class="profile-field__label">Password</label>
              <button class="profile-field__action" id="change-password-btn">
                üîë Change Password
              </button>
            </div>
            <div class="profile-field">
              <label class="profile-field__label">Account</label>
              <button class="profile-field__action danger" id="delete-account-btn">
                üóëÔ∏è Delete Account
              </button>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             NOTIFICATION PREFERENCES
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="section-header">
          <h3 class="section-title">Notification Preferences</h3>
        </div>

        <div class="glass-card">
          <h4 class="glass-card__title"><span>üîî</span> Notifications</h4>

          <div class="settings-toggle-row">
            <span class="settings-toggle-label">Email Digest</span>
            <label class="settings-toggle">
              <input type="checkbox" id="pref-email-digest">
              <span class="settings-toggle__slider"></span>
            </label>
          </div>

          <div class="settings-toggle-row">
            <span class="settings-toggle-label">Push Notifications</span>
            <label class="settings-toggle">
              <input type="checkbox" id="pref-push-notif">
              <span class="settings-toggle__slider"></span>
            </label>
          </div>

          <div class="settings-select-row">
            <span class="settings-toggle-label">Digest Frequency</span>
            <select class="settings-select" id="pref-frequency">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="never">Never</option>
            </select>
          </div>

          <div class="settings-toggle-row">
            <span class="settings-toggle-label">Progress Updates</span>
            <label class="settings-toggle">
              <input type="checkbox" id="pref-topic-progress" checked>
              <span class="settings-toggle__slider"></span>
            </label>
          </div>

          <div class="settings-toggle-row">
            <span class="settings-toggle-label">Streak Reminders</span>
            <label class="settings-toggle">
              <input type="checkbox" id="pref-topic-streaks" checked>
              <span class="settings-toggle__slider"></span>
            </label>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             APPEARANCE
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="section-header">
          <h3 class="section-title">Appearance</h3>
        </div>

        <div class="glass-card">
          <h4 class="glass-card__title"><span>üé®</span> Theme & Display</h4>

          <div class="appearance-row">
            <div>
              <div class="appearance-row__label">Theme</div>
              <div class="appearance-row__desc">Choose your preferred color scheme</div>
            </div>
            <div class="theme-toggle-group">
              <button class="theme-toggle-btn active" data-theme="dark">Dark</button>
              <button class="theme-toggle-btn" data-theme="light">Light</button>
            </div>
          </div>

          <div class="appearance-row">
            <div>
              <div class="appearance-row__label">Font Size</div>
              <div class="appearance-row__desc">Adjust text size for readability</div>
            </div>
            <div class="font-size-group">
              <button class="font-size-btn" data-size="small">A-</button>
              <button class="font-size-btn active" data-size="medium">A</button>
              <button class="font-size-btn" data-size="large">A+</button>
            </div>
          </div>

          <div class="appearance-row">
            <div>
              <div class="appearance-row__label">Accent Color</div>
              <div class="appearance-row__desc">Personalize your dashboard color</div>
            </div>
            <div class="color-swatch-group">
              <div class="color-swatch active" data-color="#7986cb" style="background: #7986cb;" title="Indigo"></div>
              <div class="color-swatch" data-color="#4db6ac" style="background: #4db6ac;" title="Teal"></div>
              <div class="color-swatch" data-color="#e57373" style="background: #e57373;" title="Rose"></div>
              <div class="color-swatch" data-color="#ffd54f" style="background: #ffd54f;" title="Amber"></div>
              <div class="color-swatch" data-color="#81c784" style="background: #81c784;" title="Green"></div>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             FEED & POSTS
             ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="section-header">
          <h3 class="section-title">Feed & Posts</h3>
        </div>

        <div class="settings-grid">
          <!-- Left: Feed Preferences -->
          <div class="glass-card">
            <h4 class="glass-card__title"><span>üì∞</span> Feed Preferences</h4>

            <div class="settings-toggle-row">
              <div>
                <span class="settings-toggle-label">Show Code Snippets</span>
                <div class="appearance-row__desc">Display code blocks inline in feed posts</div>
              </div>
              <label class="settings-toggle">
                <input type="checkbox" id="feed-show-code" checked>
                <span class="settings-toggle__slider"></span>
              </label>
            </div>

            <div class="settings-toggle-row">
              <div>
                <span class="settings-toggle-label">Auto-play Milestones</span>
                <div class="appearance-row__desc">Show milestone animations in feed</div>
              </div>
              <label class="settings-toggle">
                <input type="checkbox" id="feed-autoplay-milestones" checked>
                <span class="settings-toggle__slider"></span>
              </label>
            </div>

            <div class="settings-select-row">
              <div>
                <span class="settings-toggle-label">Default Feed View</span>
                <div class="appearance-row__desc">What you see when you open Feed</div>
              </div>
              <select class="settings-select" id="feed-default-view">
                <option value="trending">Trending</option>
                <option value="latest">Latest</option>
                <option value="following">Following</option>
              </select>
            </div>
          </div>

          <!-- Right: Post Defaults -->
          <div class="glass-card">
            <h4 class="glass-card__title"><span>üìù</span> Post Defaults</h4>

            <div class="settings-select-row">
              <div>
                <span class="settings-toggle-label">Default Post Type</span>
                <div class="appearance-row__desc">Pre-selected when composing</div>
              </div>
              <select class="settings-select" id="post-default-type">
                <option value="status">Status</option>
                <option value="code_snippet">Code Snippet</option>
                <option value="project_showcase">Showcase</option>
                <option value="article">Article</option>
              </select>
            </div>

            <div class="settings-toggle-row">
              <div>
                <span class="settings-toggle-label">Allow Comments</span>
                <div class="appearance-row__desc">Let others comment on your posts by default</div>
              </div>
              <label class="settings-toggle">
                <input type="checkbox" id="post-allow-comments" checked>
                <span class="settings-toggle__slider"></span>
              </label>
            </div>

            <div class="settings-toggle-row">
              <div>
                <span class="settings-toggle-label">Show Activity Status</span>
                <div class="appearance-row__desc">Let others see when you're online</div>
              </div>
              <label class="settings-toggle">
                <input type="checkbox" id="post-show-activity" checked>
                <span class="settings-toggle__slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Privacy -->
        <div class="glass-card">
          <h4 class="glass-card__title"><span>üîí</span> Feed Privacy</h4>

          <div class="settings-toggle-row">
            <div>
              <span class="settings-toggle-label">Public Profile</span>
              <div class="appearance-row__desc">Allow anyone to view your profile and posts</div>
            </div>
            <label class="settings-toggle">
              <input type="checkbox" id="privacy-public-profile" checked>
              <span class="settings-toggle__slider"></span>
            </label>
          </div>

          <div class="settings-toggle-row">
            <div>
              <span class="settings-toggle-label">Show in Leaderboard</span>
              <div class="appearance-row__desc">Include your stats on the community leaderboard</div>
            </div>
            <label class="settings-toggle">
              <input type="checkbox" id="privacy-show-leaderboard" checked>
              <span class="settings-toggle__slider"></span>
            </label>
          </div>

          <div class="settings-toggle-row">
            <div>
              <span class="settings-toggle-label">Allow Mentions</span>
              <div class="appearance-row__desc">Let others tag you with @mention in posts</div>
            </div>
            <label class="settings-toggle">
              <input type="checkbox" id="privacy-allow-mentions" checked>
              <span class="settings-toggle__slider"></span>
            </label>
          </div>
        </div>

      </div><!-- /.content-area -->
    </main>

  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MODALS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- Change Password Modal -->
  <div class="profile-modal-overlay" id="password-modal">
    <div class="profile-modal">
      <div class="profile-modal__header">
        <h3 class="profile-modal__title">Change Password</h3>
        <button class="profile-modal__close" id="password-modal-close">&times;</button>
      </div>
      <div class="profile-modal__body">
        <div class="profile-modal__info" id="password-provider-info" style="display: none;">
          You signed in with Google. To set a password, use the "Send Reset Email" option below.
        </div>
        <div id="password-fields">
          <div class="profile-field">
            <label class="profile-field__label">Current Password</label>
            <div class="profile-field__input-wrap">
              <input type="password" class="profile-field__input" id="current-password" placeholder="Enter current password" autocomplete="current-password">
              <button class="profile-field__eye" data-target="current-password" aria-label="Toggle visibility">üëÅ</button>
            </div>
          </div>
          <div class="profile-field">
            <label class="profile-field__label">New Password</label>
            <div class="profile-field__input-wrap">
              <input type="password" class="profile-field__input" id="new-password" placeholder="At least 6 characters" autocomplete="new-password">
              <button class="profile-field__eye" data-target="new-password" aria-label="Toggle visibility">üëÅ</button>
            </div>
            <div class="password-strength" id="password-strength">
              <div class="password-strength__bar"><span class="password-strength__fill" id="password-strength-fill"></span></div>
              <span class="password-strength__text" id="password-strength-text"></span>
            </div>
          </div>
          <div class="profile-field">
            <label class="profile-field__label">Confirm New Password</label>
            <div class="profile-field__input-wrap">
              <input type="password" class="profile-field__input" id="confirm-password" placeholder="Re-enter new password" autocomplete="new-password">
              <button class="profile-field__eye" data-target="confirm-password" aria-label="Toggle visibility">üëÅ</button>
            </div>
          </div>
        </div>
        <div class="profile-modal__error" id="password-error"></div>
      </div>
      <div class="profile-modal__footer">
        <button class="profile-modal__btn secondary" id="password-reset-email-btn">Send Reset Email</button>
        <button class="profile-modal__btn primary" id="password-save-btn">Update Password</button>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div class="profile-modal-overlay" id="delete-modal">
    <div class="profile-modal profile-modal--danger">
      <div class="profile-modal__header">
        <h3 class="profile-modal__title">Delete Account</h3>
        <button class="profile-modal__close" id="delete-modal-close">&times;</button>
      </div>
      <div class="profile-modal__body">
        <div class="profile-modal__warning">
          <span class="profile-modal__warning-icon">‚ö†Ô∏è</span>
          <div>
            <strong>This action is permanent and cannot be undone.</strong>
            <p>All your data including course progress, achievements, and settings will be permanently deleted.</p>
          </div>
        </div>
        <div class="profile-field">
          <label class="profile-field__label">Type your email to confirm</label>
          <input type="email" class="profile-field__input" id="delete-confirm-email" placeholder="your@email.com" autocomplete="off">
        </div>
        <div class="profile-field" id="delete-password-field">
          <label class="profile-field__label">Enter your password</label>
          <input type="password" class="profile-field__input" id="delete-confirm-password" placeholder="Your password" autocomplete="current-password">
        </div>
        <div class="profile-modal__error" id="delete-error"></div>
      </div>
      <div class="profile-modal__footer">
        <button class="profile-modal__btn secondary" id="delete-cancel-btn">Cancel</button>
        <button class="profile-modal__btn danger" id="delete-confirm-btn" disabled>Delete My Account</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../shared/js/firebase-config.js"></script>
  <script src="../shared/js/auth.js"></script>
  <script src="../shared/js/rbac.js"></script>
  <script src="../shared/js/data-service.js"></script>
  <script src="../shared/js/notification-service.js"></script>

  <script>
    // =======================================================================
    // SETTINGS PAGE CONTROLLER
    // =======================================================================

    const SettingsPage = {
      currentUser: null,

      // ‚îÄ‚îÄ Initialize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async init() {
        const loadingScreen = document.getElementById('auth-loading');
        const dashboardContent = document.getElementById('dashboard-content');

        if (!window.FirebaseApp.init()) {
          console.error('Firebase initialization failed');
          loadingScreen.innerHTML = '<div class="loading-content"><p>Error loading. Please refresh.</p></div>';
          return;
        }

        window.AuthService.init();
        this.currentUser = await window.AuthService.waitForAuthState();

        if (!this.currentUser) {
          window.AuthService.setRedirectUrl(window.location.href);
          window.location.href = '../auth/login.html';
          return;
        }

        // Show dashboard
        loadingScreen.classList.add('hidden');
        dashboardContent.classList.add('ready');

        // Setup UI
        this.setupSidebar();
        this.setupLogout();
        this.setupComingSoon();

        // Check admin
        if (window.RBACService) {
          const isAdmin = await window.RBACService.hasRole('admin');
          if (isAdmin) {
            document.getElementById('admin-section').style.display = 'block';
          }
        }

        // Load sidebar user info
        this.loadSidebarUserInfo(this.currentUser);
        window.NotificationService.init();

        // Load settings data
        this.loadAccountInfo(this.currentUser);
        await this.loadNotificationPrefs();

        // Setup interactions
        this.loadProfilePicture(this.currentUser);
        this.setupProfilePictureUpload();
        this.setupDisplayNameEdit();
        this.setupChangePassword();
        this.setupDeleteAccount();
        this.setupNotificationPrefsSave();
        this.loadAppearanceSettings();
        this.setupThemeToggle();
        this.setupFontSize();
        this.setupAccentColor();
        await this.loadFeedSettings();
        this.setupFeedSettingsSave();

        // Load streak for sidebar
        try {
          const stats = await window.DataService.getUserStats();
          if (stats) {
            document.getElementById('user-streak').textContent = stats.currentStreak || 0;
          }
        } catch (e) { console.log('Could not load streak:', e); }

        // Animate
        anime({
          targets: '.glass-card',
          opacity: [0, 1],
          translateY: [20, 0],
          delay: anime.stagger(100, { start: 200 }),
          easing: 'easeOutCubic',
          duration: 600
        });

        // Auth change listener
        window.AuthService.onAuthStateChanged((user) => {
          if (!user) window.location.href = '../auth/login.html';
        });
      },

      // ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      loadSidebarUserInfo(user) {
        const displayName = user.displayName || user.email.split('@')[0];
        document.getElementById('user-name').textContent = displayName;
        const avatar = document.getElementById('user-avatar');
        if (user.photoURL) {
          avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
        } else {
          avatar.textContent = displayName.charAt(0).toUpperCase();
        }
      },

      setupSidebar() {
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('sidebar-toggle');
        const overlay = document.getElementById('sidebar-overlay');
        const mobileBtn = document.getElementById('mobile-menu-btn');

        toggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        if (localStorage.getItem('sidebarCollapsed') === 'true') {
          sidebar.classList.add('collapsed');
        }

        mobileBtn.addEventListener('click', () => {
          sidebar.classList.add('open');
        });

        overlay.addEventListener('click', () => {
          sidebar.classList.remove('open');
        });
      },

      setupLogout() {
        document.getElementById('logout-link').addEventListener('click', async (e) => {
          e.preventDefault();
          await window.AuthService.logout();
          window.location.href = '../index.html';
        });
      },

      // ‚îÄ‚îÄ Account Info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      loadAccountInfo(user) {
        document.getElementById('edit-display-name').value = user.displayName || '';
        document.getElementById('display-email').textContent = user.email;
      },

      // ‚îÄ‚îÄ Profile Picture ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      loadProfilePicture(user) {
        const preview = document.getElementById('avatar-preview');
        const removeBtn = document.getElementById('avatar-remove-btn');
        if (user.photoURL) {
          preview.innerHTML = `<img src="${user.photoURL}" alt="Profile picture">`;
          removeBtn.style.display = 'inline-flex';
        } else {
          const name = user.displayName || user.email?.split('@')[0] || '?';
          preview.textContent = name.charAt(0).toUpperCase();
          removeBtn.style.display = 'none';
        }
      },

      setupProfilePictureUpload() {
        const fileInput = document.getElementById('avatar-file-input');
        const uploadBtn = document.getElementById('avatar-upload-btn');
        const removeBtn = document.getElementById('avatar-remove-btn');
        const preview = document.getElementById('avatar-preview');
        const progress = document.getElementById('avatar-progress');
        const progressFill = document.getElementById('avatar-progress-fill');

        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // Validate
          const maxSize = 2 * 1024 * 1024; // 2MB
          if (file.size > maxSize) {
            showSaveToast('Image must be under 2MB');
            fileInput.value = '';
            return;
          }
          if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
            showSaveToast('Please upload a JPG, PNG, or WebP image');
            fileInput.value = '';
            return;
          }

          // Instant local preview (optimistic UI)
          const localURL = URL.createObjectURL(file);
          preview.innerHTML = `<img src="${localURL}" alt="Profile picture">`;
          removeBtn.style.display = 'inline-flex';
          const sidebarAvatar = document.getElementById('user-avatar');
          if (sidebarAvatar) {
            sidebarAvatar.innerHTML = `<img src="${localURL}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
          }

          uploadBtn.disabled = true;
          uploadBtn.textContent = 'Saving...';
          progress.classList.add('active');
          progressFill.style.width = '0%';

          try {
            const user = firebase.auth().currentUser;
            const storage = firebase.storage();
            const ext = file.name.split('.').pop();
            const ref = storage.ref(`avatars/${user.uid}/profile.${ext}`);

            const uploadTask = ref.put(file);

            uploadTask.on('state_changed',
              (snapshot) => {
                const pct = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressFill.style.width = pct + '%';
              },
              (error) => {
                console.error('Upload error:', error);
                showSaveToast('Upload failed. Please try again.');
                // Revert preview on failure
                SettingsPage.loadProfilePicture(firebase.auth().currentUser);
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'üì∑ Upload Photo';
                progress.classList.remove('active');
              },
              async () => {
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                // Update Firebase Auth profile + Firestore in parallel
                const db = window.FirebaseApp.getDb();
                await Promise.all([
                  user.updateProfile({ photoURL: downloadURL }),
                  db.collection('users').doc(user.uid).update({
                    photoURL: downloadURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                  })
                ]);

                // Swap local blob URL for the permanent one
                preview.innerHTML = `<img src="${downloadURL}" alt="Profile picture">`;
                if (sidebarAvatar) {
                  sidebarAvatar.innerHTML = `<img src="${downloadURL}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
                }
                URL.revokeObjectURL(localURL);

                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'üì∑ Upload Photo';
                progress.classList.remove('active');
                fileInput.value = '';
                showSaveToast('Profile picture saved!');
              }
            );
          } catch (err) {
            console.error('Error uploading avatar:', err);
            showSaveToast('Upload failed. Please try again.');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = 'üì∑ Upload Photo';
            progress.classList.remove('active');
          }
        });

        removeBtn.addEventListener('click', async () => {
          removeBtn.disabled = true;
          removeBtn.textContent = 'Removing...';

          try {
            const user = firebase.auth().currentUser;

            // Remove from Auth profile
            await user.updateProfile({ photoURL: '' });

            // Remove from Firestore
            const db = window.FirebaseApp.getDb();
            await db.collection('users').doc(user.uid).update({
              photoURL: firebase.firestore.FieldValue.delete(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Try to delete from Storage
            try {
              const storage = firebase.storage();
              const extensions = ['jpg', 'jpeg', 'png', 'webp'];
              for (const ext of extensions) {
                try {
                  await storage.ref(`avatars/${user.uid}/profile.${ext}`).delete();
                } catch (e) { /* file may not exist with this extension */ }
              }
            } catch (e) { console.log('Could not delete storage file:', e); }

            // Update UI
            const name = user.displayName || user.email?.split('@')[0] || '?';
            preview.textContent = name.charAt(0).toUpperCase();
            preview.querySelector('img')?.remove();
            removeBtn.style.display = 'none';

            // Update sidebar avatar
            const sidebarAvatar = document.getElementById('user-avatar');
            if (sidebarAvatar) {
              sidebarAvatar.textContent = name.charAt(0).toUpperCase();
            }

            showSaveToast('Profile picture removed');
          } catch (err) {
            console.error('Error removing avatar:', err);
            showSaveToast('Failed to remove picture');
          } finally {
            removeBtn.disabled = false;
            removeBtn.innerHTML = 'üóëÔ∏è Remove';
          }
        });
      },

      // ‚îÄ‚îÄ Display Name Edit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      setupDisplayNameEdit() {
        const saveBtn = document.getElementById('save-display-name');
        const input = document.getElementById('edit-display-name');

        saveBtn.addEventListener('click', async () => {
          const newName = input.value.trim();
          if (!newName) return;

          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';

          try {
            const user = firebase.auth().currentUser;
            await user.updateProfile({ displayName: newName });

            const db = window.FirebaseApp.getDb();
            await db.collection('users').doc(user.uid).update({
              displayName: newName,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('user-name').textContent = newName;
            showSaveToast('Display name updated');
          } catch (e) {
            console.error('Error updating display name:', e);
            showSaveToast('Error updating name');
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
          }
        });
      },

      // ‚îÄ‚îÄ Change Password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      setupChangePassword() {
        const modal = document.getElementById('password-modal');
        const openBtn = document.getElementById('change-password-btn');
        const closeBtn = document.getElementById('password-modal-close');
        const saveBtn = document.getElementById('password-save-btn');
        const resetEmailBtn = document.getElementById('password-reset-email-btn');
        const errorEl = document.getElementById('password-error');
        const providerInfo = document.getElementById('password-provider-info');
        const fieldsContainer = document.getElementById('password-fields');
        const newPasswordInput = document.getElementById('new-password');
        const strengthFill = document.getElementById('password-strength-fill');
        const strengthText = document.getElementById('password-strength-text');

        function openModal() {
          const user = firebase.auth().currentUser;
          const hasPassword = user.providerData.some(p => p.providerId === 'password');
          if (!hasPassword) {
            providerInfo.style.display = 'block';
            fieldsContainer.style.display = 'none';
            saveBtn.style.display = 'none';
          } else {
            providerInfo.style.display = 'none';
            fieldsContainer.style.display = 'block';
            saveBtn.style.display = 'inline-flex';
          }
          errorEl.textContent = '';
          modal.querySelectorAll('input').forEach(i => i.value = '');
          strengthFill.style.width = '0';
          strengthText.textContent = '';
          modal.classList.add('active');
        }

        function closeModal() { modal.classList.remove('active'); }

        openBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        // Password strength
        newPasswordInput.addEventListener('input', () => {
          const val = newPasswordInput.value;
          let score = 0;
          if (val.length >= 6) score++;
          if (val.length >= 10) score++;
          if (/[A-Z]/.test(val) && /[a-z]/.test(val)) score++;
          if (/[0-9]/.test(val)) score++;
          if (/[^A-Za-z0-9]/.test(val)) score++;

          const levels = [
            { width: '0%', color: 'transparent', text: '' },
            { width: '20%', color: '#ef5350', text: 'Weak' },
            { width: '40%', color: '#ffa726', text: 'Fair' },
            { width: '60%', color: '#ffa726', text: 'Fair' },
            { width: '80%', color: '#66bb6a', text: 'Good' },
            { width: '100%', color: '#43a047', text: 'Strong' }
          ];

          const level = val.length === 0 ? levels[0] : levels[Math.min(score, 5)];
          strengthFill.style.width = level.width;
          strengthFill.style.background = level.color;
          strengthText.textContent = level.text;
          strengthText.style.color = level.color;
        });

        // Visibility toggles
        modal.querySelectorAll('.profile-field__eye').forEach(btn => {
          btn.addEventListener('click', () => {
            const input = document.getElementById(btn.getAttribute('data-target'));
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
          });
        });

        // Send reset email
        resetEmailBtn.addEventListener('click', async () => {
          const user = firebase.auth().currentUser;
          if (!user?.email) return;
          resetEmailBtn.disabled = true;
          resetEmailBtn.textContent = 'Sending...';
          try {
            await firebase.auth().sendPasswordResetEmail(user.email);
            showSaveToast('Password reset email sent! Check your inbox.');
            closeModal();
          } catch (err) {
            errorEl.textContent = AuthService.getErrorMessage(err.code);
          } finally {
            resetEmailBtn.disabled = false;
            resetEmailBtn.textContent = 'Send Reset Email';
          }
        });

        // Update password
        saveBtn.addEventListener('click', async () => {
          errorEl.textContent = '';
          const currentPw = document.getElementById('current-password').value;
          const newPw = document.getElementById('new-password').value;
          const confirmPw = document.getElementById('confirm-password').value;

          if (!currentPw || !newPw || !confirmPw) { errorEl.textContent = 'Please fill in all fields.'; return; }
          if (newPw.length < 6) { errorEl.textContent = 'New password must be at least 6 characters.'; return; }
          if (newPw !== confirmPw) { errorEl.textContent = 'New passwords do not match.'; return; }

          saveBtn.disabled = true;
          saveBtn.textContent = 'Updating...';

          try {
            const user = firebase.auth().currentUser;
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPw);
            await user.reauthenticateWithCredential(credential);
            await user.updatePassword(newPw);
            showSaveToast('Password updated successfully!');
            closeModal();
          } catch (err) {
            errorEl.textContent = err.code === 'auth/wrong-password'
              ? 'Current password is incorrect.'
              : AuthService.getErrorMessage(err.code);
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Update Password';
          }
        });
      },

      // ‚îÄ‚îÄ Delete Account ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      setupDeleteAccount() {
        const modal = document.getElementById('delete-modal');
        const openBtn = document.getElementById('delete-account-btn');
        const closeBtn = document.getElementById('delete-modal-close');
        const cancelBtn = document.getElementById('delete-cancel-btn');
        const confirmBtn = document.getElementById('delete-confirm-btn');
        const emailInput = document.getElementById('delete-confirm-email');
        const passwordInput = document.getElementById('delete-confirm-password');
        const passwordField = document.getElementById('delete-password-field');
        const errorEl = document.getElementById('delete-error');

        function openModal() {
          const user = firebase.auth().currentUser;
          const hasPassword = user.providerData.some(p => p.providerId === 'password');
          passwordField.style.display = hasPassword ? 'block' : 'none';
          errorEl.textContent = '';
          emailInput.value = '';
          passwordInput.value = '';
          confirmBtn.disabled = true;
          modal.classList.add('active');
        }

        function closeModal() { modal.classList.remove('active'); }

        openBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        emailInput.addEventListener('input', () => {
          const user = firebase.auth().currentUser;
          confirmBtn.disabled = emailInput.value.trim().toLowerCase() !== user.email.toLowerCase();
        });

        confirmBtn.addEventListener('click', async () => {
          errorEl.textContent = '';
          const user = firebase.auth().currentUser;

          if (emailInput.value.trim().toLowerCase() !== user.email.toLowerCase()) {
            errorEl.textContent = 'Email does not match your account.';
            return;
          }

          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Deleting...';

          try {
            const hasPassword = user.providerData.some(p => p.providerId === 'password');
            if (hasPassword) {
              const pw = passwordInput.value;
              if (!pw) {
                errorEl.textContent = 'Please enter your password.';
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Delete My Account';
                return;
              }
              const credential = firebase.auth.EmailAuthProvider.credential(user.email, pw);
              await user.reauthenticateWithCredential(credential);
            } else {
              const provider = new firebase.auth.GoogleAuthProvider();
              await user.reauthenticateWithPopup(provider);
            }

            const db = window.FirebaseApp.getDb();
            const uid = user.uid;
            const subcollections = ['courseProgress', 'notificationPrefs', 'notifications'];
            for (const sub of subcollections) {
              try {
                const snap = await db.collection('users').doc(uid).collection(sub).get();
                const batch = db.batch();
                snap.docs.forEach(doc => batch.delete(doc.ref));
                if (snap.docs.length > 0) await batch.commit();
              } catch (e) { console.log(`Could not delete subcollection ${sub}:`, e); }
            }

            await db.collection('users').doc(uid).delete();
            await user.delete();
            window.location.href = '../index.html';
          } catch (err) {
            let msg = 'Failed to delete account. Please try again.';
            if (err.code === 'auth/wrong-password') msg = 'Incorrect password.';
            else if (err.code === 'auth/requires-recent-login') msg = 'Session expired. Please log out, log back in, and try again.';
            else if (err.code === 'auth/popup-closed-by-user') msg = 'Re-authentication cancelled.';
            errorEl.textContent = msg;
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Delete My Account';
          }
        });
      },

      // ‚îÄ‚îÄ Notification Preferences ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async loadNotificationPrefs() {
        try {
          if (!window.DataService?.getNotificationPrefs) return;
          const prefs = await window.DataService.getNotificationPrefs();
          if (!prefs) return;

          document.getElementById('pref-email-digest').checked = prefs.email || false;
          document.getElementById('pref-push-notif').checked = prefs.push || false;
          document.getElementById('pref-frequency').value = prefs.frequency || 'daily';
          document.getElementById('pref-topic-progress').checked = prefs.topics?.progress ?? true;
          document.getElementById('pref-topic-streaks').checked = prefs.topics?.streaks ?? true;
        } catch (e) {
          console.error('Error loading notification prefs:', e);
        }
      },

      setupNotificationPrefsSave() {
        let debounceTimer = null;
        const inputs = [
          document.getElementById('pref-email-digest'),
          document.getElementById('pref-push-notif'),
          document.getElementById('pref-frequency'),
          document.getElementById('pref-topic-progress'),
          document.getElementById('pref-topic-streaks')
        ];

        inputs.forEach(el => {
          if (!el) return;
          el.addEventListener('change', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
              try {
                const updatedPrefs = {
                  email: document.getElementById('pref-email-digest').checked,
                  push: document.getElementById('pref-push-notif').checked,
                  frequency: document.getElementById('pref-frequency').value,
                  topics: {
                    progress: document.getElementById('pref-topic-progress').checked,
                    streaks: document.getElementById('pref-topic-streaks').checked,
                    admin: true
                  }
                };
                if (window.DataService?.updateNotificationPrefs) {
                  await window.DataService.updateNotificationPrefs(updatedPrefs);
                }
                showSaveToast('Preferences saved');
              } catch (e) {
                console.error('Error saving notification prefs:', e);
              }
            }, 500);
          });
        });
      },

      // ‚îÄ‚îÄ Appearance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      loadAppearanceSettings() {
        const theme = localStorage.getItem('theme') || 'dark';
        const fontSize = localStorage.getItem('fontSize') || 'medium';
        const accentColor = localStorage.getItem('accentColor') || '#7986cb';

        document.querySelectorAll('.theme-toggle-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.theme === theme);
        });
        document.querySelectorAll('.font-size-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.size === fontSize);
        });
        document.querySelectorAll('.color-swatch').forEach(swatch => {
          swatch.classList.toggle('active', swatch.dataset.color === accentColor);
        });
      },

      setupThemeToggle() {
        document.querySelectorAll('.theme-toggle-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const theme = btn.dataset.theme;
            document.querySelectorAll('.theme-toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (theme === 'light') {
              document.documentElement.setAttribute('data-theme', 'light');
            } else {
              document.documentElement.removeAttribute('data-theme');
            }

            localStorage.setItem('theme', theme);
            try {
              const user = firebase.auth().currentUser;
              if (user) {
                const db = window.FirebaseApp.getDb();
                await db.collection('users').doc(user.uid).update({ 'settings.theme': theme });
              }
            } catch (e) { console.log('Could not save theme:', e); }
            showSaveToast('Theme updated');
          });
        });
      },

      setupFontSize() {
        document.querySelectorAll('.font-size-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const size = btn.dataset.size;
            document.querySelectorAll('.font-size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (size === 'small') document.documentElement.style.fontSize = '14px';
            else if (size === 'large') document.documentElement.style.fontSize = '18px';
            else document.documentElement.style.fontSize = '';

            localStorage.setItem('fontSize', size);
            try {
              const user = firebase.auth().currentUser;
              if (user) {
                const db = window.FirebaseApp.getDb();
                await db.collection('users').doc(user.uid).update({ 'settings.fontSize': size });
              }
            } catch (e) { console.log('Could not save fontSize:', e); }
            showSaveToast('Font size updated');
          });
        });
      },

      setupAccentColor() {
        document.querySelectorAll('.color-swatch').forEach(swatch => {
          swatch.addEventListener('click', async () => {
            const color = swatch.dataset.color;
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            swatch.classList.add('active');
            document.documentElement.style.setProperty('--accent-primary', color);

            localStorage.setItem('accentColor', color);
            try {
              const user = firebase.auth().currentUser;
              if (user) {
                const db = window.FirebaseApp.getDb();
                await db.collection('users').doc(user.uid).update({ 'settings.accentColor': color });
              }
            } catch (e) { console.log('Could not save accentColor:', e); }
            showSaveToast('Accent color updated');
          });
        });
      },

      // ‚îÄ‚îÄ Feed & Post Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async loadFeedSettings() {
        try {
          const user = firebase.auth().currentUser;
          if (!user) return;
          const db = window.FirebaseApp.getDb();
          const doc = await db.collection('users').doc(user.uid).get();
          const settings = doc.data()?.settings || {};

          // Feed preferences
          document.getElementById('feed-show-code').checked = settings.feedShowCode ?? true;
          document.getElementById('feed-autoplay-milestones').checked = settings.feedAutoplayMilestones ?? true;
          document.getElementById('feed-default-view').value = settings.feedDefaultView || 'trending';

          // Post defaults
          document.getElementById('post-default-type').value = settings.postDefaultType || 'status';
          document.getElementById('post-allow-comments').checked = settings.postAllowComments ?? true;
          document.getElementById('post-show-activity').checked = settings.postShowActivity ?? true;

          // Privacy
          document.getElementById('privacy-public-profile').checked = settings.privacyPublicProfile ?? true;
          document.getElementById('privacy-show-leaderboard').checked = settings.privacyShowLeaderboard ?? true;
          document.getElementById('privacy-allow-mentions').checked = settings.privacyAllowMentions ?? true;
        } catch (e) {
          console.error('Error loading feed settings:', e);
        }
      },

      setupFeedSettingsSave() {
        let debounceTimer = null;

        const feedInputs = [
          'feed-show-code', 'feed-autoplay-milestones', 'feed-default-view',
          'post-default-type', 'post-allow-comments', 'post-show-activity',
          'privacy-public-profile', 'privacy-show-leaderboard', 'privacy-allow-mentions'
        ];

        feedInputs.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('change', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
              try {
                const user = firebase.auth().currentUser;
                if (!user) return;
                const db = window.FirebaseApp.getDb();

                const updates = {
                  'settings.feedShowCode': document.getElementById('feed-show-code').checked,
                  'settings.feedAutoplayMilestones': document.getElementById('feed-autoplay-milestones').checked,
                  'settings.feedDefaultView': document.getElementById('feed-default-view').value,
                  'settings.postDefaultType': document.getElementById('post-default-type').value,
                  'settings.postAllowComments': document.getElementById('post-allow-comments').checked,
                  'settings.postShowActivity': document.getElementById('post-show-activity').checked,
                  'settings.privacyPublicProfile': document.getElementById('privacy-public-profile').checked,
                  'settings.privacyShowLeaderboard': document.getElementById('privacy-show-leaderboard').checked,
                  'settings.privacyAllowMentions': document.getElementById('privacy-allow-mentions').checked,
                };

                await db.collection('users').doc(user.uid).update(updates);
                showSaveToast('Feed settings saved');
              } catch (e) {
                console.error('Error saving feed settings:', e);
              }
            }, 500);
          });
        });
      },

      // ‚îÄ‚îÄ Coming Soon Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      setupComingSoon() {
        const toast = document.createElement('div');
        toast.className = 'coming-soon-toast';
        toast.innerHTML = `
          <span class="coming-soon-toast__icon">üöß</span>
          <div class="coming-soon-toast__content">
            <span class="coming-soon-toast__title">Coming Soon!</span>
            <span class="coming-soon-toast__message"></span>
          </div>
        `;
        document.body.appendChild(toast);
        let toastTimeout = null;

        document.querySelectorAll('.coming-soon-trigger').forEach(trigger => {
          trigger.addEventListener('click', (e) => {
            e.preventDefault();
            const featureName = trigger.getAttribute('data-feature') || 'This feature';
            const message = toast.querySelector('.coming-soon-toast__message');
            message.textContent = `${featureName} is under development. Stay tuned!`;
            clearTimeout(toastTimeout);
            toast.classList.remove('show');
            requestAnimationFrame(() => {
              toast.classList.add('show');
              toastTimeout = setTimeout(() => toast.classList.remove('show'), 3000);
            });
          });
        });
      }
    };

    // =======================================================================
    // GLOBAL TOAST
    // =======================================================================

    const saveToastEl = document.createElement('div');
    saveToastEl.className = 'save-toast';
    saveToastEl.innerHTML = `
      <span class="save-toast__icon">‚úÖ</span>
      <span class="save-toast__message"></span>
    `;
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(saveToastEl));

    let saveToastTimeout = null;
    function showSaveToast(message) {
      saveToastEl.querySelector('.save-toast__message').textContent = message;
      clearTimeout(saveToastTimeout);
      saveToastEl.classList.remove('show');
      requestAnimationFrame(() => {
        saveToastEl.classList.add('show');
        saveToastTimeout = setTimeout(() => saveToastEl.classList.remove('show'), 2500);
      });
    }

    // =======================================================================
    // INIT
    // =======================================================================
    document.addEventListener('DOMContentLoaded', () => SettingsPage.init());
  </script>
</body>
</html>
