<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | AutoNateAI Learning Hub</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- Critical styles - must load before body renders -->
  <style>
    /* Hide content until auth is confirmed */
    .dashboard { display: none !important; }
    .dashboard.ready { display: flex !important; }
    
    /* Loading screen - shown immediately */
    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0a0a0f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .auth-loading.hidden { display: none; }
    .loading-content { text-align: center; color: #e8e8f0; }
    .loading-icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(121, 134, 203, 0.3);
      border-top-color: #7986cb;
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  
  <!-- Theme loader (before CSS to prevent flash) -->
  <script src="../shared/js/theme-loader.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="../shared/css/dashboard.css">
  <link rel="stylesheet" href="../shared/css/analytics.css">

  <!-- Coming Soon Styles -->
  <style>
    .coming-soon-badge {
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: linear-gradient(135deg, rgba(121, 134, 203, 0.3), rgba(159, 122, 234, 0.3));
      color: #b8bfff;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
      white-space: nowrap;
    }

    .coming-soon-link {
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }
    .coming-soon-link:hover {
      opacity: 1;
    }

    .coming-soon-toast {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: rgba(15, 15, 25, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(121, 134, 203, 0.3);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      color: #e8e8f0;
      font-family: var(--font-body, 'Inter', sans-serif);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 40px rgba(121, 134, 203, 0.1);
      transform: translateX(120%);
      opacity: 0;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
      max-width: 320px;
    }
    .coming-soon-toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .coming-soon-toast__icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    .coming-soon-toast__content {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .coming-soon-toast__title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #b8bfff;
    }
    .coming-soon-toast__message {
      font-size: 0.8rem;
      color: rgba(232, 232, 240, 0.7);
    }
  </style>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  
  <!-- Loading Screen -->
  <div class="auth-loading" id="auth-loading">
    <div class="loading-content">
      <div class="loading-icon">üèõÔ∏è</div>
      <div class="loading-spinner"></div>
      <p>Loading your dashboard...</p>
    </div>
  </div>
  
  <div class="dashboard" id="dashboard-content">
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="../index.html" class="sidebar-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <span class="logo-text">AutoNateAI</span>
      </a>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">Main</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="index.html" class="nav-link active">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">
                <span class="nav-icon">üìö</span>
                <span class="nav-text">Course Library</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="challenges.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span class="nav-text">Daily Challenges</span>
                <span class="nav-badge">3</span>
              </a>
            </li>
          </ul>
        </div>
        
        <div class="nav-section">
          <span class="nav-section-title">Learning</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="progress.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">My Progress</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="achievements.html" class="nav-link">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-text">Achievements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link coming-soon-link" data-feature="Notes">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">Notes</span>
                <span class="coming-soon-badge">Soon</span>
              </a>
            </li>
          </ul>
        </div>
        
        <div class="nav-section">
          <span class="nav-section-title">Community</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="https://discord.gg/Me5N8tCdkC" target="_blank" class="nav-link">
                <span class="nav-icon">üí¨</span>
                <span class="nav-text">Discord</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link coming-soon-link" data-feature="Leaderboard">
                <span class="nav-icon">üèÖ</span>
                <span class="nav-text">Leaderboard</span>
                <span class="coming-soon-badge">Soon</span>
              </a>
            </li>
          </ul>
        </div>
        
        <div class="nav-section">
          <span class="nav-section-title">Account</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="profile.html" class="nav-link">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="settings.html" class="nav-link">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
        
        <!-- Admin Section (hidden by default, shown for admins) -->
        <div class="nav-section" id="admin-section" style="display: none;">
          <span class="nav-section-title" style="color: #f44336;">Admin</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="../admin/" class="nav-link">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">Admin Dashboard</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>
      
      <div class="sidebar-user">
        <div class="user-card" id="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-streak">
              <span>üî•</span>
              <span id="user-streak">0</span> day streak
            </div>
          </div>
        </div>
      </div>
      
      <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </aside>
    
    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
          <h1 class="page-title">Dashboard</h1>
        </div>
        
        <div class="header-right">
          <div class="header-search">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <input type="text" class="search-input" placeholder="Search courses, lessons...">
          </div>
          
          <div class="header-actions">
            <button class="action-btn" id="notification-btn" title="Notifications">
              üîî
              <span class="notification-dot" id="notification-dot"></span>
              <span class="notification-count" id="notification-count"></span>
            </button>
          </div>
        </div>
      </header>

      <div class="notification-panel" id="notification-panel" aria-hidden="true">
        <div class="notification-panel-header">
          <div>
            <div class="notification-panel-title">Notifications</div>
            <div class="notification-panel-subtitle">Your latest updates</div>
          </div>
          <button class="notification-panel-action" id="notification-mark-all">Mark all read</button>
        </div>
        <div class="notification-panel-tools">
          <button class="notification-panel-test" id="notification-test" style="display: none;">Create sample notifications (Admin)</button>
        </div>
        <div class="notification-tabs">
          <button class="notification-tab active" data-notification-filter="all">All</button>
          <button class="notification-tab" data-notification-filter="unread">Unread</button>
        </div>
        <div class="notification-list" id="notification-list"></div>
        <div class="notification-preferences">
          <div class="notification-pref">
            <span>In-app</span>
            <input type="checkbox" checked disabled>
          </div>
          <div class="notification-pref">
            <span>Remove when read</span>
            <input type="checkbox" id="pref-remove-read">
          </div>
          <div class="notification-pref">
            <span>Email digest</span>
            <input type="checkbox" id="pref-email">
          </div>
          <div class="notification-pref">
            <span>Push (optional)</span>
            <input type="checkbox" id="pref-push">
          </div>
          <div class="notification-pref">
            <span>Frequency</span>
            <select id="pref-frequency">
              <option value="instant">Instant</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="content-area">
        
        <!-- Welcome Message -->
        <div class="welcome-message" id="welcome-message" style="margin-bottom: 2rem;">
          <h2 style="font-family: var(--font-display); font-size: 1.75rem; margin-bottom: 0.5rem;">
            Welcome back, <span id="welcome-name">Architect</span>! üëã
          </h2>
          <p style="color: var(--text-secondary);">Ready to continue your journey with the Three Forces?</p>
        </div>
        
        <!-- Component-Based Analytics Section - 3x3 Grid -->
        <section class="analytics-section" id="component-analytics-section" style="display: none;">
          
          <!-- Glassmorphism Styles -->
          <style>
            .glass-card {
              background: rgba(255, 255, 255, 0.03);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              border: 1px solid rgba(255, 255, 255, 0.08);
              border-radius: 20px;
              padding: 1.25rem;
              position: relative;
              overflow: hidden;
              transition: all 0.3s ease;
            }
            
            .glass-card::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 1px;
              background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent
              );
            }
            
            .glass-card:hover {
              background: rgba(255, 255, 255, 0.05);
              border-color: rgba(255, 255, 255, 0.12);
              transform: translateY(-2px);
              box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 0 60px rgba(99, 102, 241, 0.1);
            }
            
            .glass-card--overflow {
              overflow: visible;
            }
            
            .glass-card__title {
              font-size: 0.75rem;
              font-weight: 500;
              color: rgba(255, 255, 255, 0.5);
              text-transform: uppercase;
              letter-spacing: 0.5px;
              margin-bottom: 1rem;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            
            .glass-card__title span {
              font-size: 1rem;
            }
            
            .analytics-grid-glass {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 1.25rem;
              margin-bottom: 1.25rem;
            }
            
            @media (max-width: 1024px) {
              .analytics-grid-glass {
                grid-template-columns: repeat(2, 1fr);
              }
            }
            
            @media (max-width: 640px) {
              .analytics-grid-glass {
                grid-template-columns: 1fr;
              }
            }
          </style>
          
          <!-- 3x3 Analytics Grid -->
          <div class="analytics-grid-glass">
            
            <!-- 1. Course Breakdown -->
            <div class="glass-card">
              <h4 class="glass-card__title"><span>üìö</span> Courses</h4>
              <div id="course-breakdown-container" style="height: 140px;"></div>
            </div>
            
            <!-- 2. Time Spent (swapped with Weekly Pattern) -->
            <div class="glass-card">
              <h4 class="glass-card__title"><span>‚è±Ô∏è</span> Time Spent</h4>
              <div id="time-distribution-container" style="height: 140px;"></div>
            </div>
            
            <!-- 3. Streak -->
            <div class="glass-card">
              <div id="streak-display-container" style="height: 160px;"></div>
            </div>
            
            <!-- 4. Weekly Pattern (swapped with Time Spent) -->
            <div class="glass-card">
              <h4 class="glass-card__title"><span>üìä</span> Weekly Pattern</h4>
              <div id="weekly-chart-container" style="height: 140px;"></div>
            </div>
            
            <!-- 5. Skill Radar (swapped with Accuracy) -->
            <div class="glass-card glass-card--overflow">
              <h4 class="glass-card__title"><span>üß†</span> Skills</h4>
              <div id="skill-radar-container" style="height: 160px; overflow: visible;"></div>
            </div>
            
            <!-- 6. Progress Over Time (swapped with Time Spent) -->
            <div class="glass-card">
              <h4 class="glass-card__title"><span>üìà</span> Progress</h4>
              <div id="progress-chart-container" style="height: 140px;"></div>
            </div>
            
            <!-- 7. Accuracy Trend (swapped with Skills) -->
            <div class="glass-card">
              <h4 class="glass-card__title"><span>üéØ</span> Accuracy</h4>
              <div id="accuracy-chart-container" style="height: 140px;"></div>
            </div>
            
            <!-- 8. Activity Heatmap (swapped with Courses) -->
            <div class="glass-card">
              <h4 class="glass-card__title"><span>üìÖ</span> Activity</h4>
              <div id="activity-heatmap-container" style="height: 140px; overflow: hidden;"></div>
            </div>
            
            <!-- 9. Activity Types -->
            <div class="glass-card">
              <h4 class="glass-card__title"><span>üéÆ</span> Activity Types</h4>
              <div id="activity-types-container" style="height: 140px; display: flex; align-items: center; justify-content: center;"></div>
            </div>
            
          </div>
          
          <!-- Journey Timeline (full width) -->
          <div class="glass-card" style="margin-bottom: 1.25rem;">
            <h4 class="glass-card__title"><span>üó∫Ô∏è</span> Learning Journey</h4>
            <div id="progress-timeline-container" style="min-height: 180px;"></div>
          </div>
          
          <!-- Recommendations (full width) -->
          <div class="glass-card">
            <h4 class="glass-card__title"><span>üí°</span> Recommended Next Steps</h4>
            <div id="recommendations-container"></div>
          </div>
          
          <!-- Hidden containers for backward compatibility -->
          <div id="metrics-row" style="display: none;"></div>
        </section>
        
        <!-- Continue Learning Section -->
        <div class="section-header">
          <h3 class="section-title">Continue Learning</h3>
          <a href="courses.html" class="section-action">
            View All Courses ‚Üí
          </a>
        </div>
        
        <div class="courses-grid" id="courses-grid">
          <!-- Courses will be loaded dynamically -->
          <div class="empty-state" id="empty-courses">
            <div class="empty-icon">üìö</div>
            <h3 class="empty-title">No courses yet</h3>
            <p class="empty-desc">Start your architect journey by enrolling in a course!</p>
            <a href="courses.html" class="empty-action">
              <span>Browse Courses</span>
              <span>‚Üí</span>
            </a>
          </div>
        </div>
        
      </div>
    </main>
    
  </div>
  
  <!-- Scripts -->
  <script src="../shared/js/firebase-config.js"></script>
  <script src="../shared/js/auth.js"></script>
  <script src="../shared/js/rbac.js"></script>
  <script src="../shared/js/data-service.js"></script>
  <script src="../shared/js/analytics-service.js"></script>
  <script src="../shared/js/notification-service.js"></script>
  
  <!-- Services (Agent 2/3) -->
  <script src="../shared/js/services/cache-service.js"></script>
  <script src="../shared/js/services/query-service.js"></script>
  <script src="../shared/js/services/analytics-service.js"></script>
  
  <!-- Analytics Components (Agent 4) -->
  <script src="../shared/js/components/analytics/metric-card.js"></script>
  <script src="../shared/js/components/analytics/skill-radar.js"></script>
  <script src="../shared/js/components/analytics/progress-timeline.js"></script>
  <script src="../shared/js/components/analytics/timeline-graph.js"></script>
  <script src="../shared/js/components/analytics/recommendation-card.js"></script>
  
  <!-- New Visual Components (3x3 Grid) -->
  <script src="../shared/js/components/analytics/activity-heatmap.js"></script>
  <script src="../shared/js/components/analytics/progress-chart.js"></script>
  <script src="../shared/js/components/analytics/weekly-chart.js"></script>
  <script src="../shared/js/components/analytics/streak-display.js"></script>
  <script src="../shared/js/components/analytics/accuracy-chart.js"></script>
  <script src="../shared/js/components/analytics/time-distribution-chart.js"></script>
  <script src="../shared/js/components/analytics/course-breakdown-chart.js"></script>
  <script src="../shared/js/components/analytics/activity-types-chart.js"></script>
  
  <script>
    // Course data
    const COURSES = {
      "endless-opportunities": {
        name: "Endless Opportunities",
        icon: "üöÄ",
        subtitle: "Start your tech journey with Grand Rapids Public Schools",
        link: "../endless-opportunities/week0-intro/"
      },
      apprentice: {
        name: "The Apprentice's Path",
        icon: "üåü",
        subtitle: "For Complete Beginners",
        link: "../apprentice/ch0-origins/"
      },
      undergrad: {
        name: "The Bridge to Industry",
        icon: "üéì",
        subtitle: "For CS Students",
        link: "../undergrad/ch0-origins/"
      },
      junior: {
        name: "The Junior Accelerator",
        icon: "üöÄ",
        subtitle: "For Junior Engineers",
        link: "../junior/ch0-origins/"
      },
      senior: {
        name: "The Senior Amplifier",
        icon: "üéØ",
        subtitle: "For Mid-to-Senior Engineers",
        link: "../senior/ch0-origins/"
      }
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('auth-loading');
      const dashboardContent = document.getElementById('dashboard-content');
      
      // Initialize Firebase
      if (!window.FirebaseApp.init()) {
        console.error('Firebase initialization failed');
        loadingScreen.innerHTML = '<div class="loading-content"><p>Error loading. Please refresh.</p></div>';
        return;
      }
      
      window.AuthService.init();
      
      // Wait for auth state to be determined (handles session restoration)
      const user = await window.AuthService.waitForAuthState();
      
      if (!user) {
        // Not logged in, redirect to login
        window.AuthService.setRedirectUrl(window.location.href);
        window.location.href = '../auth/login.html';
        return;
      }
      
      // User is logged in, show dashboard
      loadingScreen.classList.add('hidden');
      dashboardContent.classList.add('ready');
      
      let isAdminUser = false;
      const params = new URLSearchParams(window.location.search);
      const isTestEnabled = params.has('adminTest');

      // Check if user is admin and show admin section
      if (window.RBACService) {
        const isAdmin = await window.RBACService.hasRole('admin');
        if (isAdmin) {
          document.getElementById('admin-section').style.display = 'block';
          isAdminUser = true;
        }
      }
      
      // Setup UI interactions immediately so sidebar/nav is responsive
      setupSidebar();
      setupLogout();

      loadUserInfo(user);
      window.NotificationService.init();

      // Load data ‚Äî errors here won't block UI interactions
      try {
        await loadUserStats();
      } catch (e) { console.error('Error loading user stats:', e); }

      try {
        await loadEnrolledCourses();
      } catch (e) { console.error('Error loading enrolled courses:', e); }

      try {
        await loadAnalytics();
      } catch (e) { console.error('Error loading analytics:', e); }

      try {
        await maybeSeedNotificationTest();
      } catch (e) { console.error('Error seeding notification test:', e); }

      const testButton = document.getElementById('notification-test');
      if (isAdminUser) {
        setupNotificationTest();
        if (testButton) testButton.style.display = 'inline-flex';
      } else if (testButton) {
        testButton.style.display = 'none';
      }
      
      // Animate stats cards
      anime({
        targets: '.animate-in',
        opacity: [0, 1],
        translateY: [20, 0],
        delay: anime.stagger(100, { start: 200 }),
        easing: 'easeOutCubic',
        duration: 600
      });
      
      // Listen for subsequent auth changes (logout, etc)
      window.AuthService.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = '../auth/login.html';
        }
      });
    });
    
    // Load user info
    function loadUserInfo(user) {
      const displayName = user.displayName || user.email.split('@')[0];
      
      document.getElementById('user-name').textContent = displayName;
      document.getElementById('welcome-name').textContent = displayName.split(' ')[0];
      
      const avatar = document.getElementById('user-avatar');
      if (user.photoURL) {
        avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
      } else {
        avatar.textContent = displayName.charAt(0).toUpperCase();
      }
    }
    
    // Load user stats - now uses visual cards
    async function loadUserStats() {
      try {
        const stats = await window.DataService.getUserStats();
        
        if (stats) {
          // Update sidebar streak
          document.getElementById('user-streak').textContent = stats.currentStreak || 0;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    // Load enrolled courses
    async function loadEnrolledCourses() {
      try {
        const courses = await window.DataService.getEnrolledCourses();
        console.log('üìä Dashboard: Loaded courses from Firestore:', courses);
        
        const grid = document.getElementById('courses-grid');
        const emptyState = document.getElementById('empty-courses');
        
        if (courses.length === 0) {
          emptyState.style.display = 'block';
          return;
        }
        
        // Sort by most recent activity (lastActivity timestamp)
        const sortedCourses = courses.sort((a, b) => {
          const aTime = a.lastActivity?._seconds || a.lastActivity?.seconds || 0;
          const bTime = b.lastActivity?._seconds || b.lastActivity?.seconds || 0;
          return bTime - aTime; // Most recent first
        });
        
        // Take only the top 2 most recently active
        const recentCourses = sortedCourses.slice(0, 2);
        console.log('üìä Showing top 2 recent courses:', recentCourses.map(c => c.courseId || c.id));
        
        emptyState.style.display = 'none';
        grid.innerHTML = '';
        
        recentCourses.forEach(course => {
          const courseId = course.courseId || course.id;
          const courseInfo = COURSES[courseId] || course;
          const card = createCourseCard(course, courseInfo);
          grid.appendChild(card);
        });
        
        // Animate cards
        anime({
          targets: '.course-progress-card',
          opacity: [0, 1],
          translateY: [30, 0],
          delay: anime.stagger(100),
          easing: 'easeOutCubic',
          duration: 600
        });
        
      } catch (error) {
        console.error('Error loading courses:', error);
      }
    }
    
    // Create course progress card
    function createCourseCard(progress, courseInfo) {
      const courseId = progress.courseId || progress.id;
      
      const card = document.createElement('div');
      card.className = `course-progress-card ${courseId}`;
      
      // Use DataService for lesson structure and next lesson (single source of truth)
      const structure = window.DataService.getLessonsStructure(courseId);
      const totalLessons = structure.totalLessons;
      const lessonLabel = structure.lessonLabel;
      
      // Get completed count using DataService
      const displayCompletedLessons = window.DataService.getCompletedLessonsCount(progress, courseId);
      const progressPercent = Math.round((displayCompletedLessons / totalLessons) * 100);
      
      // Get next lesson info using DataService
      const nextLessonInfo = window.DataService.getNextLesson(progress, courseId);
      
      // Link to course dashboard
      const cardLink = `course.html?id=${courseId}`;
      
      card.innerHTML = `
        <a href="${cardLink}" class="course-card-link">
          <div class="course-banner"></div>
          <div class="course-content">
            <div class="course-header">
              <div class="course-icon">${courseInfo.icon}</div>
              <div class="course-meta">
                <div class="course-name">${courseInfo.name}</div>
                <div class="course-subtitle">${courseInfo.subtitle}</div>
              </div>
            </div>
            
            <div class="progress-section">
              <div class="progress-header">
                <span class="progress-label">${displayCompletedLessons}/${totalLessons} ${lessonLabel}s Complete</span>
                <span class="progress-percent">${progressPercent}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercent}%"></div>
              </div>
            </div>
            
            <div class="course-stats">
              <div class="course-stat">
                <div class="course-stat-value">${displayCompletedLessons}</div>
                <div class="course-stat-label">Completed</div>
              </div>
              <div class="course-stat">
                <div class="course-stat-value">${totalLessons - displayCompletedLessons}</div>
                <div class="course-stat-label">Remaining</div>
              </div>
              <div class="course-stat">
                <div class="course-stat-value">${formatTime(progress.totalTimeSpent || 0)}</div>
                <div class="course-stat-label">Time Spent</div>
              </div>
            </div>
            
            <span class="course-action">
              ${nextLessonInfo.allComplete ? 'View Course Dashboard ‚Üí' : `Continue: ${nextLessonInfo.lessonName} ‚Üí`}
            </span>
          </div>
        </a>
      `;
      
      return card;
    }
    
    // Format time
    function formatTime(seconds) {
      if (seconds < 60) return '< 1m';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      if (hours > 0) return `${hours}h`;
      return `${minutes}m`;
    }
    
    // Setup sidebar
    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      const overlay = document.getElementById('sidebar-overlay');
      const mobileBtn = document.getElementById('mobile-menu-btn');
      
      // Desktop toggle
      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });
      
      // Restore sidebar state
      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }
      
      // Mobile menu
      mobileBtn.addEventListener('click', () => {
        sidebar.classList.add('open');
      });
      
      overlay.addEventListener('click', () => {
        sidebar.classList.remove('open');
      });
    }
    
    // Setup logout
    function setupLogout() {
      document.getElementById('logout-link').addEventListener('click', async (e) => {
        e.preventDefault();
        await window.AuthService.logout();
        window.location.href = '../index.html';
      });
    }

    function setupNotificationTest() {
      const testBtn = document.getElementById('notification-test');
      if (!testBtn) return;

      testBtn.addEventListener('click', async () => {
        const sampleNotifications = [
          {
            type: 'course_progress',
            title: 'Course progress',
            body: 'Apprentice is now 50% complete.',
            source: 'progress',
            relatedId: 'apprentice',
            link: '../dashboard/course.html?id=apprentice',
            metadata: { progressPercent: 50 }
          },
          {
            type: 'lesson_halfway',
            title: 'Lesson halfway',
            body: 'The Origins is halfway complete.',
            source: 'progress',
            relatedId: 'ch0-origins',
            link: '../apprentice/ch0-origins/',
            metadata: { progressPercent: 50 }
          },
          {
            type: 'daily_challenge_complete',
            title: 'Daily challenge complete',
            body: 'You completed today\'s challenge. Keep the streak alive.',
            source: 'challenge',
            relatedId: 'challenge-1',
            link: '../challenges.html'
          },
          {
            type: 'streak_broken',
            title: 'Streak reset',
            body: 'Your 7-day streak ended. Start a new one today.',
            source: 'progress',
            relatedId: '7',
            link: '../dashboard/index.html'
          },
          {
            type: 'time_milestone',
            title: 'Time milestone',
            body: 'You\'ve spent 5 hours learning in Apprentice.',
            source: 'progress',
            relatedId: 'apprentice',
            link: '../dashboard/course.html?id=apprentice',
            metadata: { hours: 5 }
          },
          {
            type: 'first_activity',
            title: 'First activity',
            body: 'Nice start! Your first activity is complete.',
            source: 'activity',
            relatedId: 'activity-1',
            link: '../apprentice/ch0-origins/'
          },
          {
            type: 'activity_retry',
            title: 'Keep pushing',
            body: 'Three attempts on activity-1. Want a hint?',
            source: 'activity',
            relatedId: 'activity-1',
            link: '../apprentice/ch0-origins/'
          },
          {
            type: 'low_mastery',
            title: 'Need a boost?',
            body: 'Your recent quiz average is below 60%.',
            source: 'activity',
            relatedId: 'quiz',
            link: '../apprentice/ch0-origins/',
            metadata: { avgScore: 0.55 }
          },
          {
            type: 'high_mastery',
            title: 'Strong mastery',
            body: 'You\'re averaging 90%+ on quiz activities.',
            source: 'activity',
            relatedId: 'quiz',
            link: '../apprentice/ch0-origins/',
            metadata: { avgScore: 0.92 }
          },
          {
            type: 'course_enrolled',
            title: 'Course enrolled',
            body: 'You\'re enrolled in Apprentice.',
            source: 'progress',
            relatedId: 'apprentice',
            link: '../dashboard/course.html?id=apprentice'
          }
        ];

        for (const notification of sampleNotifications) {
          await window.DataService.createNotification(notification);
        }
      });
    }

    async function maybeSeedNotificationTest() {
      const params = new URLSearchParams(window.location.search);
      if (!params.has('notifTest')) return;

      const flagKey = `notifTestSeeded_${params.get('notifTest') || '1'}`;
      if (sessionStorage.getItem(flagKey)) return;
      sessionStorage.setItem(flagKey, 'true');

      await window.DataService.createNotification({
        type: 'test',
        title: 'Notification test',
        body: 'This is a seeded test notification.',
        source: 'system'
      });
    }
    
    // Animate counter from start to end
    function animateCounter(element, start, end, duration) {
      const startTime = performance.now();
      const diff = end - start;
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Ease out cubic
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(start + diff * eased);
        
        element.textContent = current;
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }
    
    // Load analytics after main data loads
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for main data to load first
      setTimeout(() => {
        loadComponentAnalytics();
      }, 500);
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMPONENT-BASED ANALYTICS (Agent 4)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let metricCards = [];
    let skillRadar = null;
    let progressTimeline = null;
    let recommendationList = null;
    
    async function loadComponentAnalytics() {
      const section = document.getElementById('component-analytics-section');
      if (!section) {
        console.warn('üìä Component analytics section not found');
        return;
      }
      
      // Check if components are available
      if (!window.MetricCard || !window.SkillRadar || !window.ProgressTimeline || !window.RecommendationList) {
        console.log('üìä Components not fully loaded, skipping component analytics');
        return;
      }
      
      const user = window.AuthService?.getUser();
      if (!user) {
        console.log('üìä No user, skipping component analytics');
        return;
      }
      
      console.log('üìä Loading component analytics for user:', user.uid);
      
      // Always show the section
      section.style.display = 'block';
      
      try {
        // Try to get server-computed analytics (use same service as Learning Insights)
        let analytics = null;
        if (window.AnalyticsService?.getUserAnalytics) {
          analytics = await window.AnalyticsService.getUserAnalytics();
          console.log('üìä Loaded analytics for Performance Overview:', analytics);
        }
        
        if (!analytics) {
          console.log('üìä No analytics data found, showing empty state');
        }
        
        // Render 3x3 grid components
        await Promise.all([
          renderActivityHeatmap(user.uid),
          renderWeeklyChart(analytics),
          renderStreakDisplay(analytics),
          renderProgressChart(user.uid),
          renderAccuracyChart(user.uid),
          renderTimeDistributionChart(user.uid),
          renderSkillRadar(analytics),
          renderCourseBreakdownChart(user.uid),
          renderActivityTypesChart(user.uid),
        ]);
        
        // Full-width components
        await renderProgressTimeline(user.uid);
        await renderRecommendations(user.uid, analytics);
        
        console.log('üìä 3x3 Grid analytics rendered successfully');
        
      } catch (error) {
        console.error('üìä Error loading component analytics:', error);
        renderErrorState(error);
      }
    }
    
    async function renderMetricCards(analytics, userId) {
      const container = document.getElementById('metrics-row');
      if (!container) return;
      
      container.innerHTML = '';
      metricCards = [];
      
      // Check if we have analytics data
      const hasData = analytics && analytics.summaryStats;
      
      // Get values from analytics (0 is valid, only show 0 if we have data)
      const overallScore = hasData ? (analytics.summaryStats.overallScore || 0) : null;
      const streak = analytics?.engagementPatterns?.currentStreak ?? null;
      const timeMinutes = hasData ? (analytics.summaryStats.totalTimeMinutes || 0) : null;
      const activitiesCompleted = hasData ? (analytics.summaryStats.activitiesCompleted || 0) : null;
      
      const cardConfigs = [
        { title: 'Overall Score', value: overallScore, icon: 'üéØ', format: 'number', colorScheme: 'primary', noData: overallScore === null },
        { title: 'Day Streak', value: streak ?? 0, icon: 'üî•', format: 'number', colorScheme: 'warning', noData: streak === null },
        { title: 'Time Spent', value: timeMinutes !== null ? Math.round(timeMinutes / 60) : 0, icon: '‚è±Ô∏è', format: 'hours', colorScheme: 'info', noData: timeMinutes === null },
        { title: 'Activities', value: activitiesCompleted ?? 0, icon: '‚úÖ', format: 'number', colorScheme: 'success', noData: activitiesCompleted === null }
      ];
      
      cardConfigs.forEach(config => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'metric-card-wrapper';
        container.appendChild(cardDiv);
        
        // If no data, show empty state message
        if (config.noData) {
          cardDiv.innerHTML = `
            <div class="metric-card metric-card--${config.colorScheme}" style="opacity: 0.6">
              <div class="metric-card__icon">${config.icon}</div>
              <div class="metric-card__value">--</div>
              <div class="metric-card__title">${config.title}</div>
              <div class="metric-card__subtitle" style="font-size: 0.7rem; color: var(--text-secondary)">No data yet</div>
            </div>
          `;
        } else {
          const card = new MetricCard(cardDiv, config);
          card.render();
          metricCards.push(card);
        }
      });
    }
    
    async function renderSkillRadar(analytics) {
      const container = document.getElementById('skill-radar-container');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Build skills object from analytics
      const skills = {};
      
      // Add strength and growth areas
      if (analytics?.strengthAreas) {
        analytics.strengthAreas.forEach(area => {
          skills[area.topic] = area.score;
        });
      }
      if (analytics?.growthAreas) {
        analytics.growthAreas.forEach(area => {
          skills[area.topic] = area.score;
        });
      }
      
      // Also use learning style breakdown for more skill data
      if (analytics?.learningStyle?.breakdown) {
        const activityTypeNames = {
          'drag-drop': 'Drag & Drop',
          'matching': 'Matching',
          'code-completion': 'Code',
          'free-response': 'Writing',
          'multiple-choice': 'Quiz',
          'fill-blank': 'Fill-in'
        };
        Object.entries(analytics.learningStyle.breakdown).forEach(([type, score]) => {
          const displayName = activityTypeNames[type] || type;
          if (!skills[displayName]) {
            skills[displayName] = score;
          }
        });
      }
      
      // Show empty state if no skills data
      if (Object.keys(skills).length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 280px; color: var(--text-secondary); text-align: center; padding: 1rem;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5;">üìä</div>
            <div style="font-weight: 500; margin-bottom: 0.25rem;">No Skills Data Yet</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">Complete activities to see your skill breakdown</div>
          </div>
        `;
        return;
      }
      
      skillRadar = new SkillRadar(container, {
        skills: skills,
        size: 280,
        showLabels: true,
        showValues: true,
        animate: true
      });
      skillRadar.render();
    }
    
    async function renderProgressTimeline(userId) {
      const container = document.getElementById('progress-timeline-container');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Get milestones from enrolled courses
      let milestones = [];
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        console.log('üìä Timeline: Got courses', courses);
        
        for (const course of courses) {
          const courseId = course.courseId || course.id;
          if (course.lessons) {
            Object.entries(course.lessons).forEach(([lessonId, lessonData]) => {
              if (lessonData.completed) {
                let completedAt = null;
                
                // Handle different timestamp formats
                if (lessonData.completedAt) {
                  if (lessonData.completedAt._seconds) {
                    completedAt = new Date(lessonData.completedAt._seconds * 1000);
                  } else if (lessonData.completedAt.seconds) {
                    completedAt = new Date(lessonData.completedAt.seconds * 1000);
                  } else if (lessonData.completedAt.toDate) {
                    completedAt = lessonData.completedAt.toDate();
                  } else if (typeof lessonData.completedAt === 'string') {
                    completedAt = new Date(lessonData.completedAt);
                  } else {
                    completedAt = new Date(lessonData.completedAt);
                  }
                }
                
                // Fallback timestamps
                if (!completedAt || isNaN(completedAt.getTime())) {
                  if (lessonData.lastViewedAt) {
                    completedAt = lessonData.lastViewedAt._seconds 
                      ? new Date(lessonData.lastViewedAt._seconds * 1000)
                      : new Date(lessonData.lastViewedAt.seconds * 1000);
                  } else if (course.lastActivity) {
                    completedAt = course.lastActivity._seconds
                      ? new Date(course.lastActivity._seconds * 1000)
                      : new Date(course.lastActivity.seconds * 1000);
                  } else {
                    completedAt = new Date();
                  }
                }
                
                if (completedAt && !isNaN(completedAt.getTime())) {
                  const formattedLesson = lessonId.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                  milestones.push({
                    title: formattedLesson,
                    timestamp: completedAt.toISOString(),
                    type: 'lesson',
                    course: courseId
                  });
                }
              }
            });
          }
        }
        
        console.log('üìä Timeline: Found milestones', milestones);
        
      } catch (error) {
        console.log('üìä Error loading timeline data:', error);
      }
      
      // Sort chronologically (oldest first for timeline graph)
      milestones.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      // Use the new TimelineGraph component
      const timelineGraph = new TimelineGraph(container, {
        milestones: milestones,
        height: 320,
        animate: true
      });
      timelineGraph.render();
    }
    
    async function renderRecommendations(userId, analytics) {
      const container = document.getElementById('recommendations-container');
      if (!container) return;
      
      console.log('üìä Recommendations: analytics received', analytics);
      
      // Don't overwrite if called with undefined (second call from elsewhere)
      if (!analytics) {
        console.log('üìä Recommendations: No analytics, skipping render');
        return;
      }
      
      container.innerHTML = '';
      
      console.log('üìä Recommendations: growthAreas', analytics?.growthAreas);
      console.log('üìä Recommendations: engagementPatterns', analytics?.engagementPatterns);
      
      // Generate recommendations from analytics data
      let recommendations = [];
      
      if (analytics) {
        // Build recommendations from growth areas
        if (analytics.growthAreas && analytics.growthAreas.length > 0) {
          analytics.growthAreas.slice(0, 2).forEach(area => {
            const resource = area.suggestedResources?.[0];
            recommendations.push({
              type: 'growth',
              priority: 'high',
              icon: 'üéØ',
              title: `Practice ${area.topic.charAt(0).toUpperCase() + area.topic.slice(1)}`,
              reason: `Your score is ${Math.round(area.score * 100)}%. ${resource ? `Try: ${resource.title}` : 'Keep practicing!'}`,
              estimatedTime: 15
            });
          });
        }
        
        // Streak recommendation
        const streak = analytics.engagementPatterns?.currentStreak || 0;
        const streakRecord = analytics.engagementPatterns?.streakRecord || 0;
        if (streak > 0 && streak < streakRecord) {
          recommendations.push({
            type: 'streak',
            priority: 'medium',
            icon: 'üî•',
            title: `Keep Your ${streak}-Day Streak`,
            reason: `You're ${streakRecord - streak} days from your record!`,
            estimatedTime: 10
          });
        } else if (streak === 0 && streakRecord > 0) {
          recommendations.push({
            type: 'streak',
            priority: 'medium',
            icon: 'üî•',
            title: 'Restart Your Streak',
            reason: `You had a ${streakRecord}-day streak before!`,
            estimatedTime: 10
          });
        }
        
        // Learning style tip
        if (analytics.learningStyle?.primary) {
          const styleNames = { kinesthetic: 'Hands-On', visual: 'Visual', auditory: 'Auditory', reading: 'Reading' };
          recommendations.push({
            type: 'style',
            priority: 'low',
            icon: 'üí°',
            title: `${styleNames[analytics.learningStyle.primary] || 'Your'} Learning Tip`,
            reason: analytics.learningStyle.primary === 'kinesthetic' 
              ? 'Try the interactive code exercises for better retention'
              : 'Focus on content that matches your style',
            estimatedTime: 5
          });
        }
      }
      
      // Show empty state if no recommendations
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px; color: var(--text-secondary); text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;">üí°</div>
            <div style="font-weight: 500; margin-bottom: 0.25rem;">No Recommendations Yet</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">Complete more activities to unlock personalized suggestions</div>
          </div>
        `;
        return;
      }
      
      recommendationList = new RecommendationList(container, {
        recommendations: recommendations,
        maxItems: 3,
        animate: true,
        onRecommendationClick: (rec) => {
          if (rec.lessonPath) {
            window.location.href = rec.lessonPath;
          }
        }
      });
      recommendationList.render();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NEW VISUAL COMPONENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function renderActivityHeatmap(userId) {
      const container = document.getElementById('activity-heatmap-container');
      if (!container || !window.ActivityHeatmap) return;
      
      // Build activity data from attempts
      const activityData = [];
      try {
        const courses = await window.DataService.getEnrolledCourses();
        const dateMap = new Map();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              if (lesson.completedAt || lesson.lastViewedAt) {
                const ts = lesson.completedAt || lesson.lastViewedAt;
                const date = ts._seconds 
                  ? new Date(ts._seconds * 1000) 
                  : ts.seconds 
                    ? new Date(ts.seconds * 1000)
                    : new Date(ts);
                const dateStr = date.toISOString().split('T')[0];
                dateMap.set(dateStr, (dateMap.get(dateStr) || 0) + 1);
              }
            });
          }
        });
        
        dateMap.forEach((count, date) => {
          activityData.push({ date, count });
        });
      } catch (e) {
        console.log('üìä Could not load activity data for heatmap');
      }
      
      const heatmap = new ActivityHeatmap(container, {
        data: activityData,
        weeks: 12
      });
      heatmap.render();
    }
    
    async function renderStreakDisplay(analytics) {
      const container = document.getElementById('streak-display-container');
      if (!container || !window.StreakDisplay) return;
      
      const currentStreak = analytics?.engagementPatterns?.currentStreak || 0;
      const streakRecord = analytics?.engagementPatterns?.streakRecord || 0;
      
      const streakDisplay = new StreakDisplay(container, {
        currentStreak,
        streakRecord,
        animate: true
      });
      streakDisplay.render();
    }
    
    async function renderWeeklyChart(analytics) {
      const container = document.getElementById('weekly-chart-container');
      if (!container || !window.WeeklyChart) return;
      
      // Build weekly data
      const weeklyData = { Sun: 0, Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0 };
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              if (lesson.completedAt || lesson.lastViewedAt) {
                const ts = lesson.completedAt || lesson.lastViewedAt;
                const date = ts._seconds 
                  ? new Date(ts._seconds * 1000) 
                  : ts.seconds 
                    ? new Date(ts.seconds * 1000)
                    : new Date(ts);
                const dayName = dayNames[date.getDay()];
                weeklyData[dayName]++;
              }
            });
          }
        });
      } catch (e) {
        console.log('üìä Could not load weekly data');
      }
      
      const weeklyChart = new WeeklyChart(container, {
        data: weeklyData,
        height: 100,
        animate: true
      });
      weeklyChart.render();
    }
    
    async function renderProgressChart(userId) {
      const container = document.getElementById('progress-chart-container');
      if (!container || !window.ProgressChart) return;
      
      const progressData = [];
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        const completions = [];
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.entries(course.lessons).forEach(([lessonId, lesson]) => {
              if (lesson.completed && (lesson.completedAt || lesson.lastViewedAt)) {
                const ts = lesson.completedAt || lesson.lastViewedAt;
                const date = ts._seconds 
                  ? new Date(ts._seconds * 1000) 
                  : ts.seconds 
                    ? new Date(ts.seconds * 1000)
                    : new Date(ts);
                if (!isNaN(date.getTime())) {
                  completions.push({ date, lessonId });
                }
              }
            });
          }
        });
        
        completions.sort((a, b) => a.date - b.date);
        const totalLessons = completions.length + 5;
        
        completions.forEach((c, i) => {
          progressData.push({
            date: c.date.toISOString().split('T')[0],
            value: Math.min(((i + 1) / totalLessons) * 100, 100),
            label: c.lessonId
          });
        });
      } catch (e) {
        console.log('üìä Could not load progress data');
      }
      
      const progressChart = new ProgressChart(container, {
        data: progressData,
        height: 130,
        animate: true,
        formatValue: (v) => `${Math.round(v)}%`
      });
      progressChart.render();
    }
    
    async function renderAccuracyChart(userId) {
      const container = document.getElementById('accuracy-chart-container');
      if (!container || !window.AccuracyChart) return;
      
      const accuracyData = [];
      
      try {
        // Use course progress data to build accuracy over time
        // This is more reliable as it tracks lesson completion with timestamps
        const courses = await window.DataService.getEnrolledCourses();
        
        // Collect all completed lessons with timestamps
        const lessonsByDate = new Map();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.entries(course.lessons).forEach(([lessonId, lesson]) => {
              if (lesson.completedAt || lesson.lastViewedAt) {
                const ts = lesson.completedAt || lesson.lastViewedAt;
                let date;
                if (ts._seconds) {
                  date = new Date(ts._seconds * 1000);
                } else if (ts.seconds) {
                  date = new Date(ts.seconds * 1000);
                } else if (ts.toDate) {
                  date = ts.toDate();
                } else {
                  date = new Date(ts);
                }
                
                if (!isNaN(date.getTime())) {
                  const dateStr = date.toISOString().split('T')[0];
                  const current = lessonsByDate.get(dateStr) || [];
                  current.push({
                    lessonId,
                    courseId: course.courseId,
                    progress: lesson.progressPercent || 0,
                    completed: lesson.completed || false,
                    viewedSections: lesson.viewedSections || 0,
                    totalSections: lesson.totalSections || 1
                  });
                  lessonsByDate.set(dateStr, current);
                }
              }
            });
          }
        });
        
        // Calculate cumulative score over time
        let cumulativeCorrect = 0;
        let cumulativeTotal = 0;
        
        // Sort dates and calculate running accuracy
        const sortedDates = Array.from(lessonsByDate.keys()).sort();
        
        sortedDates.forEach(dateStr => {
          const lessons = lessonsByDate.get(dateStr);
          
          lessons.forEach(lesson => {
            cumulativeTotal++;
            // Score based on progress and completion
            if (lesson.completed) {
              cumulativeCorrect += 1;
            } else if (lesson.progress >= 80) {
              cumulativeCorrect += 0.9;
            } else if (lesson.progress >= 50) {
              cumulativeCorrect += 0.7;
            } else if (lesson.progress > 0) {
              cumulativeCorrect += 0.4;
            } else {
              cumulativeCorrect += 0.1; // Started but no progress
            }
          });
          
          const accuracy = cumulativeTotal > 0 
            ? Math.round((cumulativeCorrect / cumulativeTotal) * 100)
            : 50;
          
          accuracyData.push({ 
            date: dateStr, 
            accuracy: Math.min(100, Math.max(0, accuracy)) 
          });
        });
        
        console.log('üìä Accuracy data points:', accuracyData.length, accuracyData);
        
      } catch (e) {
        console.log('üìä Could not load accuracy data:', e);
      }
      
      const chart = new AccuracyChart(container, {
        data: accuracyData,
        height: 130
      });
      chart.render();
    }
    
    async function renderTimeDistributionChart(userId) {
      const container = document.getElementById('time-distribution-container');
      if (!container || !window.TimeDistributionChart) return;
      
      const timeData = { 'Stories': 0, 'Quizzes': 0, 'Practice': 0 };
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              // Estimate time based on progress
              const baseTime = 15; // 15 min per lesson estimate
              const pct = (lesson.progressPercent || 0) / 100;
              const storyTime = baseTime * pct * 0.6;
              const quizTime = baseTime * pct * 0.3;
              const practiceTime = baseTime * pct * 0.1;
              
              timeData['Stories'] += storyTime;
              timeData['Quizzes'] += quizTime;
              timeData['Practice'] += practiceTime;
            });
          }
        });
      } catch (e) {
        console.log('üìä Could not load time data');
      }
      
      const chart = new TimeDistributionChart(container, {
        data: timeData,
        height: 130
      });
      chart.render();
    }
    
    async function renderCourseBreakdownChart(userId) {
      const container = document.getElementById('course-breakdown-container');
      if (!container || !window.CourseBreakdownChart) return;
      
      const courseData = [];
      const chaptersPerCourse = {
        'apprentice': 7,
        'junior': 7,
        'senior': 7,
        'undergrad': 7,
        'endless-opportunities': 5
      };
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        
        courses.forEach(course => {
          const total = chaptersPerCourse[course.courseId] || 7;
          let completed = 0;
          
          if (course.lessons) {
            completed = Object.values(course.lessons).filter(l => l.completed).length;
          }
          
          courseData.push({
            course: course.courseId,
            completed,
            total
          });
        });
      } catch (e) {
        console.log('üìä Could not load course data');
      }
      
      const chart = new CourseBreakdownChart(container, {
        data: courseData,
        height: 130
      });
      chart.render();
    }
    
    async function renderActivityTypesChart(userId) {
      const container = document.getElementById('activity-types-container');
      if (!container || !window.ActivityTypesChart) return;
      
      const activityData = {};
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              if (lesson.viewedSections) {
                activityData['Story'] = (activityData['Story'] || 0) + lesson.viewedSections;
              }
              if (lesson.completed) {
                activityData['Quiz'] = (activityData['Quiz'] || 0) + 1;
              }
            });
          }
        });
        
        // Add some default categories if we have any data
        if (Object.keys(activityData).length > 0) {
          activityData['Review'] = Math.round((activityData['Story'] || 0) * 0.2);
        }
      } catch (e) {
        console.log('üìä Could not load activity types');
      }
      
      const chart = new ActivityTypesChart(container, {
        data: activityData,
        height: 130
      });
      chart.render();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMING SOON TOAST
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    (function setupComingSoon() {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = 'coming-soon-toast';
      toast.innerHTML = `
        <span class="coming-soon-toast__icon">üöß</span>
        <div class="coming-soon-toast__content">
          <span class="coming-soon-toast__title">Coming Soon!</span>
          <span class="coming-soon-toast__message"></span>
        </div>
      `;
      document.body.appendChild(toast);

      let toastTimeout = null;

      function showComingSoonToast(featureName) {
        const message = toast.querySelector('.coming-soon-toast__message');
        message.textContent = `${featureName} is under development. Stay tuned!`;

        // Reset animation
        clearTimeout(toastTimeout);
        toast.classList.remove('show');

        // Trigger reflow then show
        requestAnimationFrame(() => {
          toast.classList.add('show');
          toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
          }, 3000);
        });
      }

      // Attach click handlers to all coming-soon links
      document.querySelectorAll('.coming-soon-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const feature = link.getAttribute('data-feature') || 'This feature';
          showComingSoonToast(feature);
        });
      });
    })();

    function renderErrorState(error) {
      const section = document.getElementById('component-analytics-section');
      if (!section) return;
      
      // Show error in each container
      const containers = [
        'metrics-row',
        'skill-radar-container', 
        'progress-timeline-container',
        'recommendations-container'
      ];
      
      containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
          container.innerHTML = `
            <div class="error-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; color: var(--text-secondary); text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
              <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚ö†Ô∏è</div>
              <div style="font-size: 0.85rem;">Unable to load analytics</div>
            </div>
          `;
        }
      });
      
      console.error('üìä Analytics error state rendered:', error);
    }
  </script>
</body>
</html>

