<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | AutoNateAI Learning Hub</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- Critical styles - must load before body renders -->
  <style>
    /* Hide content until auth is confirmed */
    .dashboard { display: none !important; }
    .dashboard.ready { display: flex !important; }
    
    /* Loading screen - shown immediately */
    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0a0a0f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .auth-loading.hidden { display: none; }
    .loading-content { text-align: center; color: #e8e8f0; }
    .loading-icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(121, 134, 203, 0.3);
      border-top-color: #7986cb;
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  
  <!-- Styles -->
  <link rel="stylesheet" href="../shared/css/dashboard.css">
  <link rel="stylesheet" href="../shared/css/analytics.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  
  <!-- Loading Screen -->
  <div class="auth-loading" id="auth-loading">
    <div class="loading-content">
      <div class="loading-icon">üèõÔ∏è</div>
      <div class="loading-spinner"></div>
      <p>Loading your dashboard...</p>
    </div>
  </div>
  
  <div class="dashboard" id="dashboard-content">
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="../index.html" class="sidebar-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <span class="logo-text">AutoNateAI</span>
      </a>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">Main</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="index.html" class="nav-link active">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">
                <span class="nav-icon">üìö</span>
                <span class="nav-text">Course Library</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="challenges.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span class="nav-text">Daily Challenges</span>
                <span class="nav-badge">3</span>
              </a>
            </li>
          </ul>
        </div>
        
        <div class="nav-section">
          <span class="nav-section-title">Learning</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="progress.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">My Progress</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="achievements.html" class="nav-link">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-text">Achievements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="notes.html" class="nav-link">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">Notes</span>
              </a>
            </li>
          </ul>
        </div>
        
        <div class="nav-section">
          <span class="nav-section-title">Community</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="https://discord.gg/Me5N8tCdkC" target="_blank" class="nav-link">
                <span class="nav-icon">üí¨</span>
                <span class="nav-text">Discord</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="leaderboard.html" class="nav-link">
                <span class="nav-icon">üèÖ</span>
                <span class="nav-text">Leaderboard</span>
              </a>
            </li>
          </ul>
        </div>
        
        <div class="nav-section">
          <span class="nav-section-title">Account</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="profile.html" class="nav-link">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="settings.html" class="nav-link">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
        
        <!-- Admin Section (hidden by default, shown for admins) -->
        <div class="nav-section" id="admin-section" style="display: none;">
          <span class="nav-section-title" style="color: #f44336;">Admin</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="../admin/" class="nav-link">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">Admin Dashboard</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>
      
      <div class="sidebar-user">
        <div class="user-card" id="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-streak">
              <span>üî•</span>
              <span id="user-streak">0</span> day streak
            </div>
          </div>
        </div>
      </div>
      
      <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </aside>
    
    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
          <h1 class="page-title">Dashboard</h1>
        </div>
        
        <div class="header-right">
          <div class="header-search">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <input type="text" class="search-input" placeholder="Search courses, lessons...">
          </div>
          
          <div class="header-actions">
            <button class="action-btn" title="Notifications">
              üîî
              <span class="notification-dot"></span>
            </button>
          </div>
        </div>
      </header>
      
      <!-- Content -->
      <div class="content-area">
        
        <!-- Welcome Message -->
        <div class="welcome-message" id="welcome-message" style="margin-bottom: 2rem;">
          <h2 style="font-family: var(--font-display); font-size: 1.75rem; margin-bottom: 0.5rem;">
            Welcome back, <span id="welcome-name">Architect</span>! üëã
          </h2>
          <p style="color: var(--text-secondary);">Ready to continue your journey with the Three Forces?</p>
        </div>
        
        <!-- Learning Insights Panel (Server-computed analytics) -->
        <div class="insights-panel" id="insights-panel" style="display: none;">
          <div class="insights-header">
            <h3 class="insights-title">üß† Learning Insights</h3>
            <span class="data-quality-badge" id="data-quality-badge">
              <span id="data-quality-icon">üìä</span>
              <span id="data-quality-text">Loading...</span>
            </span>
          </div>
          
          <div class="insights-grid">
            <!-- Learning Style Card -->
            <div class="learning-style-card" id="learning-style-card">
              <div class="style-header">
                <span class="style-icon" id="style-icon">üéØ</span>
                <div class="style-info">
                  <div class="style-primary" id="style-primary">Determining...</div>
                  <div class="style-secondary" id="style-secondary"></div>
                </div>
              </div>
              <p class="style-description" id="style-description">
                Complete more activities to determine your learning style.
              </p>
              <div class="style-confidence">
                <div class="confidence-bar">
                  <div class="confidence-fill" id="confidence-fill" style="width: 0%"></div>
                </div>
                <span class="confidence-label" id="confidence-label">0% confidence</span>
              </div>
              <div class="style-breakdown" id="style-breakdown" style="display: none;">
                <div class="breakdown-title">Performance by Activity Type</div>
                <div class="breakdown-bars" id="breakdown-bars"></div>
              </div>
            </div>
            
            <!-- Strengths & Growth Areas -->
            <div class="areas-card">
              <div class="areas-section">
                <div class="areas-section-title">
                  <span class="areas-section-icon">üí™</span>
                  Strength Areas
                </div>
                <div class="areas-list" id="strength-areas-list">
                  <div class="areas-empty">Complete activities to identify strengths</div>
                </div>
              </div>
              
              <div class="areas-section">
                <div class="areas-section-title">
                  <span class="areas-section-icon">üå±</span>
                  Growth Opportunities
                </div>
                <div class="areas-list" id="growth-areas-list">
                  <div class="areas-empty">No areas needing focus yet</div>
                </div>
              </div>
            </div>
            
            <!-- Engagement Patterns -->
            <div class="engagement-card">
              <div class="areas-section-title" style="margin-bottom: var(--space-md);">
                <span class="areas-section-icon">‚è∞</span>
                Engagement Patterns
              </div>
              <div class="engagement-grid">
                <div class="engagement-stat">
                  <div class="engagement-stat-icon">üìÖ</div>
                  <div class="engagement-stat-value" id="peak-day">--</div>
                  <div class="engagement-stat-label">Best Day</div>
                </div>
                <div class="engagement-stat">
                  <div class="engagement-stat-icon">üïê</div>
                  <div class="engagement-stat-value" id="peak-hour">--</div>
                  <div class="engagement-stat-label">Peak Hour</div>
                </div>
                <div class="engagement-stat">
                  <div class="engagement-stat-icon">‚è±Ô∏è</div>
                  <div class="engagement-stat-value" id="avg-session">--</div>
                  <div class="engagement-stat-label">Avg Session</div>
                </div>
                <div class="engagement-stat">
                  <div class="engagement-stat-icon">üìà</div>
                  <div class="engagement-stat-value" id="consistency-score">--</div>
                  <div class="engagement-stat-label">Consistency</div>
                </div>
              </div>
            </div>
            
            <!-- Persistence Metrics -->
            <div class="persistence-card">
              <div class="areas-section-title" style="margin-bottom: var(--space-md);">
                <span class="areas-section-icon">üîÑ</span>
                Persistence & Growth
              </div>
              <div class="persistence-stats">
                <div class="persistence-stat">
                  <span class="persistence-icon">üéØ</span>
                  <div class="persistence-info">
                    <div class="persistence-value" id="overall-accuracy">--%</div>
                    <div class="persistence-label">Overall Accuracy</div>
                  </div>
                </div>
                <div class="persistence-stat">
                  <span class="persistence-icon">üîÅ</span>
                  <div class="persistence-info">
                    <div class="persistence-value" id="retry-rate">--%</div>
                    <div class="persistence-label">Retry After Fail</div>
                  </div>
                </div>
                <div class="persistence-stat">
                  <span class="persistence-icon">üìä</span>
                  <div class="persistence-info">
                    <div class="persistence-value" id="improvement-rate">--%</div>
                    <div class="persistence-label">Improvement Rate</div>
                  </div>
                </div>
                <div class="persistence-stat">
                  <span class="persistence-icon">‚ú®</span>
                  <div class="persistence-info">
                    <div class="persistence-value" id="total-activities">--</div>
                    <div class="persistence-label">Activities Done</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Recommendations -->
          <div class="recommendations-list" id="recommendations-list"></div>
        </div>
        
        <!-- Component-Based Analytics Section - 3x3 Grid -->
        <section class="analytics-section" id="component-analytics-section" style="display: none;">
          
          <!-- 3x3 Analytics Grid -->
          <div class="analytics-grid" style="
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
          ">
            
            <!-- Row 1 -->
            
            <!-- 1. Activity Heatmap -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üìÖ</span> Activity
              </h4>
              <div id="activity-heatmap-container" style="height: 140px; overflow: hidden;">
                <!-- ActivityHeatmap rendered here -->
              </div>
            </div>
            
            <!-- 2. Weekly Pattern -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üìä</span> Weekly Pattern
              </h4>
              <div id="weekly-chart-container" style="height: 140px;">
                <!-- WeeklyChart rendered here -->
              </div>
            </div>
            
            <!-- 3. Streak -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <div id="streak-display-container" style="height: 160px;">
                <!-- StreakDisplay rendered here -->
              </div>
            </div>
            
            <!-- Row 2 -->
            
            <!-- 4. Progress Over Time -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üìà</span> Progress
              </h4>
              <div id="progress-chart-container" style="height: 140px;">
                <!-- ProgressChart rendered here -->
              </div>
            </div>
            
            <!-- 5. Accuracy Trend -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üéØ</span> Accuracy
              </h4>
              <div id="accuracy-chart-container" style="height: 140px;">
                <!-- Accuracy trend chart -->
              </div>
            </div>
            
            <!-- 6. Time Spent -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>‚è±Ô∏è</span> Time Spent
              </h4>
              <div id="time-distribution-container" style="height: 140px;">
                <!-- Time distribution chart -->
              </div>
            </div>
            
            <!-- Row 3 -->
            
            <!-- 7. Skill Radar -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem; overflow: visible;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üß†</span> Skills
              </h4>
              <div id="skill-radar-container" style="height: 160px; overflow: visible;">
                <!-- SkillRadar rendered here -->
              </div>
            </div>
            
            <!-- 8. Course Breakdown -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üìö</span> Courses
              </h4>
              <div id="course-breakdown-container" style="height: 140px;">
                <!-- Course breakdown chart -->
              </div>
            </div>
            
            <!-- 9. Activity Types -->
            <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
              <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üéÆ</span> Activity Types
              </h4>
              <div id="activity-types-container" style="height: 140px;">
                <!-- Activity types pie chart -->
              </div>
            </div>
            
          </div>
          
          <!-- Journey Timeline (full width below grid) -->
          <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
            <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>üó∫Ô∏è</span> Learning Journey
            </h4>
            <div id="progress-timeline-container" style="height: 200px;">
              <!-- TimelineGraph rendered here -->
            </div>
          </div>
          
          <!-- Recommendations (full width) -->
          <div class="analytics-card" style="background: var(--surface-elevated); border-radius: 12px; padding: 1rem;">
            <h4 style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>üí°</span> Recommended Next Steps
            </h4>
            <div id="recommendations-container">
              <!-- RecommendationCards rendered here -->
            </div>
          </div>
          
          <!-- Hidden containers for backward compatibility -->
          <div id="metrics-row" style="display: none;"></div>
        </section>
        
        <!-- Continue Learning Section -->
        <div class="section-header">
          <h3 class="section-title">Continue Learning</h3>
          <a href="courses.html" class="section-action">
            View All Courses ‚Üí
          </a>
        </div>
        
        <div class="courses-grid" id="courses-grid">
          <!-- Courses will be loaded dynamically -->
          <div class="empty-state" id="empty-courses">
            <div class="empty-icon">üìö</div>
            <h3 class="empty-title">No courses yet</h3>
            <p class="empty-desc">Start your architect journey by enrolling in a course!</p>
            <a href="courses.html" class="empty-action">
              <span>Browse Courses</span>
              <span>‚Üí</span>
            </a>
          </div>
        </div>
        
      </div>
    </main>
    
  </div>
  
  <!-- Scripts -->
  <script src="../shared/js/firebase-config.js"></script>
  <script src="../shared/js/auth.js"></script>
  <script src="../shared/js/rbac.js"></script>
  <script src="../shared/js/data-service.js"></script>
  <script src="../shared/js/analytics-service.js"></script>
  
  <!-- Services (Agent 2/3) -->
  <script src="../shared/js/services/cache-service.js"></script>
  <script src="../shared/js/services/query-service.js"></script>
  <script src="../shared/js/services/analytics-service.js"></script>
  
  <!-- Analytics Components (Agent 4) -->
  <script src="../shared/js/components/analytics/metric-card.js"></script>
  <script src="../shared/js/components/analytics/skill-radar.js"></script>
  <script src="../shared/js/components/analytics/progress-timeline.js"></script>
  <script src="../shared/js/components/analytics/timeline-graph.js"></script>
  <script src="../shared/js/components/analytics/recommendation-card.js"></script>
  
  <!-- New Visual Components (3x3 Grid) -->
  <script src="../shared/js/components/analytics/activity-heatmap.js"></script>
  <script src="../shared/js/components/analytics/progress-chart.js"></script>
  <script src="../shared/js/components/analytics/weekly-chart.js"></script>
  <script src="../shared/js/components/analytics/streak-display.js"></script>
  <script src="../shared/js/components/analytics/accuracy-chart.js"></script>
  <script src="../shared/js/components/analytics/time-distribution-chart.js"></script>
  <script src="../shared/js/components/analytics/course-breakdown-chart.js"></script>
  <script src="../shared/js/components/analytics/activity-types-chart.js"></script>
  
  <script>
    // Course data
    const COURSES = {
      "endless-opportunities": {
        name: "Endless Opportunities",
        icon: "üöÄ",
        subtitle: "Start your tech journey with Grand Rapids Public Schools",
        link: "../endless-opportunities/week0-intro/"
      },
      apprentice: {
        name: "The Apprentice's Path",
        icon: "üåü",
        subtitle: "For Complete Beginners",
        link: "../apprentice/ch0-origins/"
      },
      undergrad: {
        name: "The Bridge to Industry",
        icon: "üéì",
        subtitle: "For CS Students",
        link: "../undergrad/ch0-origins/"
      },
      junior: {
        name: "The Junior Accelerator",
        icon: "üöÄ",
        subtitle: "For Junior Engineers",
        link: "../junior/ch0-origins/"
      },
      senior: {
        name: "The Senior Amplifier",
        icon: "üéØ",
        subtitle: "For Mid-to-Senior Engineers",
        link: "../senior/ch0-origins/"
      }
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('auth-loading');
      const dashboardContent = document.getElementById('dashboard-content');
      
      // Initialize Firebase
      if (!window.FirebaseApp.init()) {
        console.error('Firebase initialization failed');
        loadingScreen.innerHTML = '<div class="loading-content"><p>Error loading. Please refresh.</p></div>';
        return;
      }
      
      window.AuthService.init();
      
      // Wait for auth state to be determined (handles session restoration)
      const user = await window.AuthService.waitForAuthState();
      
      if (!user) {
        // Not logged in, redirect to login
        window.AuthService.setRedirectUrl(window.location.href);
        window.location.href = '../auth/login.html';
        return;
      }
      
      // User is logged in, show dashboard
      loadingScreen.classList.add('hidden');
      dashboardContent.classList.add('ready');
      
      // Check if user is admin and show admin section
      if (window.RBACService) {
        const isAdmin = await window.RBACService.hasRole('admin');
        if (isAdmin) {
          document.getElementById('admin-section').style.display = 'block';
        }
      }
      
      loadUserInfo(user);
      await loadUserStats();
      await loadEnrolledCourses();
      // Note: loadAnalytics() removed - UI elements were removed
      // loadLearningInsights() is called via setTimeout at end of script
      
      // Setup UI interactions
      setupSidebar();
      setupLogout();
      
      // Animate stats cards
      anime({
        targets: '.animate-in',
        opacity: [0, 1],
        translateY: [20, 0],
        delay: anime.stagger(100, { start: 200 }),
        easing: 'easeOutCubic',
        duration: 600
      });
      
      // Listen for subsequent auth changes (logout, etc)
      window.AuthService.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = '../auth/login.html';
        }
      });
    });
    
    // Load user info
    function loadUserInfo(user) {
      const displayName = user.displayName || user.email.split('@')[0];
      
      document.getElementById('user-name').textContent = displayName;
      document.getElementById('welcome-name').textContent = displayName.split(' ')[0];
      
      const avatar = document.getElementById('user-avatar');
      if (user.photoURL) {
        avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
      } else {
        avatar.textContent = displayName.charAt(0).toUpperCase();
      }
    }
    
    // Load user stats - now uses visual cards
    async function loadUserStats() {
      try {
        const stats = await window.DataService.getUserStats();
        
        if (stats) {
          // Update sidebar streak
          document.getElementById('user-streak').textContent = stats.currentStreak || 0;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    // Load enrolled courses
    async function loadEnrolledCourses() {
      try {
        const courses = await window.DataService.getEnrolledCourses();
        console.log('üìä Dashboard: Loaded courses from Firestore:', courses);
        
        const grid = document.getElementById('courses-grid');
        const emptyState = document.getElementById('empty-courses');
        
        if (courses.length === 0) {
          emptyState.style.display = 'block';
          return;
        }
        
        // Sort by most recent activity (lastActivity timestamp)
        const sortedCourses = courses.sort((a, b) => {
          const aTime = a.lastActivity?._seconds || a.lastActivity?.seconds || 0;
          const bTime = b.lastActivity?._seconds || b.lastActivity?.seconds || 0;
          return bTime - aTime; // Most recent first
        });
        
        // Take only the top 2 most recently active
        const recentCourses = sortedCourses.slice(0, 2);
        console.log('üìä Showing top 2 recent courses:', recentCourses.map(c => c.courseId || c.id));
        
        emptyState.style.display = 'none';
        grid.innerHTML = '';
        
        recentCourses.forEach(course => {
          const courseId = course.courseId || course.id;
          const courseInfo = COURSES[courseId] || course;
          const card = createCourseCard(course, courseInfo);
          grid.appendChild(card);
        });
        
        // Animate cards
        anime({
          targets: '.course-progress-card',
          opacity: [0, 1],
          translateY: [30, 0],
          delay: anime.stagger(100),
          easing: 'easeOutCubic',
          duration: 600
        });
        
      } catch (error) {
        console.error('Error loading courses:', error);
      }
    }
    
    // Create course progress card
    function createCourseCard(progress, courseInfo) {
      const courseId = progress.courseId || progress.id;
      
      const card = document.createElement('div');
      card.className = `course-progress-card ${courseId}`;
      
      // Use DataService for lesson structure and next lesson (single source of truth)
      const structure = window.DataService.getLessonsStructure(courseId);
      const totalLessons = structure.totalLessons;
      const lessonLabel = structure.lessonLabel;
      
      // Get completed count using DataService
      const displayCompletedLessons = window.DataService.getCompletedLessonsCount(progress, courseId);
      const progressPercent = Math.round((displayCompletedLessons / totalLessons) * 100);
      
      // Get next lesson info using DataService
      const nextLessonInfo = window.DataService.getNextLesson(progress, courseId);
      
      // Link to course dashboard
      const cardLink = `course.html?id=${courseId}`;
      
      card.innerHTML = `
        <a href="${cardLink}" class="course-card-link">
          <div class="course-banner"></div>
          <div class="course-content">
            <div class="course-header">
              <div class="course-icon">${courseInfo.icon}</div>
              <div class="course-meta">
                <div class="course-name">${courseInfo.name}</div>
                <div class="course-subtitle">${courseInfo.subtitle}</div>
              </div>
            </div>
            
            <div class="progress-section">
              <div class="progress-header">
                <span class="progress-label">${displayCompletedLessons}/${totalLessons} ${lessonLabel}s Complete</span>
                <span class="progress-percent">${progressPercent}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercent}%"></div>
              </div>
            </div>
            
            <div class="course-stats">
              <div class="course-stat">
                <div class="course-stat-value">${displayCompletedLessons}</div>
                <div class="course-stat-label">Completed</div>
              </div>
              <div class="course-stat">
                <div class="course-stat-value">${totalLessons - displayCompletedLessons}</div>
                <div class="course-stat-label">Remaining</div>
              </div>
              <div class="course-stat">
                <div class="course-stat-value">${formatTime(progress.totalTimeSpent || 0)}</div>
                <div class="course-stat-label">Time Spent</div>
              </div>
            </div>
            
            <span class="course-action">
              ${nextLessonInfo.allComplete ? 'View Course Dashboard ‚Üí' : `Continue: ${nextLessonInfo.lessonName} ‚Üí`}
            </span>
          </div>
        </a>
      `;
      
      return card;
    }
    
    // Format time
    function formatTime(seconds) {
      if (seconds < 60) return '< 1m';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      if (hours > 0) return `${hours}h`;
      return `${minutes}m`;
    }
    
    // Setup sidebar
    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      const overlay = document.getElementById('sidebar-overlay');
      const mobileBtn = document.getElementById('mobile-menu-btn');
      
      // Desktop toggle
      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });
      
      // Restore sidebar state
      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }
      
      // Mobile menu
      mobileBtn.addEventListener('click', () => {
        sidebar.classList.add('open');
      });
      
      overlay.addEventListener('click', () => {
        sidebar.classList.remove('open');
      });
    }
    
    // Setup logout
    function setupLogout() {
      document.getElementById('logout-link').addEventListener('click', async (e) => {
        e.preventDefault();
        await window.AuthService.logout();
        window.location.href = '../index.html';
      });
    }
    
    // Animate counter from start to end
    function animateCounter(element, start, end, duration) {
      const startTime = performance.now();
      const diff = end - start;
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Ease out cubic
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(start + diff * eased);
        
        element.textContent = current;
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LEARNING INSIGHTS PANEL
    // Renders server-computed analytics from userAnalytics collection
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function loadLearningInsights() {
      try {
        const insights = await window.AnalyticsService.getLearningInsights();
        console.log('üß† Learning insights loaded:', insights);
        
        const panel = document.getElementById('insights-panel');
        
        // Only show if we have server analytics or enough local data
        if (!insights.hasServerAnalytics && insights.lessonsCompleted < 3) {
          panel.style.display = 'none';
          return;
        }
        
        panel.style.display = 'block';
        
        // Update data quality badge
        renderDataQuality(insights.dataQuality);
        
        // Render learning style
        renderLearningStyle(insights.learningStyle);
        
        // Render strength areas
        renderStrengthAreas(insights.strengthAreas);
        
        // Render growth areas
        renderGrowthAreas(insights.growthAreas);
        
        // Render engagement patterns
        renderEngagementPatterns(insights.engagementPatterns);
        
        // Render persistence metrics
        renderPersistenceMetrics(insights.persistenceMetrics);
        
        // Render recommendations
        const recommendations = await window.AnalyticsService.getRecommendations();
        renderRecommendations(recommendations);
        
        // Animate panel entrance
        anime({
          targets: '.insights-panel',
          opacity: [0, 1],
          translateY: [20, 0],
          duration: 600,
          easing: 'easeOutCubic'
        });
        
      } catch (error) {
        console.error('Error loading learning insights:', error);
      }
    }
    
    function renderDataQuality(quality) {
      const badge = document.getElementById('data-quality-badge');
      const icon = document.getElementById('data-quality-icon');
      const text = document.getElementById('data-quality-text');
      
      if (!quality) {
        badge.classList.add('low');
        icon.textContent = '‚ö†Ô∏è';
        text.textContent = 'Limited data';
        return;
      }
      
      if (quality.hasEnoughData) {
        badge.classList.remove('low');
        icon.textContent = '‚úÖ';
        text.textContent = `${quality.activityCount} activities analyzed`;
      } else {
        badge.classList.add('low');
        icon.textContent = 'üìä';
        text.textContent = `${quality.activityCount}/10 activities`;
      }
    }
    
    function renderLearningStyle(learningStyle) {
      const formatted = window.AnalyticsService.formatLearningStyle(learningStyle);
      
      document.getElementById('style-icon').textContent = formatted.primary.icon;
      document.getElementById('style-primary').textContent = formatted.primary.name + ' Learner';
      document.getElementById('style-description').textContent = formatted.primary.description;
      
      if (formatted.secondary) {
        document.getElementById('style-secondary').textContent = 
          `Secondary: ${formatted.secondary.name}`;
      }
      
      // Confidence bar
      const confidencePercent = Math.round(formatted.confidence * 100);
      document.getElementById('confidence-fill').style.width = confidencePercent + '%';
      document.getElementById('confidence-label').textContent = 
        `${confidencePercent}% confidence (${formatted.dataPoints} activities)`;
      
      // Activity type breakdown
      if (formatted.breakdown && Object.keys(formatted.breakdown).length > 0) {
        const breakdownSection = document.getElementById('style-breakdown');
        const barsContainer = document.getElementById('breakdown-bars');
        
        breakdownSection.style.display = 'block';
        barsContainer.innerHTML = '';
        
        const activityLabels = {
          'drag-drop': 'Drag & Drop',
          'matching': 'Matching',
          'multiple-choice': 'Multiple Choice',
          'code-completion': 'Code Completion',
          'free-response': 'Free Response',
          'fill-blank': 'Fill Blank'
        };
        
        for (const [type, score] of Object.entries(formatted.breakdown)) {
          const percent = Math.round(score * 100);
          const item = document.createElement('div');
          item.className = 'breakdown-item';
          item.innerHTML = `
            <span class="breakdown-item-label">${activityLabels[type] || type}</span>
            <div class="breakdown-item-bar">
              <div class="breakdown-item-fill" style="width: ${percent}%"></div>
            </div>
            <span class="breakdown-item-value">${percent}%</span>
          `;
          barsContainer.appendChild(item);
        }
      }
    }
    
    function renderStrengthAreas(areas) {
      const container = document.getElementById('strength-areas-list');
      
      if (!areas || areas.length === 0) {
        container.innerHTML = '<div class="areas-empty">Complete activities to identify strengths</div>';
        return;
      }
      
      container.innerHTML = '';
      
      // Show top 3 strengths
      areas.slice(0, 3).forEach(area => {
        const item = document.createElement('div');
        item.className = 'area-item strength';
        const scorePercent = Math.round(area.score * 100);
        item.innerHTML = `
          <span class="area-topic">${formatTopicName(area.topic)}</span>
          <span class="area-score high">${scorePercent}%</span>
        `;
        container.appendChild(item);
      });
    }
    
    function renderGrowthAreas(areas) {
      const container = document.getElementById('growth-areas-list');
      
      if (!areas || areas.length === 0) {
        container.innerHTML = '<div class="areas-empty">No areas needing focus yet</div>';
        return;
      }
      
      container.innerHTML = '';
      
      // Show top 3 growth areas
      areas.slice(0, 3).forEach(area => {
        const item = document.createElement('div');
        item.className = 'area-item growth';
        const scorePercent = Math.round(area.score * 100);
        
        let suggestionHtml = '';
        if (area.suggestedResources && area.suggestedResources.length > 0) {
          suggestionHtml = `<div class="area-suggestion">üìö Try: ${area.suggestedResources[0].title}</div>`;
        }
        
        item.innerHTML = `
          <div>
            <span class="area-topic">${formatTopicName(area.topic)}</span>
            ${suggestionHtml}
          </div>
          <span class="area-score low">${scorePercent}%</span>
        `;
        container.appendChild(item);
      });
    }
    
    function renderEngagementPatterns(patterns) {
      if (!patterns) return;
      
      // Peak day
      const peakDay = patterns.peakPerformanceDay || '--';
      document.getElementById('peak-day').textContent = peakDay;
      
      // Peak hour
      const peakHour = patterns.peakPerformanceHour;
      document.getElementById('peak-hour').textContent = 
        peakHour !== null && peakHour !== undefined ? `${peakHour}:00` : '--';
      
      // Average session length
      const avgSession = patterns.avgSessionLength || 0;
      document.getElementById('avg-session').textContent = 
        avgSession > 0 ? `${avgSession}m` : '--';
      
      // Consistency score
      const consistency = patterns.consistencyScore || 0;
      document.getElementById('consistency-score').textContent = 
        `${Math.round(consistency * 100)}%`;
    }
    
    function renderPersistenceMetrics(metrics) {
      if (!metrics) {
        document.getElementById('overall-accuracy').textContent = '--%';
        document.getElementById('retry-rate').textContent = '--%';
        document.getElementById('improvement-rate').textContent = '--%';
        document.getElementById('total-activities').textContent = '--';
        return;
      }
      
      document.getElementById('overall-accuracy').textContent = 
        `${Math.round(metrics.overallAccuracy * 100)}%`;
      
      document.getElementById('retry-rate').textContent = 
        `${Math.round(metrics.retryAfterFailure * 100)}%`;
      
      document.getElementById('improvement-rate').textContent = 
        metrics.improvementRate > 0 
          ? `+${Math.round(metrics.improvementRate * 100)}%`
          : `${Math.round(metrics.improvementRate * 100)}%`;
      
      document.getElementById('total-activities').textContent = 
        metrics.totalAttempts || '--';
    }
    
    function renderRecommendations(recommendations) {
      const container = document.getElementById('recommendations-list');
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = '';
      
      // Show top 2 recommendations
      recommendations.slice(0, 2).forEach(rec => {
        const item = document.createElement('div');
        item.className = `recommendation-item ${rec.priority}`;
        item.innerHTML = `
          <span class="recommendation-icon">${rec.icon}</span>
          <div class="recommendation-content">
            <div class="recommendation-title">${rec.title}</div>
            <div class="recommendation-description">${rec.description}</div>
          </div>
        `;
        container.appendChild(item);
      });
    }
    
    function formatTopicName(topic) {
      if (!topic) return 'Unknown';
      return topic
        .replace(/[-_]/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
    }
    
    // Load insights after main data loads
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for main data to load first
      setTimeout(() => {
        loadLearningInsights();
        loadComponentAnalytics();
      }, 500);
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMPONENT-BASED ANALYTICS (Agent 4)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let metricCards = [];
    let skillRadar = null;
    let progressTimeline = null;
    let recommendationList = null;
    
    async function loadComponentAnalytics() {
      const section = document.getElementById('component-analytics-section');
      if (!section) {
        console.warn('üìä Component analytics section not found');
        return;
      }
      
      // Check if components are available
      if (!window.MetricCard || !window.SkillRadar || !window.ProgressTimeline || !window.RecommendationList) {
        console.log('üìä Components not fully loaded, skipping component analytics');
        return;
      }
      
      const user = window.AuthService?.getUser();
      if (!user) {
        console.log('üìä No user, skipping component analytics');
        return;
      }
      
      console.log('üìä Loading component analytics for user:', user.uid);
      
      // Always show the section
      section.style.display = 'block';
      
      try {
        // Try to get server-computed analytics (use same service as Learning Insights)
        let analytics = null;
        if (window.AnalyticsService?.getUserAnalytics) {
          analytics = await window.AnalyticsService.getUserAnalytics();
          console.log('üìä Loaded analytics for Performance Overview:', analytics);
        }
        
        if (!analytics) {
          console.log('üìä No analytics data found, showing empty state');
        }
        
        // Render 3x3 grid components
        await Promise.all([
          renderActivityHeatmap(user.uid),
          renderWeeklyChart(analytics),
          renderStreakDisplay(analytics),
          renderProgressChart(user.uid),
          renderAccuracyChart(user.uid),
          renderTimeDistributionChart(user.uid),
          renderSkillRadar(analytics),
          renderCourseBreakdownChart(user.uid),
          renderActivityTypesChart(user.uid),
        ]);
        
        // Full-width components
        await renderProgressTimeline(user.uid);
        await renderRecommendations(user.uid, analytics);
        
        console.log('üìä 3x3 Grid analytics rendered successfully');
        
      } catch (error) {
        console.error('üìä Error loading component analytics:', error);
        renderErrorState(error);
      }
    }
    
    async function renderMetricCards(analytics, userId) {
      const container = document.getElementById('metrics-row');
      if (!container) return;
      
      container.innerHTML = '';
      metricCards = [];
      
      // Check if we have analytics data
      const hasData = analytics && analytics.summaryStats;
      
      // Get values from analytics (0 is valid, only show 0 if we have data)
      const overallScore = hasData ? (analytics.summaryStats.overallScore || 0) : null;
      const streak = analytics?.engagementPatterns?.currentStreak ?? null;
      const timeMinutes = hasData ? (analytics.summaryStats.totalTimeMinutes || 0) : null;
      const activitiesCompleted = hasData ? (analytics.summaryStats.activitiesCompleted || 0) : null;
      
      const cardConfigs = [
        { title: 'Overall Score', value: overallScore, icon: 'üéØ', format: 'number', colorScheme: 'primary', noData: overallScore === null },
        { title: 'Day Streak', value: streak ?? 0, icon: 'üî•', format: 'number', colorScheme: 'warning', noData: streak === null },
        { title: 'Time Spent', value: timeMinutes !== null ? Math.round(timeMinutes / 60) : 0, icon: '‚è±Ô∏è', format: 'hours', colorScheme: 'info', noData: timeMinutes === null },
        { title: 'Activities', value: activitiesCompleted ?? 0, icon: '‚úÖ', format: 'number', colorScheme: 'success', noData: activitiesCompleted === null }
      ];
      
      cardConfigs.forEach(config => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'metric-card-wrapper';
        container.appendChild(cardDiv);
        
        // If no data, show empty state message
        if (config.noData) {
          cardDiv.innerHTML = `
            <div class="metric-card metric-card--${config.colorScheme}" style="opacity: 0.6">
              <div class="metric-card__icon">${config.icon}</div>
              <div class="metric-card__value">--</div>
              <div class="metric-card__title">${config.title}</div>
              <div class="metric-card__subtitle" style="font-size: 0.7rem; color: var(--text-secondary)">No data yet</div>
            </div>
          `;
        } else {
          const card = new MetricCard(cardDiv, config);
          card.render();
          metricCards.push(card);
        }
      });
    }
    
    async function renderSkillRadar(analytics) {
      const container = document.getElementById('skill-radar-container');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Build skills object from analytics
      const skills = {};
      
      // Add strength and growth areas
      if (analytics?.strengthAreas) {
        analytics.strengthAreas.forEach(area => {
          skills[area.topic] = area.score;
        });
      }
      if (analytics?.growthAreas) {
        analytics.growthAreas.forEach(area => {
          skills[area.topic] = area.score;
        });
      }
      
      // Also use learning style breakdown for more skill data
      if (analytics?.learningStyle?.breakdown) {
        const activityTypeNames = {
          'drag-drop': 'Drag & Drop',
          'matching': 'Matching',
          'code-completion': 'Code',
          'free-response': 'Writing',
          'multiple-choice': 'Quiz',
          'fill-blank': 'Fill-in'
        };
        Object.entries(analytics.learningStyle.breakdown).forEach(([type, score]) => {
          const displayName = activityTypeNames[type] || type;
          if (!skills[displayName]) {
            skills[displayName] = score;
          }
        });
      }
      
      // Show empty state if no skills data
      if (Object.keys(skills).length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 280px; color: var(--text-secondary); text-align: center; padding: 1rem;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5;">üìä</div>
            <div style="font-weight: 500; margin-bottom: 0.25rem;">No Skills Data Yet</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">Complete activities to see your skill breakdown</div>
          </div>
        `;
        return;
      }
      
      skillRadar = new SkillRadar(container, {
        skills: skills,
        size: 280,
        showLabels: true,
        showValues: true,
        animate: true
      });
      skillRadar.render();
    }
    
    async function renderProgressTimeline(userId) {
      const container = document.getElementById('progress-timeline-container');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Get milestones from enrolled courses
      let milestones = [];
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        console.log('üìä Timeline: Got courses', courses);
        
        for (const course of courses) {
          const courseId = course.courseId || course.id;
          if (course.lessons) {
            Object.entries(course.lessons).forEach(([lessonId, lessonData]) => {
              if (lessonData.completed) {
                let completedAt = null;
                
                // Handle different timestamp formats
                if (lessonData.completedAt) {
                  if (lessonData.completedAt._seconds) {
                    completedAt = new Date(lessonData.completedAt._seconds * 1000);
                  } else if (lessonData.completedAt.seconds) {
                    completedAt = new Date(lessonData.completedAt.seconds * 1000);
                  } else if (lessonData.completedAt.toDate) {
                    completedAt = lessonData.completedAt.toDate();
                  } else if (typeof lessonData.completedAt === 'string') {
                    completedAt = new Date(lessonData.completedAt);
                  } else {
                    completedAt = new Date(lessonData.completedAt);
                  }
                }
                
                // Fallback timestamps
                if (!completedAt || isNaN(completedAt.getTime())) {
                  if (lessonData.lastViewedAt) {
                    completedAt = lessonData.lastViewedAt._seconds 
                      ? new Date(lessonData.lastViewedAt._seconds * 1000)
                      : new Date(lessonData.lastViewedAt.seconds * 1000);
                  } else if (course.lastActivity) {
                    completedAt = course.lastActivity._seconds
                      ? new Date(course.lastActivity._seconds * 1000)
                      : new Date(course.lastActivity.seconds * 1000);
                  } else {
                    completedAt = new Date();
                  }
                }
                
                if (completedAt && !isNaN(completedAt.getTime())) {
                  const formattedLesson = lessonId.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                  milestones.push({
                    title: formattedLesson,
                    timestamp: completedAt.toISOString(),
                    type: 'lesson',
                    course: courseId
                  });
                }
              }
            });
          }
        }
        
        console.log('üìä Timeline: Found milestones', milestones);
        
      } catch (error) {
        console.log('üìä Error loading timeline data:', error);
      }
      
      // Sort chronologically (oldest first for timeline graph)
      milestones.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      // Use the new TimelineGraph component
      const timelineGraph = new TimelineGraph(container, {
        milestones: milestones,
        height: 320,
        animate: true
      });
      timelineGraph.render();
    }
    
    async function renderRecommendations(userId, analytics) {
      const container = document.getElementById('recommendations-container');
      if (!container) return;
      
      console.log('üìä Recommendations: analytics received', analytics);
      
      // Don't overwrite if called with undefined (second call from elsewhere)
      if (!analytics) {
        console.log('üìä Recommendations: No analytics, skipping render');
        return;
      }
      
      container.innerHTML = '';
      
      console.log('üìä Recommendations: growthAreas', analytics?.growthAreas);
      console.log('üìä Recommendations: engagementPatterns', analytics?.engagementPatterns);
      
      // Generate recommendations from analytics data
      let recommendations = [];
      
      if (analytics) {
        // Build recommendations from growth areas
        if (analytics.growthAreas && analytics.growthAreas.length > 0) {
          analytics.growthAreas.slice(0, 2).forEach(area => {
            const resource = area.suggestedResources?.[0];
            recommendations.push({
              type: 'growth',
              priority: 'high',
              icon: 'üéØ',
              title: `Practice ${area.topic.charAt(0).toUpperCase() + area.topic.slice(1)}`,
              reason: `Your score is ${Math.round(area.score * 100)}%. ${resource ? `Try: ${resource.title}` : 'Keep practicing!'}`,
              estimatedTime: 15
            });
          });
        }
        
        // Streak recommendation
        const streak = analytics.engagementPatterns?.currentStreak || 0;
        const streakRecord = analytics.engagementPatterns?.streakRecord || 0;
        if (streak > 0 && streak < streakRecord) {
          recommendations.push({
            type: 'streak',
            priority: 'medium',
            icon: 'üî•',
            title: `Keep Your ${streak}-Day Streak`,
            reason: `You're ${streakRecord - streak} days from your record!`,
            estimatedTime: 10
          });
        } else if (streak === 0 && streakRecord > 0) {
          recommendations.push({
            type: 'streak',
            priority: 'medium',
            icon: 'üî•',
            title: 'Restart Your Streak',
            reason: `You had a ${streakRecord}-day streak before!`,
            estimatedTime: 10
          });
        }
        
        // Learning style tip
        if (analytics.learningStyle?.primary) {
          const styleNames = { kinesthetic: 'Hands-On', visual: 'Visual', auditory: 'Auditory', reading: 'Reading' };
          recommendations.push({
            type: 'style',
            priority: 'low',
            icon: 'üí°',
            title: `${styleNames[analytics.learningStyle.primary] || 'Your'} Learning Tip`,
            reason: analytics.learningStyle.primary === 'kinesthetic' 
              ? 'Try the interactive code exercises for better retention'
              : 'Focus on content that matches your style',
            estimatedTime: 5
          });
        }
      }
      
      // Show empty state if no recommendations
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px; color: var(--text-secondary); text-align: center; padding: 1rem;">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;">üí°</div>
            <div style="font-weight: 500; margin-bottom: 0.25rem;">No Recommendations Yet</div>
            <div style="font-size: 0.85rem; opacity: 0.8;">Complete more activities to unlock personalized suggestions</div>
          </div>
        `;
        return;
      }
      
      recommendationList = new RecommendationList(container, {
        recommendations: recommendations,
        maxItems: 3,
        animate: true,
        onRecommendationClick: (rec) => {
          if (rec.lessonPath) {
            window.location.href = rec.lessonPath;
          }
        }
      });
      recommendationList.render();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NEW VISUAL COMPONENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function renderActivityHeatmap(userId) {
      const container = document.getElementById('activity-heatmap-container');
      if (!container || !window.ActivityHeatmap) return;
      
      // Build activity data from attempts
      const activityData = [];
      try {
        const courses = await window.DataService.getEnrolledCourses();
        const dateMap = new Map();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              if (lesson.completedAt || lesson.lastViewedAt) {
                const ts = lesson.completedAt || lesson.lastViewedAt;
                const date = ts._seconds 
                  ? new Date(ts._seconds * 1000) 
                  : ts.seconds 
                    ? new Date(ts.seconds * 1000)
                    : new Date(ts);
                const dateStr = date.toISOString().split('T')[0];
                dateMap.set(dateStr, (dateMap.get(dateStr) || 0) + 1);
              }
            });
          }
        });
        
        dateMap.forEach((count, date) => {
          activityData.push({ date, count });
        });
      } catch (e) {
        console.log('üìä Could not load activity data for heatmap');
      }
      
      const heatmap = new ActivityHeatmap(container, {
        data: activityData,
        weeks: 12
      });
      heatmap.render();
    }
    
    async function renderStreakDisplay(analytics) {
      const container = document.getElementById('streak-display-container');
      if (!container || !window.StreakDisplay) return;
      
      const currentStreak = analytics?.engagementPatterns?.currentStreak || 0;
      const streakRecord = analytics?.engagementPatterns?.streakRecord || 0;
      
      const streakDisplay = new StreakDisplay(container, {
        currentStreak,
        streakRecord,
        animate: true
      });
      streakDisplay.render();
    }
    
    async function renderWeeklyChart(analytics) {
      const container = document.getElementById('weekly-chart-container');
      if (!container || !window.WeeklyChart) return;
      
      // Build weekly data
      const weeklyData = { Sun: 0, Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0 };
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              if (lesson.completedAt || lesson.lastViewedAt) {
                const ts = lesson.completedAt || lesson.lastViewedAt;
                const date = ts._seconds 
                  ? new Date(ts._seconds * 1000) 
                  : ts.seconds 
                    ? new Date(ts.seconds * 1000)
                    : new Date(ts);
                const dayName = dayNames[date.getDay()];
                weeklyData[dayName]++;
              }
            });
          }
        });
      } catch (e) {
        console.log('üìä Could not load weekly data');
      }
      
      const weeklyChart = new WeeklyChart(container, {
        data: weeklyData,
        height: 100,
        animate: true
      });
      weeklyChart.render();
    }
    
    async function renderProgressChart(userId) {
      const container = document.getElementById('progress-chart-container');
      if (!container || !window.ProgressChart) return;
      
      const progressData = [];
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        const completions = [];
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.entries(course.lessons).forEach(([lessonId, lesson]) => {
              if (lesson.completed && (lesson.completedAt || lesson.lastViewedAt)) {
                const ts = lesson.completedAt || lesson.lastViewedAt;
                const date = ts._seconds 
                  ? new Date(ts._seconds * 1000) 
                  : ts.seconds 
                    ? new Date(ts.seconds * 1000)
                    : new Date(ts);
                if (!isNaN(date.getTime())) {
                  completions.push({ date, lessonId });
                }
              }
            });
          }
        });
        
        completions.sort((a, b) => a.date - b.date);
        const totalLessons = completions.length + 5;
        
        completions.forEach((c, i) => {
          progressData.push({
            date: c.date.toISOString().split('T')[0],
            value: Math.min(((i + 1) / totalLessons) * 100, 100),
            label: c.lessonId
          });
        });
      } catch (e) {
        console.log('üìä Could not load progress data');
      }
      
      const progressChart = new ProgressChart(container, {
        data: progressData,
        height: 130,
        animate: true,
        formatValue: (v) => `${Math.round(v)}%`
      });
      progressChart.render();
    }
    
    async function renderAccuracyChart(userId) {
      const container = document.getElementById('accuracy-chart-container');
      if (!container || !window.AccuracyChart) return;
      
      const accuracyData = [];
      
      try {
        // Get quiz attempts and group by date
        const courses = await window.DataService.getEnrolledCourses();
        const attemptsByDate = new Map();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              if (lesson.completedAt) {
                const ts = lesson.completedAt;
                const date = ts._seconds 
                  ? new Date(ts._seconds * 1000) 
                  : ts.seconds 
                    ? new Date(ts.seconds * 1000)
                    : new Date(ts);
                if (!isNaN(date.getTime())) {
                  const dateStr = date.toISOString().split('T')[0];
                  const current = attemptsByDate.get(dateStr) || { correct: 0, total: 0 };
                  current.total++;
                  if (lesson.progressPercent >= 80) current.correct++;
                  attemptsByDate.set(dateStr, current);
                }
              }
            });
          }
        });
        
        attemptsByDate.forEach((stats, date) => {
          if (stats.total > 0) {
            accuracyData.push({
              date,
              accuracy: Math.round((stats.correct / stats.total) * 100)
            });
          }
        });
        
        accuracyData.sort((a, b) => new Date(a.date) - new Date(b.date));
      } catch (e) {
        console.log('üìä Could not load accuracy data');
      }
      
      const chart = new AccuracyChart(container, {
        data: accuracyData,
        height: 130
      });
      chart.render();
    }
    
    async function renderTimeDistributionChart(userId) {
      const container = document.getElementById('time-distribution-container');
      if (!container || !window.TimeDistributionChart) return;
      
      const timeData = { 'Stories': 0, 'Quizzes': 0, 'Practice': 0 };
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              // Estimate time based on progress
              const baseTime = 15; // 15 min per lesson estimate
              const pct = (lesson.progressPercent || 0) / 100;
              const storyTime = baseTime * pct * 0.6;
              const quizTime = baseTime * pct * 0.3;
              const practiceTime = baseTime * pct * 0.1;
              
              timeData['Stories'] += storyTime;
              timeData['Quizzes'] += quizTime;
              timeData['Practice'] += practiceTime;
            });
          }
        });
      } catch (e) {
        console.log('üìä Could not load time data');
      }
      
      const chart = new TimeDistributionChart(container, {
        data: timeData,
        height: 130
      });
      chart.render();
    }
    
    async function renderCourseBreakdownChart(userId) {
      const container = document.getElementById('course-breakdown-container');
      if (!container || !window.CourseBreakdownChart) return;
      
      const courseData = [];
      const chaptersPerCourse = {
        'apprentice': 7,
        'junior': 7,
        'senior': 7,
        'undergrad': 7,
        'endless-opportunities': 5
      };
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        
        courses.forEach(course => {
          const total = chaptersPerCourse[course.courseId] || 7;
          let completed = 0;
          
          if (course.lessons) {
            completed = Object.values(course.lessons).filter(l => l.completed).length;
          }
          
          courseData.push({
            course: course.courseId,
            completed,
            total
          });
        });
      } catch (e) {
        console.log('üìä Could not load course data');
      }
      
      const chart = new CourseBreakdownChart(container, {
        data: courseData,
        height: 130
      });
      chart.render();
    }
    
    async function renderActivityTypesChart(userId) {
      const container = document.getElementById('activity-types-container');
      if (!container || !window.ActivityTypesChart) return;
      
      const activityData = {};
      
      try {
        const courses = await window.DataService.getEnrolledCourses();
        
        courses.forEach(course => {
          if (course.lessons) {
            Object.values(course.lessons).forEach(lesson => {
              if (lesson.viewedSections) {
                activityData['Story'] = (activityData['Story'] || 0) + lesson.viewedSections;
              }
              if (lesson.completed) {
                activityData['Quiz'] = (activityData['Quiz'] || 0) + 1;
              }
            });
          }
        });
        
        // Add some default categories if we have any data
        if (Object.keys(activityData).length > 0) {
          activityData['Review'] = Math.round((activityData['Story'] || 0) * 0.2);
        }
      } catch (e) {
        console.log('üìä Could not load activity types');
      }
      
      const chart = new ActivityTypesChart(container, {
        data: activityData,
        height: 130
      });
      chart.render();
    }
    
    function renderErrorState(error) {
      const section = document.getElementById('component-analytics-section');
      if (!section) return;
      
      // Show error in each container
      const containers = [
        'metrics-row',
        'skill-radar-container', 
        'progress-timeline-container',
        'recommendations-container'
      ];
      
      containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
          container.innerHTML = `
            <div class="error-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; color: var(--text-secondary); text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
              <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚ö†Ô∏è</div>
              <div style="font-size: 0.85rem;">Unable to load analytics</div>
            </div>
          `;
        }
      });
      
      console.error('üìä Analytics error state rendered:', error);
    }
  </script>
</body>
</html>

