<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Play Simulator | AutoNateAI</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Auth guard -->
  <style>
    .dashboard { display: none !important; }
    .dashboard.ready { display: flex !important; }
    .auth-loading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #0a0a0f;
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .auth-loading.hidden { display: none; }
    .loading-content { text-align: center; color: #e8e8f0; }
    .loading-icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(121, 134, 203, 0.3);
      border-top-color: #7986cb; border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <script src="../shared/js/theme-loader.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="../shared/css/dashboard.css">
  <link rel="stylesheet" href="../shared/css/basketball-sim.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Cytoscape.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>

  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>

  <!-- Loading Screen -->
  <div class="auth-loading" id="auth-loading">
    <div class="loading-content">
      <div class="loading-icon">&#127936;</div>
      <div class="loading-spinner"></div>
      <p>Loading Play Simulator...</p>
    </div>
  </div>

  <div class="dashboard" id="dashboard-content">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="../index.html" class="sidebar-logo">
        <div class="logo-icon">&#127936;</div>
        <span class="logo-text">AutoNateAI</span>
      </a>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">Main</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="index.html" class="nav-link">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">
                <span class="nav-icon">üìö</span>
                <span class="nav-text">Course Library</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="challenges.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span class="nav-text">Daily Challenges</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Learning Section (admin only) -->
        <div class="nav-section" id="learning-section" style="display: none;">
          <span class="nav-section-title">Learning</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="progress.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">My Progress</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="achievements.html" class="nav-link">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-text">Achievements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="notes.html" class="nav-link">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">Notes</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Community Section (admin only) -->
        <div class="nav-section" id="community-section" style="display: none;">
          <span class="nav-section-title">Community</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="feed.html" class="nav-link">
                <span class="nav-icon">üì∞</span>
                <span class="nav-text">Feed</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="https://discord.gg/Me5N8tCdkC" target="_blank" class="nav-link">
                <span class="nav-icon">üí¨</span>
                <span class="nav-text">Discord</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="leaderboard.html" class="nav-link">
                <span class="nav-icon">üèÖ</span>
                <span class="nav-text">Leaderboard</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title" style="color: #ef4444;">Basketball</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="basketball-sim.html" class="nav-link active">
                <span class="nav-icon">üèÄ</span>
                <span class="nav-text">Play Simulator</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Account</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="profile.html" class="nav-link">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="settings.html" class="nav-link">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Admin Section (admin only) -->
        <div class="nav-section" id="admin-section" style="display: none;">
          <span class="nav-section-title" style="color: #f44336;">Admin</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="../admin/" class="nav-link">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">Admin Dashboard</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="sidebar-user">
        <div class="user-card" id="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-streak">
              <span>&#127936;</span>
              <span>Play Simulator</span>
            </div>
          </div>
        </div>
      </div>

      <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </aside>

    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-menu-btn" id="mobile-menu-btn">&#9776;</button>
          <h1 class="page-title">Play Simulator</h1>
        </div>
        <div class="header-right">
          <button class="toolbar-btn panel-toggle-btn" id="panel-toggle-btn" style="display:none;">
            AI Chat &#128172;
          </button>
        </div>
      </header>

      <!-- Simulator Layout -->
      <div class="sim-layout">

        <!-- Toolbar -->
        <div class="sim-toolbar">
          <div class="toolbar-group">
            <span class="toolbar-label">Play</span>
            <select class="toolbar-select" id="play-select">
              <option value="">-- Select Play --</option>
              <optgroup label="Preset Plays">
                <option value="pick-and-roll">Pick and Roll</option>
                <option value="give-and-go">Give and Go</option>
                <option value="backdoor-cut">Backdoor Cut</option>
                <option value="motion-weak">Motion Weak Side</option>
              </optgroup>
              <optgroup label="My Plays" id="my-plays-group">
              </optgroup>
            </select>
          </div>

          <div class="toolbar-group">
            <span class="toolbar-label">Formation</span>
            <select class="toolbar-select" id="formation-select">
              <option value="horns">Horns</option>
              <option value="1-4-high">1-4 High</option>
              <option value="1-3-1">1-3-1</option>
              <option value="spread">5-Out Spread</option>
              <option value="box">Box Set</option>
            </select>
          </div>

          <div class="toolbar-group">
            <span class="toolbar-label">Defense</span>
            <select class="toolbar-select" id="defense-select">
              <option value="man">Man-to-Man</option>
              <option value="2-3-zone">2-3 Zone</option>
              <option value="3-2-zone">3-2 Zone</option>
              <option value="1-3-1-zone">1-3-1 Zone</option>
            </select>
          </div>

          <div class="toolbar-spacer"></div>

          <div class="toolbar-group">
            <button class="toolbar-btn" id="save-play-btn" title="Save current play">Save</button>
            <button class="toolbar-btn" id="reset-btn" title="Reset to formation">Reset</button>
          </div>
        </div>

        <!-- Court Area -->
        <div class="sim-court-area">
          <div class="court-wrapper">
            <div class="court-svg-container" id="court-svg"></div>
            <div class="court-cy-container" id="court-cy"></div>
          </div>

          <div class="court-legend">
            <div class="legend-item"><div class="legend-dot offense"></div> Offense</div>
            <div class="legend-item"><div class="legend-dot defense"></div> Defense</div>
            <div class="legend-item"><div class="legend-dot ball"></div> Ball</div>
          </div>
        </div>

        <!-- Play Controls -->
        <div class="sim-controls">
          <div class="controls-row">
            <div class="play-controls">
              <button class="ctrl-btn" id="ctrl-stop" title="Stop/Reset">&#9632;</button>
              <button class="ctrl-btn" id="ctrl-prev" title="Previous step">&#9664;&#9664;</button>
              <button class="ctrl-btn play-btn" id="ctrl-play" title="Play/Pause">&#9654;</button>
              <button class="ctrl-btn" id="ctrl-next" title="Next step">&#9654;&#9654;</button>
            </div>

            <div class="timeline-section">
              <div class="timeline-bar" id="timeline-bar">
                <div class="timeline-progress" id="timeline-progress" style="width: 0%"></div>
              </div>
              <div class="timeline-info">
                <span class="timeline-step-text" id="timeline-step-text">Formation</span>
                <span class="timeline-step-desc" id="timeline-step-desc">Select a play to begin</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel (AI Chat + Notes) -->
        <div class="sim-right-panel" id="right-panel">
          <div class="panel-tabs">
            <button class="panel-tab active" data-tab="chat">Coach AI</button>
            <button class="panel-tab" data-tab="notes">Notes</button>
          </div>

          <!-- AI Chat Panel -->
          <div class="panel-content active" id="tab-chat">
            <div class="plays-section">
              <div class="plays-section-title">Quick Plays</div>
              <div id="quick-plays">
                <span class="play-chip" data-prompt="Create a pick and roll play">Pick &amp; Roll</span>
                <span class="play-chip" data-prompt="Set up a give and go">Give &amp; Go</span>
                <span class="play-chip" data-prompt="Design a backdoor cut">Backdoor</span>
                <span class="play-chip" data-prompt="Run motion offense weak side">Motion</span>
                <span class="play-chip" data-prompt="What formations work best against a 2-3 zone?">vs Zone</span>
              </div>
            </div>

            <div class="chat-messages" id="chat-messages">
              <div class="chat-message assistant">
                <div class="chat-avatar">&#127936;</div>
                <div class="chat-bubble">
                  What's good Coach! I'm your AI basketball strategy assistant. Tell me what play you want to run and I'll set it up on the court. You can also drag players around to adjust positions.
                </div>
              </div>
            </div>

            <div class="chat-input-area">
              <div class="chat-input-row">
                <input type="text" class="chat-input" id="chat-input"
                       placeholder="Describe a play or ask a question..."
                       autocomplete="off">
                <button class="chat-send-btn" id="chat-send">&#10148;</button>
              </div>
            </div>
          </div>

          <!-- Notes Panel -->
          <div class="panel-content" id="tab-notes">
            <div class="notes-panel">
              <div class="notes-input-area">
                <div class="notes-input-row">
                  <input type="text" class="notes-input" id="notes-input"
                         placeholder="Quick note..." autocomplete="off">
                  <button class="notes-add-btn" id="notes-add">+ Add</button>
                </div>
              </div>
              <div class="notes-list" id="notes-list"></div>
            </div>
          </div>
        </div>

      </div><!-- /sim-layout -->

    </main>
  </div>

  <!-- Panel overlay (tablet) -->
  <div class="panel-overlay" id="panel-overlay"></div>

  <!-- Core Services -->
  <script src="../shared/js/firebase-config.js"></script>
  <script src="../shared/js/auth.js"></script>
  <script src="../shared/js/rbac.js"></script>
  <script src="../shared/js/data-service.js"></script>

  <!-- Basketball Modules -->
  <script src="../shared/js/basketball/play-data.js"></script>
  <script src="../shared/js/basketball/court-renderer.js"></script>
  <script src="../shared/js/basketball/play-engine.js"></script>
  <script src="../shared/js/basketball/ai-service.js"></script>
  <script src="../shared/js/basketball/notes-manager.js"></script>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // APP INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('auth-loading');
      const dashboardContent = document.getElementById('dashboard-content');

      // Initialize Firebase
      if (!window.FirebaseApp.init()) {
        loadingScreen.innerHTML = '<div class="loading-content"><p>Error loading. Please refresh.</p></div>';
        return;
      }

      window.AuthService.init();
      const user = await window.AuthService.waitForAuthState();

      if (!user) {
        window.AuthService.setRedirectUrl(window.location.href);
        window.location.href = '../auth/login.html';
        return;
      }

      // Check access: must be city-high-basketball org member or admin
      const hasAccess = await window.RBACService.belongsToOrganization('city-high-basketball');
      const isAdmin = await window.RBACService.hasRole('admin');

      if (!hasAccess && !isAdmin) {
        window.RBACService.handleAccessDenied('organization');
        return;
      }

      // Show full nav sections for admins
      if (isAdmin) {
        document.getElementById('learning-section').style.display = '';
        document.getElementById('community-section').style.display = '';
        document.getElementById('admin-section').style.display = 'block';
      }

      // Show dashboard
      loadingScreen.classList.add('hidden');
      dashboardContent.classList.add('ready');

      // Load user info
      loadUserInfo(user);

      // Initialize all modules
      setupSidebar();
      setupLogout();
      initSimulator();
    });

    function loadUserInfo(user) {
      const displayName = user.displayName || user.email.split('@')[0];
      document.getElementById('user-name').textContent = displayName;

      const avatar = document.getElementById('user-avatar');
      if (user.photoURL) {
        avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
      } else {
        avatar.textContent = displayName.charAt(0).toUpperCase();
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SIMULATOR INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function initSimulator() {
      // Initialize court renderer
      window.CourtRenderer.init('court-cy', 'court-svg');

      // Initialize play engine
      window.PlayEngine.init(window.CourtRenderer);

      // Initialize AI service (look for API key in localStorage)
      const apiKey = localStorage.getItem('openai_api_key') || null;
      window.BasketballAI.init(apiKey);

      // Initialize notes
      window.NotesManager.init('notes-list', (snapshot, stepIndex) => {
        // Load snapshot callback
        if (snapshot.play) {
          window.PlayEngine.loadPlay(snapshot.play);
          if (stepIndex > -1) {
            window.PlayEngine.goToStep(stepIndex);
          }
        }
      });

      // Load default formation
      loadFormation('horns', 'man');

      // Setup all event handlers
      setupToolbar();
      setupPlayControls();
      setupChat();
      setupNotes();
      setupPanelTabs();
      setupPanelToggle();

      // Load user's saved plays
      loadUserPlays();

      // Step change listener
      window.PlayEngine.onStepChange(updateTimeline);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TOOLBAR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setupToolbar() {
      const playSelect = document.getElementById('play-select');
      const formationSelect = document.getElementById('formation-select');
      const defenseSelect = document.getElementById('defense-select');
      const saveBtn = document.getElementById('save-play-btn');
      const resetBtn = document.getElementById('reset-btn');

      // Play selection
      playSelect.addEventListener('change', () => {
        const playId = playSelect.value;
        if (!playId) return;

        const preset = window.PlayData.PRESET_PLAYS[playId];
        if (preset) {
          const play = window.PlayData.loadPreset(playId);
          window.PlayEngine.loadPlay(play);

          // Update formation dropdown to match
          if (preset.formation) {
            formationSelect.value = preset.formation;
          }
        } else {
          // User's saved play
          loadSavedPlay(playId);
        }
      });

      // Formation change
      formationSelect.addEventListener('change', () => {
        loadFormation(formationSelect.value, defenseSelect.value);
        playSelect.value = '';
      });

      // Defense change
      defenseSelect.addEventListener('change', () => {
        loadFormation(formationSelect.value, defenseSelect.value);
        playSelect.value = '';
      });

      // Save
      saveBtn.addEventListener('click', async () => {
        const play = window.PlayEngine.getCurrentPlay();
        if (!play) return;

        const name = prompt('Play name:', play.name || 'My Play');
        if (!name) return;

        play.name = name;
        const id = await window.PlayData.savePlay(play);
        if (id) {
          saveBtn.textContent = 'Saved!';
          setTimeout(() => { saveBtn.textContent = 'Save'; }, 1500);
          loadUserPlays();
        }
      });

      // Reset
      resetBtn.addEventListener('click', () => {
        window.PlayEngine.stop();
      });
    }

    function loadFormation(formationId, defenseType) {
      const formation = window.PlayData.FORMATIONS[formationId];
      if (!formation) return;

      let defense;
      if (defenseType === 'man') {
        defense = window.PlayData.getManToManDefense(formation.offense);
      } else {
        const zoneDef = window.PlayData.DEFENSE_FORMATIONS[defenseType];
        defense = zoneDef ? zoneDef.defense : window.PlayData.getManToManDefense(formation.offense);
      }

      const ball = { holder: 'o1' };
      window.CourtRenderer.setFormation(formation.offense, defense, ball);
    }

    async function loadUserPlays() {
      const plays = await window.PlayData.loadPlays();
      const group = document.getElementById('my-plays-group');
      group.innerHTML = '';

      plays.forEach(play => {
        const option = document.createElement('option');
        option.value = play.id;
        option.textContent = play.name || 'Untitled Play';
        group.appendChild(option);
      });
    }

    async function loadSavedPlay(playId) {
      const plays = await window.PlayData.loadPlays();
      const play = plays.find(p => p.id === playId);
      if (play) {
        window.PlayEngine.loadPlay(play);
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PLAY CONTROLS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setupPlayControls() {
      const playBtn = document.getElementById('ctrl-play');
      const stopBtn = document.getElementById('ctrl-stop');
      const prevBtn = document.getElementById('ctrl-prev');
      const nextBtn = document.getElementById('ctrl-next');
      const timelineBar = document.getElementById('timeline-bar');

      playBtn.addEventListener('click', () => {
        if (window.PlayEngine.isPlaying()) {
          window.PlayEngine.pause();
        } else {
          window.PlayEngine.play();
        }
      });

      stopBtn.addEventListener('click', () => {
        window.PlayEngine.stop();
      });

      prevBtn.addEventListener('click', () => {
        window.PlayEngine.stepBackward();
      });

      nextBtn.addEventListener('click', () => {
        window.PlayEngine.stepForward();
      });

      // Timeline click to seek
      timelineBar.addEventListener('click', (e) => {
        const rect = timelineBar.getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        const totalSteps = window.PlayEngine.getTotalSteps();
        if (totalSteps > 0) {
          const step = Math.round(pct * totalSteps) - 1;
          window.PlayEngine.goToStep(step);
        }
      });
    }

    function updateTimeline({ step, total, description, isPlaying }) {
      const playBtn = document.getElementById('ctrl-play');
      const progress = document.getElementById('timeline-progress');
      const stepText = document.getElementById('timeline-step-text');
      const stepDesc = document.getElementById('timeline-step-desc');

      // Update play/pause icon
      playBtn.innerHTML = isPlaying ? '&#10074;&#10074;' : '&#9654;';

      // Update progress bar
      if (total > 0) {
        const pct = ((step + 1) / total) * 100;
        progress.style.width = Math.max(0, pct) + '%';
      } else {
        progress.style.width = '0%';
      }

      // Update text
      if (step === -1) {
        stepText.textContent = 'Formation';
      } else {
        stepText.textContent = `Step ${step + 1} / ${total}`;
      }
      stepDesc.textContent = description;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AI CHAT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setupChat() {
      const input = document.getElementById('chat-input');
      const sendBtn = document.getElementById('chat-send');
      const messages = document.getElementById('chat-messages');

      async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        // Add user message
        appendChatMessage('user', text);
        input.value = '';
        sendBtn.disabled = true;

        // Get AI response
        const response = await window.BasketballAI.chat(text);

        // Add assistant message
        appendChatMessage('assistant', response.text, response.play);

        // If a play was generated, load it
        if (response.play) {
          window.PlayEngine.loadPlay(response.play);
        }

        sendBtn.disabled = false;
        input.focus();
      }

      sendBtn.addEventListener('click', sendMessage);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Quick play chips
      document.querySelectorAll('.play-chip[data-prompt]').forEach(chip => {
        chip.addEventListener('click', () => {
          input.value = chip.dataset.prompt;
          sendMessage();
        });
      });
    }

    function appendChatMessage(role, text, play) {
      const messages = document.getElementById('chat-messages');
      const avatar = role === 'assistant' ? '&#127936;' : '&#128100;';

      // Format text: bold markers and newlines
      let html = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');

      if (play) {
        html += `<div class="play-loaded" onclick="window.PlayEngine.loadPlay(window._lastLoadedPlay)">
          &#9654; Play loaded on court - ${play.name}
        </div>`;
        window._lastLoadedPlay = play;
      }

      const div = document.createElement('div');
      div.className = `chat-message ${role}`;
      div.innerHTML = `
        <div class="chat-avatar">${avatar}</div>
        <div class="chat-bubble">${html}</div>
      `;

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NOTES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setupNotes() {
      const input = document.getElementById('notes-input');
      const addBtn = document.getElementById('notes-add');

      function addNote() {
        const text = input.value.trim();
        if (!text) return;

        const snapshot = window.PlayEngine.getSnapshot();
        window.NotesManager.createNote(text, snapshot);
        input.value = '';
      }

      addBtn.addEventListener('click', addNote);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addNote();
        }
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL TABS & TOGGLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setupPanelTabs() {
      document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Deactivate all
          document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));

          // Activate selected
          tab.classList.add('active');
          const tabId = 'tab-' + tab.dataset.tab;
          document.getElementById(tabId)?.classList.add('active');
        });
      });
    }

    function setupPanelToggle() {
      const toggleBtn = document.getElementById('panel-toggle-btn');
      const panel = document.getElementById('right-panel');
      const overlay = document.getElementById('panel-overlay');

      toggleBtn.addEventListener('click', () => {
        panel.classList.toggle('open');
        overlay.classList.toggle('active');
      });

      overlay.addEventListener('click', () => {
        panel.classList.remove('open');
        overlay.classList.remove('active');
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SIDEBAR (reused from dashboard)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      const overlay = document.getElementById('sidebar-overlay');
      const mobileBtn = document.getElementById('mobile-menu-btn');

      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        // Re-fit court on sidebar resize
        setTimeout(() => window.CourtRenderer._fitViewport(), 350);
      });

      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }

      mobileBtn.addEventListener('click', () => {
        sidebar.classList.add('open');
      });

      overlay.addEventListener('click', () => {
        sidebar.classList.remove('open');
      });
    }

    function setupLogout() {
      document.getElementById('logout-link').addEventListener('click', async (e) => {
        e.preventDefault();
        await window.AuthService.logout();
        window.location.href = '../index.html';
      });
    }
  </script>

</body>
</html>
