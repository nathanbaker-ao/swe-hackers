<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Tools Library | AutoNateAI</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Critical styles - must load before body renders -->
  <style>
    /* Hide content until auth is confirmed */
    .dashboard { display: none !important; }
    .dashboard.ready { display: flex !important; }

    /* Loading screen - shown immediately */
    .auth-loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0a0a0f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .auth-loading.hidden { display: none; }
    .loading-content { text-align: center; color: #e8e8f0; }
    .loading-icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(121, 134, 203, 0.3);
      border-top-color: #7986cb;
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <!-- Theme loader (before CSS to prevent flash) -->
  <script src="../shared/js/theme-loader.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="../shared/css/dashboard.css">
  <link rel="stylesheet" href="../shared/css/library.css">
  <link rel="stylesheet" href="../shared/css/i18n.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>

  <!-- Loading Screen -->
  <div class="auth-loading" id="auth-loading">
    <div class="loading-content">
      <div class="loading-icon">üì¶</div>
      <div class="loading-spinner"></div>
      <p>Loading your library...</p>
    </div>
  </div>

  <div class="dashboard" id="dashboard-content">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="../index.html" class="sidebar-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <span class="logo-text">AutoNateAI</span>
      </a>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title" data-i18n="nav.main">Main</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="feed.html" class="nav-link">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Feed</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="library.html" class="nav-link active">
                <span class="nav-icon">üîß</span>
                <span class="nav-text">Tools Library</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Account</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="profile.html" class="nav-link">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="orders.html" class="nav-link">
                <span class="nav-icon">üõçÔ∏è</span>
                <span class="nav-text">Orders & Returns</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Basketball Section (hidden by default) -->
        <div class="nav-section" id="basketball-section" style="display: none;">
          <span class="nav-section-title" style="color: #ef4444;">Basketball</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="basketball-sim.html" class="nav-link">
                <span class="nav-icon">üèÄ</span>
                <span class="nav-text">Play Simulator</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Admin Section (hidden by default) -->
        <div class="nav-section" id="admin-section" style="display: none;">
          <span class="nav-section-title" style="color: #f44336;">Admin</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="../admin/" class="nav-link">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">Admin Dashboard</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="sidebar-user">
        <div class="user-card" id="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-streak">
              <span>üî•</span>
              <span id="user-streak">0</span> day streak
            </div>
          </div>
        </div>
      </div>

      <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </aside>

    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
          <h1 class="page-title" data-i18n="library.title">My Tools Library</h1>
        </div>
        <div class="header-right">
          <div class="lang-selector" id="lang-selector">
            <button class="action-btn lang-btn" id="lang-btn" title="Language">
              <span class="lang-flag" id="lang-flag">üá∫üá∏</span>
              <span class="lang-code" id="lang-code">EN</span>
            </button>
            <div class="lang-dropdown" id="lang-dropdown"></div>
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="content-area">

        <!-- Stats Bar (populated by JS) -->
        <div class="library-stats" id="library-stats" style="display: none;">
          <div class="library-stat">
            <div class="library-stat__icon">üîß</div>
            <span class="library-stat__value" id="stat-total">0</span>
            <span class="library-stat__label">Tools Owned</span>
          </div>
          <div class="library-stat">
            <div class="library-stat__icon">üìÖ</div>
            <span class="library-stat__value" id="stat-recent">0</span>
            <span class="library-stat__label">Added This Month</span>
          </div>
          <div class="library-stat">
            <div class="library-stat__icon">üéØ</div>
            <span class="library-stat__value" id="stat-platforms">0</span>
            <span class="library-stat__label">Platforms Covered</span>
          </div>
        </div>

        <!-- Featured Tool (populated by JS) -->
        <div id="library-featured-container"></div>

        <!-- Library Grid -->
        <div id="library-content">
          <!-- Cards or empty state rendered by JS -->
        </div>

      </div>
    </main>

  </div>

  <!-- Scripts -->
  <script src="../shared/js/firebase-config.js"></script>
  <script src="../shared/js/auth.js"></script>
  <script src="../shared/js/rbac.js"></script>
  <script src="../shared/js/whop-service.js"></script>
  <script src="../shared/js/purchase-service.js"></script>

  <script>
    // =========================================================================
    // RENDER
    // =========================================================================

    const PLATFORM_LABELS = {
      linkedin: 'LinkedIn',
      facebook: 'Facebook',
      reddit: 'Reddit',
      twitter: 'Twitter/X',
      google: 'Google',
      multi: 'Multi-Platform'
    };

    function renderLibrary(products) {
      const content = document.getElementById('library-content');
      const statsBar = document.getElementById('library-stats');
      const featuredContainer = document.getElementById('library-featured-container');

      if (!products || products.length === 0) {
        statsBar.style.display = 'none';
        featuredContainer.innerHTML = '';
        content.innerHTML = `
          <div class="library-empty">
            <div class="library-empty__icon">üì¶</div>
            <h2 class="library-empty__title">No tools yet</h2>
            <p class="library-empty__desc">
              Your purchased tools and resources will appear here.
              Browse the shop to find search query packs, automation tools, and more.
            </p>
            <a href="../index.html" class="library-empty__cta">
              Browse Tools &#8594;
            </a>
          </div>
        `;
        return;
      }

      // Show stats
      statsBar.style.display = 'grid';
      document.getElementById('stat-total').textContent = products.length;

      const now = new Date();
      const thisMonth = products.filter(p => {
        const d = p.purchaseDate ? new Date(p.purchaseDate) : null;
        return d && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });
      document.getElementById('stat-recent').textContent = thisMonth.length;

      // Count unique platforms
      const platforms = new Set(products.map(p => p.platform).filter(Boolean));
      document.getElementById('stat-platforms').textContent = platforms.size;

      // Render featured tool (most recently purchased)
      const sorted = [...products].sort((a, b) => {
        const da = a.purchaseDate ? new Date(a.purchaseDate) : 0;
        const db = b.purchaseDate ? new Date(b.purchaseDate) : 0;
        return db - da;
      });
      const featured = sorted[0];

      featuredContainer.innerHTML = `
        <div class="library-featured">
          <div class="library-featured__label">‚≠ê Latest Addition</div>
          <div class="library-featured__content">
            <div class="library-featured__icon">${featured.icon || 'üîß'}</div>
            <div class="library-featured__info">
              <h3>${featured.name || 'Untitled Tool'}</h3>
              <p>${featured.description || 'No description available.'}</p>
              <div class="library-featured__tags">
                ${(featured.tags || []).map(t => `<span class="library-featured__tag">${t}</span>`).join('')}
              </div>
            </div>
          </div>
        </div>
      `;

      // Render grid with section header
      content.innerHTML = `
        <div class="library-section-header">
          <h2>Your Tools</h2>
          <span class="count">${products.length} tool${products.length !== 1 ? 's' : ''}</span>
        </div>
        <div class="library-grid">
          ${products.map(product => `
            <div class="library-card">
              ${product.platform ? `<span class="library-card__platform">${PLATFORM_LABELS[product.platform] || product.platform}</span>` : ''}
              <div class="library-card__icon">${product.icon || 'üîß'}</div>
              <div class="library-card__name">${product.name || 'Untitled Tool'}</div>
              <div class="library-card__description">${product.description || 'No description available.'}</div>
              <div class="library-card__tags">
                ${(product.tags || []).map(t => `<span class="library-card__tag">${t}</span>`).join('')}
              </div>
              <span class="library-card__status">‚úì Owned</span>
              <div class="library-card__date">
                <span class="library-card__date-icon">üìÖ</span>
                Purchased ${formatDate(product.purchaseDate)}
              </div>
              <a href="${product.url || '#'}" class="library-card__open" target="_blank" rel="noopener">
                Open Tool &#8594;
              </a>
            </div>
          `).join('')}
        </div>
        <div class="library-browse-cta">
          <p>Looking for more tools to level up your sourcing game?</p>
          <a href="../index.html">Browse All Tools &#8594;</a>
        </div>
      `;

      // Animate cards in
      anime({
        targets: '.library-card',
        opacity: [0, 1],
        translateY: [20, 0],
        scale: [0.98, 1],
        delay: anime.stagger(100),
        easing: 'easeOutCubic',
        duration: 500
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown date';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return 'Unknown date';
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // =========================================================================
    // INIT
    // =========================================================================

    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('auth-loading');
      const dashboardContent = document.getElementById('dashboard-content');

      // Initialize Firebase
      if (!window.FirebaseApp.init()) {
        console.error('Firebase initialization failed');
        loadingScreen.innerHTML = '<div class="loading-content"><p>Error loading. Please refresh.</p></div>';
        return;
      }

      window.AuthService.init();

      // Wait for auth state
      const user = await window.AuthService.waitForAuthState();

      if (!user) {
        window.AuthService.setRedirectUrl(window.location.href);
        window.location.href = '../auth/login.html';
        return;
      }

      // User is logged in, show page
      loadingScreen.classList.add('hidden');
      dashboardContent.classList.add('ready');

      // Setup sidebar, user info, logout
      setupSidebar();
      setupLogout();
      loadUserInfo(user);

      // Check admin/basketball sections
      if (window.RBACService) {
        const isAdmin = await window.RBACService.hasRole('admin');
        if (isAdmin) document.getElementById('admin-section').style.display = 'block';
        const hasBasketball = isAdmin || await window.RBACService.belongsToOrganization('city-high-basketball');
        if (hasBasketball) document.getElementById('basketball-section').style.display = 'block';
      }

      // Load library from WhopService and normalize data
      let products = [];
      try {
        if (window.WhopService?.getLibrary) {
          const rawLibrary = await window.WhopService.getLibrary();
          products = rawLibrary.map(item => ({
            id: item.id,
            name: item.product?.name || item.name || 'Untitled Tool',
            description: item.product?.description || item.description || '',
            icon: item.product?.platformIcon || item.icon || 'üîß',
            platform: item.product?.platform || item.platform || '',
            tags: item.product?.tags || item.tags || [],
            price: item.product?.price || item.price || 0,
            url: item.url || '#',
            purchaseDate: item.purchasedAt || item.purchaseDate || null
          }));
        }
      } catch (e) {
        console.error('Error loading library:', e);
      }

      renderLibrary(products);

      // Listen for auth changes
      window.AuthService.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = '../auth/login.html';
        }
      });
    });

    function loadUserInfo(user) {
      const displayName = user.displayName || user.email.split('@')[0];
      document.getElementById('user-name').textContent = displayName;
      const avatar = document.getElementById('user-avatar');
      if (user.photoURL) {
        avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
      } else {
        avatar.textContent = displayName.charAt(0).toUpperCase();
      }
    }

    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      const overlay = document.getElementById('sidebar-overlay');
      const mobileBtn = document.getElementById('mobile-menu-btn');

      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });

      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }

      mobileBtn.addEventListener('click', () => { sidebar.classList.add('open'); });
      overlay.addEventListener('click', () => { sidebar.classList.remove('open'); });
    }

    function setupLogout() {
      document.getElementById('logout-link').addEventListener('click', async (e) => {
        e.preventDefault();
        await window.AuthService.logout();
        window.location.href = '../index.html';
      });
    }
  </script>
  <script src="../shared/js/i18n.js"></script>
</body>
</html>
