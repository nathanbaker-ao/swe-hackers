<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Achievements | AutoNateAI Learning Hub</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Critical styles -->
  <style>
    .dashboard { display: none !important; }
    .dashboard.ready { display: flex !important; }
    .auth-loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #0a0a0f;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .auth-loading.hidden { display: none; }
    .loading-content { text-align: center; color: #e8e8f0; }
    .loading-icon { font-size: 3rem; margin-bottom: 1rem; }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(121, 134, 203, 0.3);
      border-top-color: #7986cb;
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <!-- Theme loader (before CSS to prevent flash) -->
  <script src="../shared/js/theme-loader.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="../shared/css/dashboard.css">

  <style>
    /* Achievements Page Specific Styles */

    /* Stats Bar */
    .achievements-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }

    .achievements-stats::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-warning));
    }

    .stat-item {
      text-align: center;
      padding: 0.5rem;
    }

    .stat-item:not(:last-child) {
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-icon {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .stat-progress {
      margin-top: 0.5rem;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .stat-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* Filter Tabs */
    .achievements-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 0;
      flex-wrap: wrap;
    }

    .achievements-tab {
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }

    .achievements-tab:hover {
      color: var(--text-primary);
    }

    .achievements-tab.active {
      color: var(--accent-primary);
    }

    .achievements-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent-primary);
    }

    .tab-divider {
      width: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin: 0.5rem 0.5rem;
    }

    /* Featured Achievement */
    .featured-achievement {
      background: linear-gradient(135deg, var(--bg-card), var(--bg-tertiary));
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(121, 134, 203, 0.2);
      position: relative;
      overflow: hidden;
    }

    .featured-achievement::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(121, 134, 203, 0.1) 0%, transparent 70%);
      pointer-events: none;
    }

    .featured-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent-warning);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
    }

    .featured-content {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .featured-icon {
      width: 80px;
      height: 80px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      flex-shrink: 0;
      border: 2px solid rgba(121, 134, 203, 0.3);
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(121, 134, 203, 0.2); }
      50% { box-shadow: 0 0 30px rgba(121, 134, 203, 0.4); }
    }

    .featured-info {
      flex: 1;
    }

    .featured-info h3 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }

    .featured-info p {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    .featured-progress {
      margin-bottom: 0.75rem;
    }

    .featured-progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .featured-progress-header span:first-child {
      color: var(--text-secondary);
    }

    .featured-progress-header span:last-child {
      color: var(--accent-primary);
      font-weight: 600;
    }

    .featured-progress-bar {
      height: 8px;
      background: var(--bg-primary);
      border-radius: 4px;
      overflow: hidden;
    }

    .featured-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .featured-reward {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .featured-reward span {
      color: var(--accent-warning);
    }

    /* Achievements Grid */
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1.25rem;
    }

    /* Achievement Card */
    .achievement-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .achievement-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .achievement-card.unlocked {
      border-color: rgba(121, 134, 203, 0.3);
    }

    .achievement-card.unlocked::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }

    .achievement-card.locked {
      opacity: 0.7;
    }

    .achievement-card.locked .achievement-icon {
      filter: grayscale(0.8);
      opacity: 0.5;
    }

    .achievement-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      background: var(--bg-tertiary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      transition: all 0.3s ease;
    }

    .achievement-card.unlocked .achievement-icon {
      background: linear-gradient(135deg, rgba(121, 134, 203, 0.2), rgba(77, 182, 172, 0.2));
      box-shadow: 0 0 20px rgba(121, 134, 203, 0.3);
    }

    .achievement-name {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .achievement-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    .achievement-status {
      font-size: 0.8rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      display: inline-block;
    }

    .achievement-status.unlocked {
      background: rgba(102, 187, 106, 0.15);
      color: var(--accent-success);
    }

    .achievement-status.locked {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
    }

    .achievement-points {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      margin-top: 0.75rem;
      font-size: 0.85rem;
      color: var(--accent-warning);
      font-weight: 500;
    }

    .achievement-progress {
      margin-top: 1rem;
    }

    .achievement-progress-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .achievement-progress-bar {
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .achievement-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* Category Badges */
    .achievement-category {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      color: var(--text-primary);
      font-family: var(--font-display);
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      max-width: 400px;
      margin: 0 auto;
    }

    /* Rank Badge */
    .rank-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .achievements-stats {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .stat-item:not(:last-child) {
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding-bottom: 1rem;
      }

      .featured-content {
        flex-direction: column;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .achievements-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .achievements-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap;
      }

      .achievements-tab {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
        white-space: nowrap;
      }
    }

    @media (max-width: 480px) {
      .achievements-grid {
        grid-template-columns: 1fr;
      }

      .featured-icon {
        width: 64px;
        height: 64px;
        font-size: 2rem;
      }
    }

    /* New Achievement Animation */
    .achievement-card.newly-unlocked {
      animation: celebrate 0.6s ease-out;
    }

    @keyframes celebrate {
      0% { transform: scale(1); }
      25% { transform: scale(1.05); }
      50% { transform: scale(0.98); }
      100% { transform: scale(1); }
    }

    /* Section Header */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-header h2 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .section-header .count {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>

  <!-- Loading Screen -->
  <div class="auth-loading" id="auth-loading">
    <div class="loading-content">
      <div class="loading-icon">üèÜ</div>
      <div class="loading-spinner"></div>
      <p>Loading your achievements...</p>
    </div>
  </div>

  <div class="dashboard" id="dashboard-content">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="../index.html" class="sidebar-logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <span class="logo-text">AutoNateAI</span>
      </a>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">Main</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="index.html" class="nav-link">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">
                <span class="nav-icon">üìö</span>
                <span class="nav-text">Course Library</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="challenges.html" class="nav-link">
                <span class="nav-icon">‚ö°</span>
                <span class="nav-text">Daily Challenges</span>
                <span class="nav-badge">3</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Learning</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="progress.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">My Progress</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="achievements.html" class="nav-link active">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-text">Achievements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="notes.html" class="nav-link">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">Notes</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Community</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="feed.html" class="nav-link">
                <span class="nav-icon">üì∞</span>
                <span class="nav-text">Feed</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="https://discord.gg/Me5N8tCdkC" target="_blank" class="nav-link">
                <span class="nav-icon">üí¨</span>
                <span class="nav-text">Discord</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="leaderboard.html" class="nav-link">
                <span class="nav-icon">üèÖ</span>
                <span class="nav-text">Leaderboard</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">Account</span>
          <ul class="nav-list">
            <li class="nav-item">
              <a href="profile.html" class="nav-link">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Profile</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="settings.html" class="nav-link">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logout-link">
                <span class="nav-icon">üö™</span>
                <span class="nav-text">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="sidebar-user">
        <div class="user-card" id="user-card">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">Loading...</div>
            <div class="user-streak">
              <span>üî•</span>
              <span id="user-streak">0</span> day streak
            </div>
          </div>
        </div>
      </div>

      <button class="sidebar-toggle" id="sidebar-toggle">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </aside>

    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Header -->
      <header class="main-header">
        <div class="header-left">
          <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
          <h1 class="page-title">Achievements</h1>
        </div>
      </header>

      <!-- Content -->
      <div class="content-area">

        <!-- Stats Bar -->
        <div class="achievements-stats">
          <div class="stat-item">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-value" id="stat-unlocked">0 / 25</div>
            <div class="stat-label">Achievements Unlocked</div>
            <div class="stat-progress">
              <div class="stat-progress-fill" id="stat-progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-value" id="stat-points">0</div>
            <div class="stat-label">Total Points</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">üéñÔ∏è</div>
            <div class="stat-value">
              <span class="rank-badge" id="stat-rank">Newcomer</span>
            </div>
            <div class="stat-label">Current Rank</div>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="achievements-tabs">
          <button class="achievements-tab active" data-filter="all">All</button>
          <button class="achievements-tab" data-filter="unlocked">Unlocked</button>
          <button class="achievements-tab" data-filter="in-progress">In Progress</button>
          <button class="achievements-tab" data-filter="locked">Locked</button>
          <div class="tab-divider"></div>
          <button class="achievements-tab" data-category="learning">üìö Learning</button>
          <button class="achievements-tab" data-category="streaks">üî• Streaks</button>
          <button class="achievements-tab" data-category="community">üë• Community</button>
          <button class="achievements-tab" data-category="milestones">üéØ Milestones</button>
        </div>

        <!-- Featured Achievement -->
        <div class="featured-achievement" id="featured-achievement">
          <div class="featured-label">
            <span>‚ú®</span> Next Up
          </div>
          <div class="featured-content">
            <div class="featured-icon" id="featured-icon">üî•</div>
            <div class="featured-info">
              <h3 id="featured-name">Loading...</h3>
              <p id="featured-description">Finding your next achievement...</p>
              <div class="featured-progress">
                <div class="featured-progress-header">
                  <span id="featured-progress-text">Progress: 0/0</span>
                  <span id="featured-progress-percent">0%</span>
                </div>
                <div class="featured-progress-bar">
                  <div class="featured-progress-fill" id="featured-progress-fill" style="width: 0%"></div>
                </div>
              </div>
              <div class="featured-reward">
                üéÅ Reward: <span id="featured-reward">+0 points</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Achievements Grid -->
        <div class="section-header">
          <h2>All Achievements</h2>
          <span class="count" id="achievements-count">0 achievements</span>
        </div>

        <div class="achievements-grid" id="achievements-grid">
          <!-- Achievements loaded dynamically -->
        </div>

      </div>
    </main>

  </div>

  <!-- Scripts -->
  <script src="../shared/js/firebase-config.js"></script>
  <script src="../shared/js/auth.js"></script>
  <script src="../shared/js/data-service.js"></script>

  <script>
    // Achievement Definitions
    const ACHIEVEMENTS = {
      // Learning Achievements
      first_steps: {
        id: 'first_steps',
        name: 'First Steps',
        description: 'Complete your first lesson',
        icon: 'üéì',
        points: 50,
        category: 'learning',
        requirement: { type: 'lessons_completed', target: 1 }
      },
      bookworm: {
        id: 'bookworm',
        name: 'Bookworm',
        description: 'Complete 10 lessons',
        icon: 'üìñ',
        points: 150,
        category: 'learning',
        requirement: { type: 'lessons_completed', target: 10 }
      },
      scholar: {
        id: 'scholar',
        name: 'Scholar',
        description: 'Complete 25 lessons',
        icon: 'üèõÔ∏è',
        points: 300,
        category: 'learning',
        requirement: { type: 'lessons_completed', target: 25 }
      },
      chapter_master: {
        id: 'chapter_master',
        name: 'Chapter Master',
        description: 'Complete an entire chapter',
        icon: 'üéØ',
        points: 200,
        category: 'learning',
        requirement: { type: 'chapters_completed', target: 1 }
      },
      course_graduate: {
        id: 'course_graduate',
        name: 'Course Graduate',
        description: 'Complete an entire course',
        icon: 'üåü',
        points: 500,
        category: 'learning',
        requirement: { type: 'courses_completed', target: 1 }
      },
      stone_master: {
        id: 'stone_master',
        name: 'Stone Master',
        description: 'Complete all Stone Force lessons',
        icon: 'ü™®',
        points: 250,
        category: 'learning',
        requirement: { type: 'chapter_stone', target: 1 }
      },
      lightning_master: {
        id: 'lightning_master',
        name: 'Lightning Master',
        description: 'Complete all Lightning Force lessons',
        icon: '‚ö°',
        points: 250,
        category: 'learning',
        requirement: { type: 'chapter_lightning', target: 1 }
      },
      magnetism_master: {
        id: 'magnetism_master',
        name: 'Magnetism Master',
        description: 'Complete all Magnetism Force lessons',
        icon: 'üß≤',
        points: 250,
        category: 'learning',
        requirement: { type: 'chapter_magnetism', target: 1 }
      },

      // Streak Achievements
      getting_warm: {
        id: 'getting_warm',
        name: 'Getting Warm',
        description: 'Maintain a 3-day learning streak',
        icon: 'üî•',
        points: 75,
        category: 'streaks',
        requirement: { type: 'streak_days', target: 3 }
      },
      on_fire: {
        id: 'on_fire',
        name: 'On Fire',
        description: 'Maintain a 7-day learning streak',
        icon: 'üî•',
        points: 150,
        category: 'streaks',
        requirement: { type: 'streak_days', target: 7 }
      },
      unstoppable: {
        id: 'unstoppable',
        name: 'Unstoppable',
        description: 'Maintain a 14-day learning streak',
        icon: 'üî•',
        points: 300,
        category: 'streaks',
        requirement: { type: 'streak_days', target: 14 }
      },
      legendary: {
        id: 'legendary',
        name: 'Legendary',
        description: 'Maintain a 30-day learning streak',
        icon: 'üëë',
        points: 500,
        category: 'streaks',
        requirement: { type: 'streak_days', target: 30 }
      },
      early_bird: {
        id: 'early_bird',
        name: 'Early Bird',
        description: 'Complete a lesson before 9 AM',
        icon: '‚òÄÔ∏è',
        points: 50,
        category: 'streaks',
        requirement: { type: 'early_lesson', target: 1 }
      },
      night_owl: {
        id: 'night_owl',
        name: 'Night Owl',
        description: 'Complete a lesson after 10 PM',
        icon: 'üåô',
        points: 50,
        category: 'streaks',
        requirement: { type: 'late_lesson', target: 1 }
      },
      weekend_warrior: {
        id: 'weekend_warrior',
        name: 'Weekend Warrior',
        description: 'Learn on both Saturday and Sunday',
        icon: 'üìÖ',
        points: 100,
        category: 'streaks',
        requirement: { type: 'weekend_learning', target: 1 }
      },

      // Community Achievements
      welcome: {
        id: 'welcome',
        name: 'Welcome',
        description: 'Join the Discord community',
        icon: 'üëã',
        points: 25,
        category: 'community',
        requirement: { type: 'discord_joined', target: 1 }
      },
      note_taker: {
        id: 'note_taker',
        name: 'Note Taker',
        description: 'Create 5 study notes',
        icon: 'üìù',
        points: 75,
        category: 'community',
        requirement: { type: 'notes_created', target: 5 }
      },
      card_shark: {
        id: 'card_shark',
        name: 'Card Shark',
        description: 'Study 50 flashcards',
        icon: 'üÉè',
        points: 100,
        category: 'community',
        requirement: { type: 'flashcards_studied', target: 50 }
      },
      challenger: {
        id: 'challenger',
        name: 'Challenger',
        description: 'Complete 10 daily challenges',
        icon: '‚öîÔ∏è',
        points: 150,
        category: 'community',
        requirement: { type: 'challenges_completed', target: 10 }
      },

      // Milestone Achievements
      launch_day: {
        id: 'launch_day',
        name: 'Launch Day',
        description: 'Sign up and start your journey',
        icon: 'üöÄ',
        points: 25,
        category: 'milestones',
        requirement: { type: 'account_created', target: 1 }
      },
      time_invested: {
        id: 'time_invested',
        name: 'Time Invested',
        description: 'Spend 10 hours learning',
        icon: '‚è∞',
        points: 200,
        category: 'milestones',
        requirement: { type: 'hours_spent', target: 10 }
      },
      rising_star: {
        id: 'rising_star',
        name: 'Rising Star',
        description: 'Reach 500 total points',
        icon: 'üìà',
        points: 100,
        category: 'milestones',
        requirement: { type: 'total_points', target: 500 }
      },
      all_star: {
        id: 'all_star',
        name: 'All Star',
        description: 'Reach 2000 total points',
        icon: '‚≠ê',
        points: 250,
        category: 'milestones',
        requirement: { type: 'total_points', target: 2000 }
      },
      champion: {
        id: 'champion',
        name: 'Champion',
        description: 'Reach 5000 total points',
        icon: 'üèÜ',
        points: 500,
        category: 'milestones',
        requirement: { type: 'total_points', target: 5000 }
      }
    };

    // Rank definitions
    const RANKS = [
      { name: 'Newcomer', minPoints: 0, icon: 'üå±' },
      { name: 'Learner', minPoints: 100, icon: 'üìñ' },
      { name: 'Student', minPoints: 300, icon: 'üéì' },
      { name: 'Rising Star', minPoints: 750, icon: '‚≠ê' },
      { name: 'Scholar', minPoints: 1500, icon: 'üèõÔ∏è' },
      { name: 'Expert', minPoints: 3000, icon: 'üíé' },
      { name: 'Master', minPoints: 5000, icon: 'üëë' },
      { name: 'Legend', minPoints: 10000, icon: 'üèÜ' }
    ];

    // State
    let userAchievements = {
      unlocked: {},
      progress: {},
      totalPoints: 0
    };
    let currentFilter = 'all';
    let currentCategory = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      const loadingScreen = document.getElementById('auth-loading');
      const dashboardContent = document.getElementById('dashboard-content');

      if (!window.FirebaseApp.init()) {
        console.error('Firebase initialization failed');
        return;
      }

      window.AuthService.init();

      const user = await window.AuthService.waitForAuthState();

      if (!user) {
        window.AuthService.setRedirectUrl(window.location.href);
        window.location.href = '../auth/login.html';
        return;
      }

      loadingScreen.classList.add('hidden');
      dashboardContent.classList.add('ready');

      loadUserInfo(user);
      await loadUserAchievements();
      await calculateProgress();
      renderStats();
      renderFeaturedAchievement();
      renderAchievements();

      setupTabs();
      setupSidebar();
      setupLogout();
    });

    // Load user info
    function loadUserInfo(user) {
      const displayName = user.displayName || user.email.split('@')[0];
      document.getElementById('user-name').textContent = displayName;

      const avatar = document.getElementById('user-avatar');
      if (user.photoURL) {
        avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar" style="width:100%;height:100%;border-radius:50%;">`;
      } else {
        avatar.textContent = displayName.charAt(0).toUpperCase();
      }
    }

    // Load user achievements from Firebase
    async function loadUserAchievements() {
      const user = window.AuthService.getUser();
      if (!user) return;

      const db = window.FirebaseApp.getDb();

      try {
        const doc = await db.collection('users').doc(user.uid)
          .collection('gamification').doc('achievements').get();

        if (doc.exists) {
          const data = doc.data();
          userAchievements.unlocked = data.unlocked || {};
          userAchievements.progress = data.progress || {};
          userAchievements.totalPoints = data.totalPoints || 0;
        }

        // Always grant "Launch Day" achievement if not already unlocked
        if (!userAchievements.unlocked.launch_day) {
          await unlockAchievement('launch_day');
        }

      } catch (error) {
        console.error('Error loading achievements:', error);
      }
    }

    // Calculate progress based on user activity
    async function calculateProgress() {
      const user = window.AuthService.getUser();
      if (!user) return;

      try {
        // Get enrolled courses and lesson progress
        const courses = await window.DataService.getEnrolledCourses();

        let totalLessonsCompleted = 0;
        let chaptersCompleted = 0;
        let coursesCompleted = 0;

        courses.forEach(course => {
          const lessons = course.lessons || {};
          const completedLessons = Object.values(lessons).filter(l => l.completed).length;
          totalLessonsCompleted += completedLessons;

          // Check if chapters are completed (simplified - assumes 6 lessons per chapter)
          if (completedLessons >= 6) chaptersCompleted++;
          if (course.progressPercent >= 100) coursesCompleted++;
        });

        // Update progress for relevant achievements
        userAchievements.progress.lessons_completed = totalLessonsCompleted;
        userAchievements.progress.chapters_completed = chaptersCompleted;
        userAchievements.progress.courses_completed = coursesCompleted;

        // Get user stats for streak
        const db = window.FirebaseApp.getDb();
        const statsDoc = await db.collection('users').doc(user.uid)
          .collection('stats').doc('current').get();

        if (statsDoc.exists) {
          const stats = statsDoc.data();
          userAchievements.progress.streak_days = stats.currentStreak || 0;
          document.getElementById('user-streak').textContent = stats.currentStreak || 0;
        }

        // Get notes count
        const notesSnapshot = await db.collection('users').doc(user.uid)
          .collection('notes').get();
        userAchievements.progress.notes_created = notesSnapshot.size;

        // Check and unlock achievements based on progress
        await checkAndUnlockAchievements();

      } catch (error) {
        console.error('Error calculating progress:', error);
      }
    }

    // Check and unlock achievements based on progress
    async function checkAndUnlockAchievements() {
      const progress = userAchievements.progress;

      for (const [id, achievement] of Object.entries(ACHIEVEMENTS)) {
        if (userAchievements.unlocked[id]) continue; // Already unlocked

        const req = achievement.requirement;
        const current = progress[req.type] || 0;

        if (current >= req.target) {
          await unlockAchievement(id);
        }
      }
    }

    // Unlock an achievement
    async function unlockAchievement(achievementId) {
      const achievement = ACHIEVEMENTS[achievementId];
      if (!achievement || userAchievements.unlocked[achievementId]) return;

      const user = window.AuthService.getUser();
      if (!user) return;

      const db = window.FirebaseApp.getDb();

      userAchievements.unlocked[achievementId] = {
        unlockedAt: new Date(),
        pointsAwarded: achievement.points
      };
      userAchievements.totalPoints += achievement.points;

      try {
        await db.collection('users').doc(user.uid)
          .collection('gamification').doc('achievements').set({
            unlocked: userAchievements.unlocked,
            progress: userAchievements.progress,
            totalPoints: userAchievements.totalPoints
          }, { merge: true });

      } catch (error) {
        console.error('Error unlocking achievement:', error);
      }
    }

    // Get current rank based on points
    function getCurrentRank(points) {
      let currentRank = RANKS[0];
      for (const rank of RANKS) {
        if (points >= rank.minPoints) {
          currentRank = rank;
        }
      }
      return currentRank;
    }

    // Render stats bar
    function renderStats() {
      const totalAchievements = Object.keys(ACHIEVEMENTS).length;
      const unlockedCount = Object.keys(userAchievements.unlocked).length;
      const percentage = Math.round((unlockedCount / totalAchievements) * 100);

      document.getElementById('stat-unlocked').textContent = `${unlockedCount} / ${totalAchievements}`;
      document.getElementById('stat-progress-fill').style.width = `${percentage}%`;

      // Animate points
      const pointsEl = document.getElementById('stat-points');
      anime({
        targets: { val: 0 },
        val: userAchievements.totalPoints,
        duration: 1000,
        easing: 'easeOutExpo',
        update: (anim) => {
          pointsEl.textContent = Math.round(anim.animations[0].currentValue).toLocaleString();
        }
      });

      // Set rank
      const rank = getCurrentRank(userAchievements.totalPoints);
      document.getElementById('stat-rank').textContent = `${rank.icon} ${rank.name}`;
    }

    // Render featured achievement (next closest to unlock)
    function renderFeaturedAchievement() {
      let bestCandidate = null;
      let bestProgress = -1;

      for (const [id, achievement] of Object.entries(ACHIEVEMENTS)) {
        if (userAchievements.unlocked[id]) continue;

        const req = achievement.requirement;
        const current = userAchievements.progress[req.type] || 0;
        const progress = current / req.target;

        if (progress > bestProgress && progress < 1) {
          bestProgress = progress;
          bestCandidate = { ...achievement, current, progress };
        }
      }

      const container = document.getElementById('featured-achievement');

      if (!bestCandidate) {
        // All achievements unlocked or none in progress
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      document.getElementById('featured-icon').textContent = bestCandidate.icon;
      document.getElementById('featured-name').textContent = bestCandidate.name;
      document.getElementById('featured-description').textContent = bestCandidate.description;
      document.getElementById('featured-progress-text').textContent =
        `Progress: ${bestCandidate.current}/${bestCandidate.requirement.target}`;
      document.getElementById('featured-progress-percent').textContent =
        `${Math.round(bestCandidate.progress * 100)}%`;
      document.getElementById('featured-progress-fill').style.width =
        `${bestCandidate.progress * 100}%`;
      document.getElementById('featured-reward').textContent = `+${bestCandidate.points} points`;
    }

    // Render achievements grid
    function renderAchievements() {
      const grid = document.getElementById('achievements-grid');
      grid.innerHTML = '';

      let achievementsList = Object.values(ACHIEVEMENTS);

      // Apply category filter
      if (currentCategory) {
        achievementsList = achievementsList.filter(a => a.category === currentCategory);
      }

      // Apply status filter
      if (currentFilter === 'unlocked') {
        achievementsList = achievementsList.filter(a => userAchievements.unlocked[a.id]);
      } else if (currentFilter === 'locked') {
        achievementsList = achievementsList.filter(a => !userAchievements.unlocked[a.id]);
      } else if (currentFilter === 'in-progress') {
        achievementsList = achievementsList.filter(a => {
          if (userAchievements.unlocked[a.id]) return false;
          const current = userAchievements.progress[a.requirement.type] || 0;
          return current > 0 && current < a.requirement.target;
        });
      }

      // Update count
      document.getElementById('achievements-count').textContent =
        `${achievementsList.length} achievement${achievementsList.length !== 1 ? 's' : ''}`;

      if (achievementsList.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="icon">üîç</div>
            <h3>No achievements found</h3>
            <p>Try adjusting your filters to see more achievements.</p>
          </div>
        `;
        return;
      }

      achievementsList.forEach((achievement, index) => {
        const isUnlocked = !!userAchievements.unlocked[achievement.id];
        const current = userAchievements.progress[achievement.requirement.type] || 0;
        const progress = Math.min(current / achievement.requirement.target, 1);

        const card = document.createElement('div');
        card.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
        card.style.animationDelay = `${index * 0.05}s`;

        let statusHtml = '';
        if (isUnlocked) {
          const unlockedData = userAchievements.unlocked[achievement.id];
          const date = unlockedData.unlockedAt?.toDate ?
            unlockedData.unlockedAt.toDate() : new Date(unlockedData.unlockedAt);
          statusHtml = `
            <div class="achievement-status unlocked">
              ‚úì Unlocked ${formatDate(date)}
            </div>
          `;
        } else if (progress > 0) {
          statusHtml = `
            <div class="achievement-progress">
              <div class="achievement-progress-text">${current} / ${achievement.requirement.target}</div>
              <div class="achievement-progress-bar">
                <div class="achievement-progress-fill" style="width: ${progress * 100}%"></div>
              </div>
            </div>
          `;
        } else {
          statusHtml = `
            <div class="achievement-status locked">üîí Locked</div>
          `;
        }

        card.innerHTML = `
          <span class="achievement-category">${achievement.category}</span>
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-name">${achievement.name}</div>
          <div class="achievement-description">${achievement.description}</div>
          ${statusHtml}
          <div class="achievement-points">‚≠ê ${achievement.points} points</div>
        `;

        grid.appendChild(card);
      });

      // Animate cards in
      anime({
        targets: '.achievement-card',
        opacity: [0, 1],
        translateY: [20, 0],
        delay: anime.stagger(50),
        duration: 400,
        easing: 'easeOutCubic'
      });
    }

    // Setup filter tabs
    function setupTabs() {
      const tabs = document.querySelectorAll('.achievements-tab');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Handle status filters
          if (tab.dataset.filter) {
            document.querySelectorAll('.achievements-tab[data-filter]').forEach(t =>
              t.classList.remove('active'));
            tab.classList.add('active');
            currentFilter = tab.dataset.filter;
            currentCategory = null;
            document.querySelectorAll('.achievements-tab[data-category]').forEach(t =>
              t.classList.remove('active'));
          }

          // Handle category filters
          if (tab.dataset.category) {
            document.querySelectorAll('.achievements-tab[data-category]').forEach(t =>
              t.classList.remove('active'));
            tab.classList.add('active');
            currentCategory = tab.dataset.category;
            currentFilter = 'all';
            document.querySelectorAll('.achievements-tab[data-filter]').forEach(t =>
              t.classList.remove('active'));
            document.querySelector('.achievements-tab[data-filter="all"]').classList.add('active');
          }

          renderAchievements();
        });
      });
    }

    // Format date
    function formatDate(date) {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Setup sidebar
    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      const overlay = document.getElementById('sidebar-overlay');
      const mobileBtn = document.getElementById('mobile-menu-btn');

      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });

      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }

      mobileBtn.addEventListener('click', () => {
        sidebar.classList.add('open');
      });

      overlay.addEventListener('click', () => {
        sidebar.classList.remove('open');
      });
    }

    // Setup logout
    function setupLogout() {
      document.getElementById('logout-link').addEventListener('click', async (e) => {
        e.preventDefault();
        await window.AuthService.logout();
        window.location.href = '../index.html';
      });
    }
  </script>
</body>
</html>
